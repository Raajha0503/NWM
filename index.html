<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Barclays Network Management Portal</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <link rel="icon" type="image/svg+xml" href="https://www.barclays.co.uk/content/dam/icons/favicons/barclays/Eagle_RGB_Cyan_Large.svg">
  <style>
    :root {
      --barclays-blue: #00AEEF;
      --barclays-blue-dark: #0077A3;
      --barclays-blue-light: #1A222B;
      --barclays-cyan: #00C1D5;
      --barclays-bg: #10151A;
      --barclays-surface: #1A222B;
      --barclays-text: #E6F6FB;
      --barclays-muted: #A8D4E0;
      --barclays-muted-light: #B8DCE6;
      --barclays-red: #ff6b6b;
      --barclays-yellow: #ffe066;
      --barclays-green: #22c55e;
    }
    body {
      background: var(--barclays-bg) !important;
      color: var(--barclays-text) !important;
      transition: background 0.5s, color 0.5s;
    }
    .active-tab {
      background-color: var(--barclays-blue) !important;
      color: #fff !important;
      box-shadow: 0 2px 8px 0 rgba(0,174,239,0.10);
      border: 2px solid var(--barclays-blue-dark);
      z-index: 1;
      position: relative;
      border-bottom: 4px solid var(--barclays-yellow) !important;
      transition: background 0.2s, color 0.2s, border-bottom 0.3s cubic-bezier(0.4,0,0.2,1);
    }
    .active-tab .tab-icon {
      display: inline-block;
      margin-right: 8px;
      vertical-align: middle;
      opacity: 1;
      transform: scale(1.1);
      transition: transform 0.2s ease, opacity 0.2s;
    }
    .inactive-tab .tab-icon {
      display: none;
      opacity: 0;
      transform: scale(0.8);
    }
    .inactive-tab {
      background-color: var(--barclays-surface) !important;
      color: var(--barclays-muted) !important;
      border: 2px solid transparent;
      z-index: 0;
      transition: background 0.2s, color 0.2s, border-bottom 0.3s cubic-bezier(0.4,0,0.2,1);
    }
    .inactive-tab:hover {
      background-color: #232c36 !important;
      color: #fff !important;
      cursor: pointer;
    }
    .barclays-header {
      background: var(--barclays-surface);
      color: var(--barclays-text);
      border-bottom: 1px solid var(--barclays-blue-dark);
      transition: background 0.5s, color 0.5s, border-color 0.5s, box-shadow 0.5s;
    }
    .barclays-btn {
      background: var(--barclays-blue);
      color: #fff;
    }
    .barclays-btn:hover {
      background: var(--barclays-blue-dark);
    }
    /* Secondary button for consistent neutral actions */
    .barclays-secondary-btn {
      background: #232c36;
      color: #E6F6FB;
      border: 1px solid #2A3A4D;
      transition: background 0.2s, color 0.2s;
    }
    .barclays-secondary-btn:hover {
      background: #2A3A4D;
      color: #fff;
    }
    .barclays-logo {
      height: 40px;
      margin-right: 12px;
      display: inline-block;
      vertical-align: middle;
      background: transparent;
    }
    /* Barclays icon utility class for consistent SVG icon styling */
    .barclays-icon {
      width: 1.25rem; /* 20px */
      height: 1.25rem; /* 20px */
      display: inline-block;
      vertical-align: middle;
      stroke: currentColor;
      fill: none;
    }
    .barclays-icon-lg {
      width: 2.5rem; /* 40px */
      height: 2.5rem; /* 40px */
    }
    
    /* Table Enhancements - Sticky Headers */
    .table-container {
      position: relative;
      max-height: 70vh;
      overflow-y: auto;
      border: 1px solid #374151;
      border-radius: 0.5rem;
    }
    
    .table-container table {
      width: 100%;
      border-collapse: collapse;
    }
    
    .table-container thead {
      position: sticky;
      top: 0;
      z-index: 10;
      background: var(--barclays-surface);
      border-bottom: 2px solid var(--barclays-blue-dark);
    }
    
    .table-container thead th {
      background: var(--barclays-surface);
      color: var(--barclays-text);
      font-weight: 700;
      padding: 12px;
      text-align: left;
      border: 1px solid #374151;
      position: relative;
      cursor: pointer;
      transition: background-color 0.2s ease;
      letter-spacing: 0.025em;
      text-transform: uppercase;
      font-size: 0.8rem;
    }
    
    .table-container thead th:hover {
      background: #232c36;
    }
    
    .table-container thead th.sortable {
      cursor: pointer;
      user-select: none;
    }
    
    .table-container thead th.sortable::after {
      content: '↕';
      position: absolute;
      right: 8px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 12px;
      opacity: 0.5;
      transition: opacity 0.2s ease;
    }
    
    .table-container thead th.sortable:hover::after {
      opacity: 1;
    }
    
    .table-container thead th.sort-asc::after {
      content: '↑';
      opacity: 1;
      color: var(--barclays-blue);
    }
    
    .table-container thead th.sort-desc::after {
      content: '↓';
      opacity: 1;
      color: var(--barclays-blue);
    }
    
    .table-container tbody tr {
      background: var(--barclays-bg);
      transition: background-color 0.2s ease;
    }
    
    .table-container tbody tr:hover {
      background: #1f2937;
    }
    
    .table-container tbody td {
      padding: 12px;
      border: 1px solid #374151;
      color: var(--barclays-text);
    }
    
    /* Filter Controls */
    .table-filters {
      background: var(--barclays-surface);
      padding: 16px;
      border-radius: 0.5rem 0.5rem 0 0;
      border-bottom: 1px solid #374151;
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: center;
    }
    
    .filter-group {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .filter-group label {
      color: var(--barclays-text);
      font-size: 14px;
      font-weight: 500;
    }
    
    .filter-group input,
    .filter-group select {
      background: var(--barclays-bg);
      border: 1px solid #374151;
      color: var(--barclays-text);
      padding: 6px 12px;
      border-radius: 4px;
      font-size: 14px;
    }
    
    .filter-group input:focus,
    .filter-group select:focus {
      outline: none;
      border-color: var(--barclays-blue);
      box-shadow: 0 0 0 2px rgba(0, 174, 239, 0.2);
    }
    
    .clear-filters-btn {
      background: #dc2626;
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 4px;
      font-size: 14px;
      cursor: pointer;
      transition: background-color 0.2s ease;
    }
    
    .clear-filters-btn:hover {
      background: #b91c1c;
    }
    
    /* Table Status Indicators */
    .status-badge {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .status-active {
      background: linear-gradient(135deg, rgba(34, 197, 94, 0.15), rgba(34, 197, 94, 0.08));
      color: #16a34a !important;
      border: 1px solid rgba(34, 197, 94, 0.3);
      font-weight: 700;
      text-shadow: none;
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 0.85rem;
      letter-spacing: 0.025em;
    }
    
    .status-inactive {
      background: linear-gradient(135deg, rgba(239, 68, 68, 0.15), rgba(239, 68, 68, 0.08));
      color: #dc2626 !important;
      border: 1px solid rgba(239, 68, 68, 0.3);
      font-weight: 700;
      text-shadow: none;
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 0.85rem;
      letter-spacing: 0.025em;
    }
    
    .status-pending {
      background: linear-gradient(135deg, rgba(245, 158, 11, 0.15), rgba(245, 158, 11, 0.08));
      color: #d97706 !important;
      border: 1px solid rgba(245, 158, 11, 0.3);
      font-weight: 700;
      text-shadow: none;
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 0.85rem;
      letter-spacing: 0.025em;
    }
    
    .status-closed {
      background: linear-gradient(135deg, rgba(107, 114, 128, 0.15), rgba(107, 114, 128, 0.08));
      color: #6b7280 !important;
      border: 1px solid rgba(107, 114, 128, 0.3);
      font-weight: 700;
      text-shadow: none;
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 0.85rem;
      letter-spacing: 0.025em;
    }
    /* Enhanced Splash screen styles */
    #splashScreen {
      position: fixed;
      z-index: 9999;
      top: 0; left: 0; right: 0; bottom: 0;
      width: 100vw; height: 100vh;
      background: linear-gradient(135deg, var(--barclays-blue-dark) 0%, #001a2c 50%, var(--barclays-blue-dark) 100%);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      transition: all 1.2s cubic-bezier(0.25, 0.46, 0.45, 0.94);
      opacity: 1;
      pointer-events: all;
      overflow: hidden;
    }
    
    #splashScreen::before {
      content: '';
      position: absolute;
      top: 0; left: 0; right: 0; bottom: 0;
      background: radial-gradient(circle at 50% 50%, rgba(0, 174, 239, 0.1) 0%, transparent 70%);
      animation: pulse 3s ease-in-out infinite;
    }
    
    #splashScreen.fade-out {
      opacity: 0;
      transform: scale(1.05) rotate(1deg);
      pointer-events: none;
    }
    
    #splashScreen .barclays-logo {
      height: 120px;
      margin-bottom: 32px;
      background: transparent;
      box-shadow: none;
      border-radius: 0;
      animation: logoFloat 2s ease-in-out infinite, logoGlow 3s ease-in-out infinite;
      filter: drop-shadow(0 0 20px rgba(0, 174, 239, 0.3));
      z-index: 2;
      position: relative;
      transition: opacity 1s ease-out, transform 1s ease-out, filter 1s ease-out;
    }
    
    #splashScreen.fade-out .barclays-logo {
      opacity: 0;
      transform: translateY(-30px) scale(0.9);
      filter: drop-shadow(0 0 10px rgba(0, 174, 239, 0.1));
    }
    
    #splashScreen .welcome-text {
      color: #fff;
      font-size: 1.6rem;
      font-weight: 400;
      letter-spacing: 0.08em;
      text-align: center;
      animation: textSlideIn 1.5s ease-out 0.5s both, textGlow 2s ease-in-out infinite 1.5s;
      text-shadow: 0 0 10px rgba(255, 255, 255, 0.3);
      z-index: 2;
      position: relative;
      transition: opacity 0.8s ease-out, transform 0.8s ease-out;
    }
    
    #splashScreen.fade-out .welcome-text {
      opacity: 0;
      transform: translateY(-20px) scale(0.95);
    }
    
    #splashScreen .loading-dots {
      display: flex;
      gap: 8px;
      margin-top: 24px;
      z-index: 2;
      position: relative;
      transition: opacity 0.6s ease-out;
    }
    
    #splashScreen.fade-out .loading-dots {
      opacity: 0;
      transform: scale(0.8);
    }
    
    #splashScreen .loading-dots .dot {
      width: 8px;
      height: 8px;
      background: #00C1D5;
      border-radius: 50%;
      animation: dotBounce 1.4s ease-in-out infinite;
    }
    
    #splashScreen .loading-dots .dot:nth-child(1) { animation-delay: 0s; }
    #splashScreen .loading-dots .dot:nth-child(2) { animation-delay: 0.2s; }
    #splashScreen .loading-dots .dot:nth-child(3) { animation-delay: 0.4s; }
    
    /* Splash screen animations */
    @keyframes logoFloat {
      0%, 100% { transform: translateY(0px); }
      50% { transform: translateY(-10px); }
    }
    
    @keyframes logoGlow {
      0%, 100% { filter: drop-shadow(0 0 20px rgba(0, 174, 239, 0.3)); }
      50% { filter: drop-shadow(0 0 30px rgba(0, 174, 239, 0.6)); }
    }
    
    @keyframes textSlideIn {
      from {
        opacity: 0;
        transform: translateY(30px) scale(0.9);
      }
      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }
    
    @keyframes textGlow {
      0%, 100% { text-shadow: 0 0 10px rgba(255, 255, 255, 0.3); }
      50% { text-shadow: 0 0 20px rgba(255, 255, 255, 0.6); }
    }
    
    @keyframes dotBounce {
      0%, 80%, 100% {
        transform: scale(0.8);
        opacity: 0.5;
      }
      40% {
        transform: scale(1.2);
        opacity: 1;
      }
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 0.3; }
      50% { opacity: 0.6; }
    }
    .toast {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background-color: var(--barclays-blue-dark);
      color: #fff;
      padding: 12px 20px;
      border-radius: 8px;
      font-size: 0.95rem;
      font-weight: 500;
      box-shadow: 0 4px 12px rgba(0,0,0,0.25);
      z-index: 1000;
      display: flex;
      align-items: center;
      gap: 12px;
      min-width: 220px;
      max-width: 350px;
      opacity: 0;
      pointer-events: none;
      transform: translateX(120%) scale(0.98);
      transition: transform 0.45s cubic-bezier(0.4,0,0.2,1), opacity 0.35s cubic-bezier(0.4,0,0.2,1);
      letter-spacing: 0.025em;
    }
    .toast.show {
      opacity: 1;
      pointer-events: auto;
      transform: translateX(0) scale(1);
    }
    .toast.success { background-color: #22c55e; color: #fff; }
    .toast.error { background-color: #ff6b6b; color: #fff; }
    .toast.info { background-color: var(--barclays-blue-dark); color: #fff; }
    .toast .toast-icon {
      font-size: 1.5em;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-right: 8px;
      flex-shrink: 0;
      filter: drop-shadow(0 1px 2px rgba(0,0,0,0.10));
    }
    .toast.success .toast-icon { color: #fff; }
    .toast.error .toast-icon { color: #fff; }
    .toast.info .toast-icon { color: #fff; }
    .loading {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid rgba(0, 174, 239, 0.2);
      border-top: 2px solid #00AEEF;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      opacity: 0;
      transition: opacity 0.2s ease-in-out;
      margin-left: 8px;
    }
    .loading.visible {
      opacity: 1;
    }
    
    /* Enhanced button loading states */
    .barclays-btn:disabled,
    .barclays-secondary-btn:disabled {
      opacity: 0.75;
      cursor: not-allowed;
      pointer-events: none;
    }
    
    .barclays-btn:disabled .loading,
    .barclays-secondary-btn:disabled .loading {
      opacity: 1;
    }
    
    /* Loading state for buttons with text changes */
    .btn-loading {
      position: relative;
      pointer-events: none;
    }
    
    .btn-loading .btn-text {
      opacity: 0.7;
    }
    
    .btn-loading .loading {
      opacity: 1;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .fade-in {
      animation: fadeIn 0.3s ease-in;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .connection-status {
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 600;
      background: var(--barclays-surface);
      color: var(--barclays-cyan);
      border: 1px solid var(--barclays-blue);
      transition: background 0.5s, color 0.5s, border-color 0.5s, box-shadow 0.5s;
      letter-spacing: 0.025em;
    }
    .connection-online {
      background-color: #003e4d;
      color: #00C1D5;
    }
    body.light-mode .connection-status.connection-online {
      background-color: #E6F6FB !important;
      color: #0077A3 !important;
      border: 1.5px solid #00AEEF !important;
      box-shadow: 0 1px 4px 0 #00AEEF11;
    }
    .connection-offline {
      background-color: #2d1a1a;
      color: #ff6b6b;
    }
    .barclays-logo.splash-logo {
      height: 180px;
      margin-bottom: 24px;
      background: transparent;
      box-shadow: none;
      border-radius: 0;
    }
    .barclays-logo.header-logo {
      height: 70px;
      margin-right: 18px;
      background: transparent;
      box-shadow: none;
      border-radius: 0;
      padding: 0;
    }
    /* Dark mode overrides for Tailwind utility classes */
    .bg-white, .bg-blue-100, .bg-gray-100, .bg-gray-50, .bg-green-50, .bg-purple-50, .bg-yellow-50 {
      background-color: var(--barclays-surface) !important;
    }
    .text-gray-800, .text-gray-700, .text-gray-600, .text-blue-600, .text-blue-800, .text-green-800, .text-purple-800, .text-yellow-800, .text-green-600, .text-purple-600, .text-yellow-600, .text-gray-500 {
      color: var(--barclays-text) !important;
    }
    .border-gray-300, .border-gray-200 {
      border-color: #2A3A4D !important;
    }
    .bg-blue-100 {
      background-color: #003e4d !important;
    }
    .hover\:bg-gray-50:hover {
      background-color: #232c36 !important;
    }
    .file\:bg-blue-50, .hover\:file\:bg-blue-100:hover {
      background-color: #003e4d !important;
    }
    .file\:text-blue-700 {
      color: #00C1D5 !important;
    }
    .bg-gray-50 {
      background-color: #232c36 !important;
    }
    .bg-gray-100 {
      background-color: #1A222B !important;
    }
    .text-blue-600, .hover\:text-blue-800:hover {
      color: #00C1D5 !important;
    }
    .bg-green-100, .bg-purple-100 {
      background-color: #003e4d !important;
    }
    .text-green-800, .text-purple-800 {
      color: #00C1D5 !important;
    }
    .bg-red-600 {
      background-color: #ff6b6b !important;
    }
    .hover\:bg-red-700:hover {
      background-color: #c0392b !important;
    }
    .bg-blue-100, .hover\:bg-blue-100:hover {
      background-color: #003e4d !important;
    }
    .bg-gray-300, .hover\:bg-gray-400:hover {
      background-color: #232c36 !important;
    }
    .text-gray-700 {
      color: #E6F6FB !important;
    }
    .border {
      border-color: #2A3A4D !important;
    }
    input, select, textarea {
      background: #232c36 !important;
      color: #E6F6FB !important;
      border-color: #2A3A4D !important;
    }
    input:focus, select:focus, textarea:focus {
      outline: none !important;
      border-color: #00AEEF !important;
      box-shadow: 0 0 0 2px #00AEEF33 !important;
    }
    .bg-barclays-surface {
      background-color: var(--barclays-surface) !important;
    }
    .border-green-500 {
      border-color: #22c55e !important;
    }
    .border-red-500 {
      border-color: #ef4444 !important;
    }
    /* Custom text color classes for Barclays scheme */
    .text-primary { color: var(--barclays-text) !important; }
    .text-muted { color: var(--barclays-muted) !important; }
    .text-header { color: var(--barclays-text) !important; font-weight: bold; }
    
    /* Form validation styles */
    .form-group {
      margin-bottom: 1.5rem;
    }
    
    .form-section {
      background: rgba(0, 174, 239, 0.05);
      border: 1px solid rgba(0, 174, 239, 0.2);
      border-radius: 12px;
      padding: 1.5rem;
      margin-bottom: 2rem;
    }
    
    .form-section-title {
      color: var(--barclays-blue);
      font-weight: 600;
      font-size: 1.1rem;
      margin-bottom: 1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .form-section-title::before {
      content: '';
      width: 4px;
      height: 20px;
      background: var(--barclays-blue);
      border-radius: 2px;
    }
    
    .field-wrapper {
      position: relative;
    }
    
    .error-message {
      color: var(--barclays-red);
      font-size: 0.875rem;
      margin-top: 0.25rem;
      display: flex;
      align-items: center;
      gap: 0.25rem;
      opacity: 0;
      transform: translateY(-5px);
      transition: opacity 0.3s ease, transform 0.3s ease;
    }
    
    .error-message.show {
      opacity: 1;
      transform: translateY(0);
    }
    
    .error-message::before {
      content: '⚠️';
      font-size: 0.75rem;
    }
    
    .success-message {
      color: var(--barclays-green);
      font-size: 0.875rem;
      margin-top: 0.25rem;
      display: flex;
      align-items: center;
      gap: 0.25rem;
      opacity: 0;
      transform: translateY(-5px);
      transition: opacity 0.3s ease, transform 0.3s ease;
    }
    
    .success-message.show {
      opacity: 1;
      transform: translateY(0);
    }
    
    .success-message::before {
      content: '✅';
      font-size: 0.75rem;
    }
    
    .field-hint {
      color: var(--barclays-muted);
      font-size: 0.75rem;
      margin-top: 0.25rem;
      font-style: italic;
    }
    /* Enhanced Barclays-styled reconciliation diff table */
    #reconciliationDiffTable {
      background: var(--barclays-surface);
      color: var(--barclays-text);
      border-radius: 12px;
      overflow: hidden;
      border: 1px solid var(--barclays-blue-dark);
      box-shadow: 0 4px 12px rgba(0, 174, 239, 0.1);
    }
    #reconciliationDiffTable th {
      background: var(--barclays-blue-dark);
      color: #fff;
      font-weight: bold;
      border: 1px solid var(--barclays-blue);
      padding: 12px 8px;
      text-align: center;
      position: relative;
    }
    #reconciliationDiffTable th:first-child {
      text-align: left;
    }
    #reconciliationDiffTable td {
      background: var(--barclays-surface);
      color: var(--barclays-text);
      border: 1px solid #2A3A4D;
      padding: 10px 8px;
      text-align: center;
      position: relative;
    }
    #reconciliationDiffTable td:first-child {
      text-align: left;
      font-weight: 600;
    }
    
    /* Enhanced Modal Styling for Better Table Display */
    #mismatchesModal .rounded-xl {
      background: var(--barclays-surface) !important;
      border: 2px solid var(--barclays-blue-dark);
      box-shadow: 0 25px 50px -12px rgba(0, 174, 239, 0.25);
    }
    
    /* Enhanced Table Styling for Batch Mismatches Modal */
    #mismatchesModal table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      margin-top: 1rem;
    }
    #mismatchesModal thead {
      background: linear-gradient(135deg, var(--barclays-blue-dark) 0%, var(--barclays-blue) 100%);
      position: sticky;
      top: 0;
      z-index: 10;
    }
    
    #mismatchesModal thead th {
      background: transparent;
      color: #ffffff !important;
      font-weight: 700;
      font-size: 0.95rem;
      padding: 16px 12px;
      text-align: center;
      border: none;
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
    }
    
    #mismatchesModal thead th:first-child {
      text-align: left;
      border-top-left-radius: 8px;
    }
    
    #mismatchesModal thead th:last-child {
      border-top-right-radius: 8px;
    }
    
    #mismatchesModal tbody tr {
      background: var(--barclays-surface);
      transition: all 0.2s ease;
      border-bottom: 1px solid rgba(0, 174, 239, 0.08);
    }
    
    #mismatchesModal tbody tr:hover {
      background: rgba(0, 174, 239, 0.04);
      transform: scale(1.001);
    }
    
    #mismatchesModal tbody tr:last-child {
      border-bottom: none;
    }
    
    #mismatchesModal tbody td {
      background: transparent;
      color: var(--barclays-text);
      padding: 14px 12px;
      text-align: center;
      border: none;
      font-size: 0.9rem;
      line-height: 1.4;
    }
    
    #mismatchesModal tbody td:first-child {
      text-align: left;
      font-weight: 600;
      color: var(--barclays-blue);
    }
    
    /* Enhanced row highlights for reconciliation */
    .row-removed td {
      background: rgba(255, 107, 107, 0.15) !important;
      color: #ff6b6b !important;
      border-left: 4px solid #ff6b6b !important;
    }
    .row-added td {
      background: rgba(0, 193, 213, 0.15) !important;
      color: #00C1D5 !important;
      border-left: 4px solid #00C1D5 !important;
    }
    .row-changed td {
      background: rgba(255, 224, 102, 0.15) !important;
      color: #ffe066 !important;
      border-left: 4px solid #ffe066 !important;
    }
    .row-unchanged td {
      background: var(--barclays-surface) !important;
      color: var(--barclays-text) !important;
    }
    
    /* Visual diff specific styles */
    .diff-from {
      background: rgba(255, 107, 107, 0.1) !important;
      color: #ff6b6b !important;
      font-weight: 500;
      border-radius: 4px;
      padding: 4px 8px;
      display: inline-block;
      min-width: 60px;
    }
    .diff-to {
      background: rgba(0, 193, 213, 0.1) !important;
      color: #00C1D5 !important;
      font-weight: 500;
      border-radius: 4px;
      padding: 4px 8px;
      display: inline-block;
      min-width: 60px;
    }
    .diff-arrow {
      color: var(--barclays-muted);
      margin: 0 8px;
      font-weight: bold;
    }
    .diff-status {
      font-weight: 600;
      padding: 4px 12px;
      border-radius: 6px;
      font-size: 0.9em;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .diff-status.removed {
      background: rgba(255, 107, 107, 0.2);
      color: #ff6b6b;
      border: 1px solid rgba(255, 107, 107, 0.3);
    }
    .diff-status.added {
      background: rgba(0, 193, 213, 0.2);
      color: #00C1D5;
      border: 1px solid rgba(0, 193, 213, 0.3);
    }
    .diff-status.changed {
      background: rgba(255, 224, 102, 0.2);
      color: #ffe066;
      border: 1px solid rgba(255, 224, 102, 0.3);
    }
    
    /* Enhanced Progress Indicators */
    .progress-container {
      background: var(--barclays-surface);
      border: 1px solid var(--barclays-blue-dark);
      border-radius: 8px;
      padding: 16px;
      margin: 16px 0;
      box-shadow: 0 2px 8px rgba(0, 174, 239, 0.1);
    }
    .progress-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }
    .progress-title {
      font-weight: 600;
      color: var(--barclays-text);
      font-size: 1.1em;
    }
    .progress-percentage {
      color: var(--barclays-blue);
      font-weight: 600;
      font-size: 1.1em;
    }
    .progress-bar {
      width: 100%;
      height: 8px;
      background: rgba(0, 174, 239, 0.1);
      border-radius: 4px;
      overflow: hidden;
      position: relative;
    }
    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--barclays-blue), var(--barclays-cyan));
      border-radius: 4px;
      transition: width 0.3s ease;
      position: relative;
    }
    .progress-fill::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
      animation: progress-shimmer 2s infinite;
    }
    @keyframes progress-shimmer {
      0% { transform: translateX(-100%); }
      100% { transform: translateX(100%); }
    }
    .progress-steps {
      display: flex;
      justify-content: space-between;
      margin-top: 8px;
      font-size: 0.85em;
      color: var(--barclays-muted);
    }
    .progress-step {
      display: flex;
      align-items: center;
      gap: 4px;
    }
    .progress-step.active {
      color: var(--barclays-blue);
      font-weight: 500;
    }
    .progress-step.completed {
      color: var(--barclays-green);
    }
    /* Add this to the <style> section */
    .modal-top {
      z-index: 10001 !important;
    }
    
    /* Enhanced Consolidated Data editing styles */
    .consolidated-data-cell input {
      transition: border-color 0.2s ease-in-out;
    }
    
    .consolidated-data-cell input.border-red-500 {
      border-color: #ef4444 !important;
      background-color: rgba(239, 68, 68, 0.1) !important;
    }
    
    .consolidated-data-cell input:focus {
      outline: none;
      border-color: var(--barclays-blue) !important;
      box-shadow: 0 0 0 2px rgba(0, 174, 239, 0.2) !important;
    }
    
    /* Button enhancements for consolidated data actions */
    .save-consolidated-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    
    .cancel-consolidated-btn {
      background-color: #6b7280 !important;
      transition: background-color 0.2s ease;
    }
    
    .cancel-consolidated-btn:hover {
      background-color: #4b5563 !important;
    }
    
    /* Visual indication for currently editing row */
    tr.editing-row {
      background-color: rgba(0, 174, 239, 0.05) !important;
      border: 1px solid rgba(0, 174, 239, 0.2) !important;
    }
    
    /* Input validation styling */
    .consolidated-data-cell input[required]:invalid {
      border-color: #ef4444 !important;
      background-color: rgba(239, 68, 68, 0.05) !important;
    }
    
    .consolidated-data-cell input[required]:valid {
      border-color: #22c55e !important;
      background-color: rgba(34, 197, 94, 0.05) !important;
    }
    /* Tab content fade/slide animation */
    .tab-content {
      opacity: 0;
      transform: translateY(20px);
      transition: opacity 0.4s cubic-bezier(0.4,0,0.2,1), transform 0.4s cubic-bezier(0.4,0,0.2,1);
      pointer-events: none;
    }
    .tab-content.active {
      opacity: 1;
      transform: translateY(0);
      pointer-events: auto;
      z-index: 2;
    }
    /* Skeleton Loader Styles */
    .skeleton {
      background: linear-gradient(90deg, #232c36 25%, #2A3A4D 50%, #232c36 75%);
      background-size: 200% 100%;
      animation: skeleton-loading 1.2s infinite linear;
      border-radius: 6px;
      min-height: 20px;
      display: inline-block;
    }
    body.light-mode .skeleton {
      background: linear-gradient(90deg, #e6f6fb 25%, #cceaf6 50%, #e6f6fb 75%) !important;
    }
    body.light-mode .skeleton-table-row td {
      background: #f7fafc !important;
    }
    @keyframes skeleton-loading {
      0% { background-position: 200% 0; }
      100% { background-position: -200% 0; }
    }
    .skeleton-table-row td {
      padding: 16px 8px;
    }
    /* Light mode input override */
    body.light-mode input,
    body.light-mode select,
    body.light-mode textarea {
      background: #ffffff !important;
      color: #1e293b !important;
      border: 1.5px solid #00C1D5 !important;
      box-shadow: 0 1px 2px 0 rgba(0, 193, 213, 0.05) !important;
    }
    body.light-mode input:focus,
    body.light-mode select:focus,
    body.light-mode textarea:focus {
      outline: none !important;
      border-color: #00AEEF !important;
      box-shadow: 0 0 0 3px rgba(0, 174, 239, 0.1) !important;
    }
    
    /* Light Mode Base Styling */
    body.light-mode {
      background: #f8fafc !important;
      color: #1e293b !important;
    }
    
    /* Enhanced text legibility improvements */
    .text-barclays-muted {
      color: var(--barclays-muted) !important;
      font-weight: 500 !important;
    }
    
    .text-muted {
      color: var(--barclays-muted) !important;
      font-weight: 500 !important;
    }
    
    /* Enhanced small text legibility */
    .text-xs {
      font-weight: 500 !important;
      letter-spacing: 0.025em !important;
    }
    
    .text-sm {
      font-weight: 500 !important;
      letter-spacing: 0.025em !important;
    }
    
    /* Enhanced opacity text */
    .opacity-80 {
      opacity: 0.9 !important;
    }
    
    .opacity-60 {
      opacity: 0.8 !important;
    }
    
    body.light-mode .barclays-header {
      background: #ffffff !important;
      color: #0077A3 !important;
      border-bottom: 2px solid #00C1D5 !important;
      box-shadow: 0 4px 6px -1px rgba(0, 174, 239, 0.1) !important;
    }
    
    /* Light Mode Modal Optimizations */
    body.light-mode #mismatchesModal .rounded-xl {
      background: #ffffff !important;
      color: #1e293b !important;
      border: 2px solid #00C1D5 !important;
      box-shadow: 0 25px 50px -12px rgba(0, 174, 239, 0.25) !important;
    }
    
    body.light-mode #mismatchesModal thead {
      background: linear-gradient(135deg, #0077A3 0%, #00AEEF 100%) !important;
    }
    
    body.light-mode #mismatchesModal thead th {
      color: #ffffff !important;
    }
    
    body.light-mode #mismatchesModal tbody tr {
      background: #ffffff !important;
      border-bottom: 1px solid rgba(0, 193, 213, 0.2) !important;
    }
    
    body.light-mode #mismatchesModal tbody tr:hover {
      background: rgba(0, 174, 239, 0.04) !important;
    }
    
    body.light-mode #mismatchesModal tbody td {
      color: #334155 !important;
    }
    
    body.light-mode #mismatchesModal tbody td:first-child {
      color: #0077A3 !important;
      font-weight: 700;
    }
    
    /* Light mode status indicators with better contrast */
    body.light-mode .status-active {
      background: linear-gradient(135deg, rgba(34, 197, 94, 0.1), rgba(34, 197, 94, 0.05)) !important;
      color: #15803d !important;
      border: 1.5px solid rgba(34, 197, 94, 0.4) !important;
    }
    
    body.light-mode .status-closed {
      background: linear-gradient(135deg, rgba(71, 85, 105, 0.1), rgba(71, 85, 105, 0.05)) !important;
      color: #475569 !important;
      border: 1.5px solid rgba(71, 85, 105, 0.4) !important;
    }
    
    body.light-mode .status-pending {
      background: linear-gradient(135deg, rgba(217, 119, 6, 0.1), rgba(217, 119, 6, 0.05)) !important;
      color: #b45309 !important;
      border: 1.5px solid rgba(217, 119, 6, 0.4) !important;
    }
    
    body.light-mode .status-inactive {
      background: linear-gradient(135deg, rgba(220, 38, 38, 0.1), rgba(220, 38, 38, 0.05)) !important;
      color: #b91c1c !important;
      border: 1.5px solid rgba(220, 38, 38, 0.4) !important;
    }
    
    /* Enhanced Table Container for Better Readability */
    body.light-mode .table-container {
      background: #ffffff !important;
      border: 1px solid #00C1D5 !important;
      box-shadow: 0 4px 6px -1px rgba(0, 174, 239, 0.1) !important;
    }
    
    body.light-mode .table-container thead th {
      background: #e6f6fb !important;
      color: #0077A3 !important;
      border-bottom: 2px solid #00C1D5 !important;
    }
    
    body.light-mode .table-container tbody tr {
      background: #ffffff !important;
      border-bottom: 1px solid rgba(0, 193, 213, 0.15) !important;
    }
    
    body.light-mode .table-container tbody tr:hover {
      background: rgba(0, 174, 239, 0.03) !important;
    }
    
    body.light-mode .table-container tbody td {
      color: #475569 !important;
      border-color: rgba(0, 193, 213, 0.15) !important;
    }
    
    /* Light mode surface elements */
    body.light-mode .bg-barclays-surface,
    body.light-mode [style*="background: var(--barclays-surface)"] {
      background: #ffffff !important;
      border: 1px solid #00C1D5 !important;
    }
    
    /* Light mode text colors */
    body.light-mode .text-header,
    body.light-mode .text-primary {
      color: #0077A3 !important;
    }
    
    body.light-mode .text-muted,
    body.light-mode .text-barclays-muted {
      color: #475569 !important;
      font-weight: 600 !important;
    }
    
    /* Light mode buttons */
    body.light-mode .barclays-btn {
      background: linear-gradient(135deg, #00AEEF 0%, #0077A3 100%) !important;
      color: #ffffff !important;
      border: none !important;
      box-shadow: 0 4px 6px -1px rgba(0, 174, 239, 0.25) !important;
    }
    
    body.light-mode .barclays-btn:hover {
      background: linear-gradient(135deg, #0077A3 0%, #005580 100%) !important;
      box-shadow: 0 6px 8px -1px rgba(0, 174, 239, 0.35) !important;
    }
    
    body.light-mode .barclays-secondary-btn {
      background: #f1f5f9 !important;
      color: #0077A3 !important;
      border: 1.5px solid #00C1D5 !important;
      box-shadow: 0 1px 2px 0 rgba(0, 193, 213, 0.05) !important;
    }
    
    body.light-mode .barclays-secondary-btn:hover {
      background: #e6f6fb !important;
      color: #005580 !important;
      border-color: #00AEEF !important;
    }
    
    /* Improved Typography for Better Readability */
    body.light-mode h1, body.light-mode h2, body.light-mode h3 {
      color: #0077A3 !important;
      font-weight: 700;
    }
    
    body.light-mode p, body.light-mode span, body.light-mode div {
      color: #334155 !important;
    }
    
    body.light-mode .text-sm {
      color: #475569 !important;
      font-weight: 500 !important;
    }
    
    /* Enhanced Table Row Highlights for Reconciliation */
    body.light-mode .row-removed td {
      background: rgba(239, 68, 68, 0.08) !important;
      color: #dc2626 !important;
      border-left: 4px solid #ef4444 !important;
    }
    
    body.light-mode .row-added td {
      background: rgba(34, 197, 94, 0.08) !important;
      color: #16a34a !important;
      border-left: 4px solid #22c55e !important;
    }
    
    body.light-mode .row-changed td {
      background: rgba(245, 158, 11, 0.08) !important;
      color: #d97706 !important;
      border-left: 4px solid #f59e0b !important;
    }
    
    body.light-mode .row-unchanged td {
      background: #ffffff !important;
      color: #334155 !important;
    }
    
    /* General Table Improvements for All Tables */
    table {
      font-size: 0.9rem;
      line-height: 1.5;
    }
    
    table th {
      font-weight: 600;
      letter-spacing: 0.025em;
      text-transform: uppercase;
      font-size: 0.8rem;
    }
    
    table td {
      vertical-align: middle;
    }
    
    /* Improved hover effects for all tables */
    .table-container tbody tr:hover,
    #mismatchesModal tbody tr:hover,
    #reconciliationDiffTable tbody tr:hover {
      transform: translateY(-1px);
      box-shadow: 0 2px 8px rgba(0, 174, 239, 0.08);
      transition: all 0.2s ease;
    }
    
    /* Enhanced status badge hover effect */
    .status-badge:hover {
      transform: scale(1.05);
      transition: transform 0.15s ease;
    }
    
    /* Enhanced form field labels for better legibility */
    label {
      font-weight: 600 !important;
      color: var(--barclays-text) !important;
      letter-spacing: 0.025em !important;
    }
    
    /* Enhanced placeholder text */
    ::placeholder {
      color: var(--barclays-muted) !important;
      opacity: 0.8 !important;
      font-weight: 500 !important;
    }
    
    /* Enhanced table cell text */
    .table-container tbody td {
      font-weight: 500 !important;
      letter-spacing: 0.025em !important;
    }
    
    /* Enhanced button text */
    .barclays-btn, .barclays-secondary-btn {
      font-weight: 600 !important;
      letter-spacing: 0.025em !important;
    }
    
    /* Better focus states for interactive elements */
    button:focus,
    input:focus,
    select:focus,
    textarea:focus {
      outline: 2px solid var(--barclays-blue) !important;
      outline-offset: 2px !important;
    }
    
    body.light-mode button:focus,
    body.light-mode input:focus,
    body.light-mode select:focus,
    body.light-mode textarea:focus {
      outline: 2px solid #00AEEF !important;
      outline-offset: 2px !important;
    }
    
    /* Improved modal backdrop */
    .fixed.inset-0.bg-black.bg-opacity-60 {
      backdrop-filter: blur(4px);
      -webkit-backdrop-filter: blur(4px);
    }
    
    /* Enhanced loading states */
    .animate-spin {
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }
    
    /* Better scrollbar styling for webkit browsers */
    .table-container::-webkit-scrollbar {
      width: 6px;
      height: 6px;
    }
    
    .table-container::-webkit-scrollbar-track {
      background: var(--barclays-bg);
    }
    
    .table-container::-webkit-scrollbar-thumb {
      background: var(--barclays-blue);
      border-radius: 3px;
    }
    
    .table-container::-webkit-scrollbar-thumb:hover {
      background: var(--barclays-blue-dark);
    }
    
    body.light-mode .table-container::-webkit-scrollbar-track {
      background: rgba(0, 193, 213, 0.05);
    }
    
    body.light-mode .table-container::-webkit-scrollbar-thumb {
      background: #00C1D5;
    }
    
    body.light-mode .table-container::-webkit-scrollbar-thumb:hover {
      background: #00AEEF;
    }
    
    /* Light mode form section styles */
    body.light-mode .form-section {
      background: rgba(0, 174, 239, 0.03) !important;
      border-color: rgba(0, 174, 239, 0.15) !important;
    }
    
    body.light-mode .form-section-title {
      color: #0077A3 !important;
    }
    
    body.light-mode .form-section-title::before {
      background: #00AEEF !important;
    }
    
    body.light-mode .field-hint {
      color: #475569 !important;
      font-weight: 500 !important;
    }
    
    /* Light mode form labels */
    body.light-mode label {
      color: #1e293b !important;
      font-weight: 600 !important;
    }
    
    /* Light mode placeholder text */
    body.light-mode ::placeholder {
      color: #64748b !important;
      opacity: 0.8 !important;
      font-weight: 500 !important;
    }
    
    /* Light mode progress indicator styles */
    body.light-mode .progress-container {
      background: #f8fafc !important;
      border-color: #00AEEF !important;
    }
    
    body.light-mode .progress-title {
      color: #0077A3 !important;
    }
    
    body.light-mode .progress-percentage {
      color: #00AEEF !important;
    }
    
    body.light-mode .progress-bar {
      background: rgba(0, 174, 239, 0.1) !important;
    }
    
    body.light-mode .progress-step {
      color: #475569 !important;
      font-weight: 500 !important;
    }
    
    body.light-mode .progress-step.active {
      color: #00AEEF !important;
    }
    
    body.light-mode .progress-step.completed {
      color: #22c55e !important;
    }
    
    /* Light mode diff styles */
    body.light-mode .diff-from {
      background: rgba(255, 107, 107, 0.1) !important;
      color: #dc2626 !important;
    }
    
    body.light-mode .diff-to {
      background: rgba(0, 193, 213, 0.1) !important;
      color: #0891b2 !important;
    }
    
    body.light-mode .diff-status.removed {
      background: rgba(255, 107, 107, 0.15) !important;
      color: #dc2626 !important;
      border-color: rgba(255, 107, 107, 0.3) !important;
    }
    
    body.light-mode .diff-status.added {
      background: rgba(0, 193, 213, 0.15) !important;
      color: #0891b2 !important;
      border-color: rgba(0, 193, 213, 0.3) !important;
    }
    
    body.light-mode .diff-status.changed {
      background: rgba(255, 224, 102, 0.15) !important;
      color: #ca8a04 !important;
      border-color: rgba(255, 224, 102, 0.3) !important;
    }

    /* Light mode splash screen overrides */
    body.light-mode #splashScreen {
      background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 50%, #f1f5f9 100%);
    }
    
    body.light-mode #splashScreen::before {
      background: radial-gradient(circle at 50% 50%, rgba(0, 174, 239, 0.05) 0%, transparent 70%);
    }
    
    body.light-mode #splashScreen .welcome-text {
      color: #1e293b;
      text-shadow: 0 0 10px rgba(30, 41, 59, 0.1);
      animation: textSlideIn 1.5s ease-out 0.5s both, textGlowLight 2s ease-in-out infinite 1.5s;
    }
    
    body.light-mode #splashScreen .loading-dots .dot {
      background: var(--barclays-blue);
    }
    
    @keyframes textGlowLight {
      0%, 100% { text-shadow: 0 0 10px rgba(30, 41, 59, 0.1); }
      50% { text-shadow: 0 0 15px rgba(30, 41, 59, 0.2); }
    }
    /* Modal Animations */
    .modal-animate {
      opacity: 0;
      transform: scale(0.96) translateY(30px);
      transition: opacity 0.35s cubic-bezier(0.4,0,0.2,1), transform 0.35s cubic-bezier(0.4,0,0.2,1);
    }
    .modal-animate-in {
      opacity: 1 !important;
      transform: scale(1) translateY(0) !important;
      pointer-events: auto;
    }
    .modal-animate-out {
      opacity: 0 !important;
      transform: scale(0.96) translateY(30px) !important;
      pointer-events: none;
    }
    /* Toast Animations */
    .toast-animate {
      opacity: 0;
      transform: translateX(120%) scale(0.98);
      transition: transform 0.45s cubic-bezier(0.4,0,0.2,1), opacity 0.35s cubic-bezier(0.4,0,0.2,1);
    }
    .toast-animate-in {
      opacity: 1 !important;
      transform: translateX(0) scale(1) !important;
      pointer-events: auto;
    }
    .toast-animate-out {
      opacity: 0 !important;
      transform: translateX(120%) scale(0.98) !important;
      pointer-events: none;
    }
  </style>
  
  <!-- Firebase Scripts (Updated to latest version) -->
  <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-auth-compat.js"></script>
  
  <!-- External Libraries -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>
</head>
<body class="min-h-screen p-4" style="background: var(--barclays-bg);">
  <!-- Enhanced Splash Screen -->
  <div id="splashScreen" style="display: flex;">
    <img class="barclays-logo splash-logo" src="https://www.barclays.co.uk/content/dam/icons/favicons/barclays/Eagle_RGB_Cyan_Large.svg" alt="Barclays Logo" />
    <div class="welcome-text">Welcome to Barclays Network Management Portal</div>
    <div class="loading-dots">
      <div class="dot"></div>
      <div class="dot"></div>
      <div class="dot"></div>
    </div>
  </div>

  <!-- Header -->
  <header class="barclays-header text-center py-6 rounded-xl shadow-md" style="display: none;">
    <div class="flex justify-center items-center gap-4">
      <img class="barclays-logo header-logo" src="https://www.barclays.co.uk/content/dam/icons/favicons/barclays/Eagle_RGB_Cyan_Large.svg" alt="Barclays Logo" />
      <h1 class="text-3xl font-bold text-header">Barclays Network Management Operations</h1>
    </div>
    <div class="mt-2 flex justify-center items-center gap-4">
      <div id="authStatus" class="text-sm opacity-80"></div>
      <div id="connectionStatus" class="connection-status connection-online">🟢 Online</div>
      <button id="signInBtn" onclick="openSignInModal()" class="ml-4 bg-gray-800 text-blue-100 px-4 py-2 rounded-lg font-medium shadow-sm hover:bg-blue-100 transition-all hidden">Sign In</button>
      <button id="signOutBtn" onclick="signOutUser()" class="ml-2 bg-red-600 text-white px-4 py-2 rounded-lg font-medium shadow-sm hover:bg-red-700 transition-all hidden">Sign Out</button>
      <button id="darkModeToggle" onclick="toggleDarkMode()" class="ml-4 barclays-secondary-btn px-4 py-2 rounded-lg font-medium flex items-center gap-2" title="Toggle dark/light mode">
        <span id="darkModeIcon">🌙</span> <span id="darkModeText">Dark Mode</span>
      </button>
    </div>
  </header>

  <!-- Main Content -->
  <main id="mainContent" class="mt-8 max-w-6xl mx-auto" style="display: none;">
    <!-- Tab Navigation -->
    <div class="shadow-sm rounded-xl mb-6 flex justify-center space-x-4 p-4" style="background: var(--barclays-surface);">
      <button onclick="showTab('workflow')" id="tab-workflow" class="tab-btn inactive-tab px-6 py-3 rounded-lg font-medium transition-all barclays-btn">
        <svg xmlns="http://www.w3.org/2000/svg" class="barclays-icon mr-2 inline-block" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16M4 18h16" /></svg>
        Workflow
      </button>
      <button onclick="showTab('dashboard')" id="tab-dashboard" class="tab-btn inactive-tab px-6 py-3 rounded-lg font-medium transition-all barclays-btn hidden">
        <svg xmlns="http://www.w3.org/2000/svg" class="barclays-icon mr-2 inline-block" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l9-9 9 9M4 10v10a1 1 0 001 1h3m10-11v10a1 1 0 01-1 1h-3m-6 0h6" /></svg>
        Dashboard
      </button>
      <button onclick="showTab('account')" id="tab-account" class="tab-btn inactive-tab px-6 py-3 rounded-lg font-medium transition-all barclays-btn">
        <svg xmlns="http://www.w3.org/2000/svg" class="barclays-icon mr-2 inline-block" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5.121 17.804A13.937 13.937 0 0112 15c2.5 0 4.847.655 6.879 1.804M15 11a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
        Account Management
      </button>
      <button onclick="showTab('reconciliation')" id="tab-reconciliation" class="tab-btn inactive-tab px-6 py-3 rounded-lg font-medium transition-all barclays-btn">
        <svg xmlns="http://www.w3.org/2000/svg" class="barclays-icon mr-2 inline-block" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8h-14m0 0l4-4m-4 4l4 4M7 16h14m0 0l-4-4m4 4l-4 4"/>
        </svg>
        Reconciliation
      </button>
    </div>

    <!-- Dashboard Tab (Admins Only) -->
    <div id="dashboard" class="tab-content hidden fade-in">
      <div class="p-8 rounded-xl shadow-lg" style="background: var(--barclays-surface);">
        <h2 class="text-2xl font-semibold mb-6 text-header">Admin Dashboard</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
          <!-- Recent Reconciliation Mismatches Widget -->
          <div class="bg-barclays-surface rounded-xl shadow p-6 flex flex-col items-start">
            <div class="text-lg font-bold mb-2">Recent Reconciliation Mismatches</div>
            <div id="dashboardRecentMismatchesCount" class="text-3xl font-extrabold text-red-400 mb-2">-</div>
            <ul id="dashboardRecentMismatchesList" class="text-sm text-barclays-muted mb-2"></ul>
            <a href="#" onclick="showTab('reconciliation'); return false;" class="text-blue-400 hover:underline">View All</a>
          </div>
          <!-- Account Creation Trends Chart Widget -->
          <div class="bg-barclays-surface rounded-xl shadow p-6 flex flex-col items-start">
            <div class="text-lg font-bold mb-2">Account Creation Trends</div>
            <div style="width: 100%; height: 200px; position: relative;">
              <canvas id="dashboardAccountTrendsChart"></canvas>
              <div id="accountTrendsPlaceholderContainer" style="display:none; width:100%; height:100%; position:absolute; top:0; left:0; background:var(--barclays-surface); align-items:center; justify-content:center; flex-direction:column;">
                <img id="accountTrendsPlaceholder" src="https://www.barclays.co.uk/content/dam/icons/favicons/barclays/Eagle_RGB_Cyan_Large.svg" alt="No data" style="width:80px; height:80px; margin:auto; opacity:0.7;"/>
                <div style="color:var(--barclays-muted); text-align:center; margin-top:12px; font-size:1.1em;">No account creation data for the last 30 days</div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Enhanced Interconnection Dashboard -->
        <div class="mt-8">
          <h3 class="text-xl font-semibold mb-4 text-header">System Interconnections Overview</h3>
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
            <!-- Requests to Accounts Conversion -->
            <div class="bg-barclays-surface rounded-xl shadow p-4 flex flex-col items-center">
              <div class="text-lg font-bold mb-2 text-blue-400">🔗 Request → Account</div>
              <div id="dashboardRequestsToAccountsCount" class="text-2xl font-extrabold text-blue-400 mb-1">-</div>
              <div class="text-xs text-barclays-muted text-center">Successful conversions</div>
            </div>
            
            <!-- Accounts in Workflow -->
            <div class="bg-barclays-surface rounded-xl shadow p-4 flex flex-col items-center">
              <div class="text-lg font-bold mb-2 text-green-400">⚙️ In Workflow</div>
              <div id="dashboardAccountsInWorkflowCount" class="text-2xl font-extrabold text-green-400 mb-1">-</div>
              <div class="text-xs text-barclays-muted text-center">Currently processing</div>
            </div>
            
            <!-- Direct Creations -->
            <div class="bg-barclays-surface rounded-xl shadow p-4 flex flex-col items-center">
              <div class="text-lg font-bold mb-2 text-purple-400">➕ Direct Created</div>
              <div id="dashboardDirectCreatedCount" class="text-2xl font-extrabold text-purple-400 mb-1">-</div>
              <div class="text-xs text-barclays-muted text-center">Via Account Management</div>
            </div>
            
            <!-- Lifecycle Completion -->
            <div class="bg-barclays-surface rounded-xl shadow p-4 flex flex-col items-center">
              <div class="text-lg font-bold mb-2 text-yellow-400">🎯 Fully Processed</div>
              <div id="dashboardProcessedAccountsCount" class="text-2xl font-extrabold text-yellow-400 mb-1">-</div>
              <div class="text-xs text-barclays-muted text-center">Complete end-to-end</div>
            </div>
          </div>
          

        </div>
      </div>
    </div>

    <!-- Account Management Tab -->
    <div id="account" class="tab-content fade-in">
      <div class="p-8 rounded-xl shadow-lg" style="background: var(--barclays-surface);">
        <div id="workflowRedirectNotice" class="hidden mb-4 p-3 rounded-lg" style="background: var(--barclays-blue); background: linear-gradient(135deg, var(--barclays-blue) 0%, var(--barclays-cyan) 100%); color: white;">
          <div class="flex items-center gap-2">
            <svg xmlns="http://www.w3.org/2000/svg" class="barclays-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            <span class="font-medium">You were redirected from the Workflow tab to create a new account here.</span>
          </div>
        </div>
        <h2 class="text-2xl font-semibold mb-6 text-header">Create New Account</h2>
        <form id="accountForm" class="space-y-4" onsubmit="return false;">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="form-group">
              <label class="block text-sm font-medium text-primary mb-2">Agent Bank Name <span class="text-red-500">*</span></label>
              <div class="field-wrapper">
                <input id="accountName" type="text" placeholder="Enter agent bank name" required
                       class="w-full border border-gray-300 p-3 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all"
                       onblur="validateField(this)" oninput="maybeShowAccountIdPreview(); updateButtonState()">
                <div id="accountNameError" class="error-message"></div>
                <div id="accountNameSuccess" class="success-message"></div>
                <div class="field-hint">Enter the full legal name of the agent bank (required)</div>
              </div>
            </div>
            <div class="form-group" id="accountIdField">
              <label class="block text-sm font-medium text-primary mb-2">Account ID</label>
              <div class="field-wrapper">
                <input id="accountId" type="text" placeholder="Auto-generated ID" 
                       class="w-full border border-gray-300 p-3 rounded-lg bg-gray-50" readonly>
                <div class="field-hint">Account ID will be automatically generated</div>
              </div>
            </div>
            <div class="form-group">
              <label class="block text-sm font-medium text-primary mb-2">Contact Email <span class="text-red-500">*</span></label>
              <div class="field-wrapper">
                <input id="contactEmail" type="email" placeholder="contact@company.com" required
                       class="w-full border border-gray-300 p-3 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all"
                       onblur="validateField(this)" oninput="maybeShowAccountIdPreview(); updateButtonState()">
                <div id="contactEmailError" class="error-message"></div>
                <div id="contactEmailSuccess" class="success-message"></div>
                <div class="field-hint">Primary contact email for account communications (required)</div>
              </div>
            </div>
            <div class="form-group" id="leiField">
              <label class="block text-sm font-medium text-primary mb-2">Legal Entity Identifier (LEI) <span class="text-red-500">*</span></label>
              <div class="field-wrapper">
                <input id="leiNumber" type="text" placeholder="335800AABBCCDDEE1234" required
                       class="w-full border border-gray-300 p-3 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all"
                       onblur="validateField(this)" oninput="updateButtonState()">
                <div id="leiNumberError" class="error-message"></div>
                <div id="leiNumberSuccess" class="success-message"></div>
                <div class="field-hint">LEI format is flexible. Standard format: 4 digits LOU, 00, 12 alphanumeric, 2 check digits (e.g. 335800AABBCCDDEE1234)</div>
              </div>
            </div>
          </div>
          <div class="flex gap-4 pt-4">
            <button type="button" id="createAccountBtn" onclick="generateAccountIdAndSave()" class="barclays-btn px-6 py-3 rounded-lg font-medium transition-all flex items-center gap-2">
              <span class="flex items-center gap-2"><span id="createBtnText">Create Account</span><div id="createBtnLoader" class="loading hidden"></div></span>
            </button>
            <button type="button" id="viewAccountsBtn" onclick="promptAccess()" 
                    class="barclays-secondary-btn px-6 py-3 rounded-lg font-medium transition-all flex items-center gap-2">
              <span class="flex items-center gap-2"><span id="viewBtnText">View Stored Accounts</span><div id="viewBtnLoader" class="loading hidden"></div></span>
            </button>
          </div>
        </form>

        <!-- Accounts List -->
        <div id="accountsSection" class="mt-8 hidden">
          <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-semibold text-gray-800">Account List</h3>
            <div class="flex gap-2">
              <button onclick="refreshAccounts()" class="text-blue-600 hover:text-blue-800 font-medium">
                🔄 Refresh
              </button>
              <button onclick="downloadAccountsCSV()" class="barclays-btn px-4 py-2 rounded-lg font-medium flex items-center gap-2">
                <span>📥 Download CSV</span>
              </button>
              <button onclick="deleteAllAccounts()" class="bg-red-600 text-white px-4 py-2 rounded-lg font-medium">Delete All Accounts</button>
            </div>
          </div>
          <!-- Table Filters -->
          <div class="table-filters">
            <div class="filter-group">
              <label for="statusFilter">Status:</label>
              <select id="statusFilter" onchange="applyFilters()">
                <option value="">All Statuses</option>
                <option value="Active">Active</option>
                <option value="Inactive">Inactive</option>
                <option value="Pending">Pending</option>
                <option value="Closed">Closed</option>
              </select>
            </div>
            <div class="filter-group">
              <label for="reconciliationFilter">Reconciliation:</label>
              <select id="reconciliationFilter" onchange="applyFilters()">
                <option value="">All</option>
                <option value="Yes">Yes</option>
                <option value="No">No</option>
              </select>
            </div>
            <div class="filter-group">
              <label for="searchFilter">Search:</label>
              <input type="text" id="searchFilter" placeholder="Search accounts..." onkeyup="applyFilters()">
            </div>
            <button onclick="clearFilters()" class="clear-filters-btn">Clear Filters</button>
          </div>
          
          <!-- Enhanced Table with Sticky Headers -->
          <div class="table-container">
            <table id="accountList" class="w-full border-collapse">
              <thead>
                <tr>
                  <th class="sortable" onclick="sortTable('name')" data-sort="name">Agent Bank</th>
                  <th class="sortable" onclick="sortTable('id')" data-sort="id">Account ID</th>
                  <th class="sortable" onclick="sortTable('email')" data-sort="email">Email</th>
                  <th class="sortable" onclick="sortTable('lei')" data-sort="lei">LEI</th>
                  <th class="sortable" onclick="sortTable('status')" data-sort="status">Status</th>
                  <th class="sortable" onclick="sortTable('accountOpeningDate')" data-sort="accountOpeningDate">Account Opening Date</th>
                  <th class="sortable" onclick="sortTable('accountClosureDate')" data-sort="accountClosureDate">Account Closure Date</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="accountListBody"></tbody>
            </table>
          </div>
          <div id="accountsPagination" class="mt-4 flex justify-end gap-2">
            <button onclick="prevAccountsPage()" id="accountsPrevBtn" class="barclays-secondary-btn px-4 py-2 rounded-lg font-medium transition-all" disabled>Previous</button>
            <button onclick="nextAccountsPage()" id="accountsNextBtn" class="barclays-btn px-4 py-2 rounded-lg font-medium transition-all" disabled>Next</button>
          </div>
          <div id="noAccountsMessage" class="hidden flex flex-col items-center justify-center text-center p-8 mt-6 border-2 border-dashed border-blue-400 rounded-xl bg-barclays-surface text-barclays-muted transition-all">
            <img src="https://www.barclays.co.uk/content/dam/icons/favicons/barclays/Eagle_RGB_Cyan_Large.svg" alt="No Accounts" class="mx-auto mb-4" style="width:64px;height:64px;opacity:0.7;" />
            <h3 class="text-2xl font-bold mb-2 text-barclays-text">No Accounts Yet</h3>
            <p class="mb-4 text-lg text-barclays-muted">Get started by creating your first account. Accounts you create will appear here for easy management.</p>
            <button onclick="scrollToAccountForm()" class="barclays-btn px-6 py-3 rounded-lg font-medium text-lg">Create Your First Account</button>
          </div>
        </div>
      </div>
    </div>



    <!-- Reconciliation Tab -->
    <div id="reconciliation" class="tab-content hidden fade-in">
      <div class="p-8 rounded-xl shadow-lg" style="background: var(--barclays-surface);">
        <h2 class="text-2xl font-semibold mb-6 text-header">Data Reconciliation</h2>
        <div class="space-y-6">
          <div class="flex flex-col md:flex-row gap-4 items-end">
            <div class="flex-1">
              <label class="block text-sm font-medium text-primary mb-2">Upload CSV File A (Previous Data)</label>
              <div class="relative">
                <input id="csvFileA" type="file" accept=".csv" 
                       class="w-full border border-gray-300 p-3 rounded-lg file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"
                       onchange="updateFileStatus('csvFileA', this)">
                <div id="fileAStatus" class="hidden mt-2 text-sm">
                  <span class="text-green-600">✅ File selected</span>
                  <span id="fileAInfo" class="text-barclays-muted ml-2"></span>
                </div>
              </div>
            </div>
            <div class="flex-1">
              <label class="block text-sm font-medium text-primary mb-2">Upload CSV File B (Current Data)</label>
              <div class="relative">
                <input id="csvFileB" type="file" accept=".csv" 
                       class="w-full border border-gray-300 p-3 rounded-lg file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"
                       onchange="updateFileStatus('csvFileB', this)">
                <div id="fileBStatus" class="hidden mt-2 text-sm">
                  <span class="text-green-600">✅ File selected</span>
                  <span id="fileBInfo" class="text-barclays-muted ml-2"></span>
                </div>
              </div>
            </div>
            <button onclick="compareCSVFiles()" id="compareBtn"
                    class="barclays-btn px-6 py-3 rounded-lg font-medium transition-all flex items-center gap-2">
              <span class="flex items-center gap-2"><span id="compareBtnText">⚖️ Compare & Reconcile</span><div id="compareBtnLoader" class="loading hidden"></div></span>
            </button>
          </div>
          
          <!-- File Upload Progress -->
          <div id="fileUploadProgress" class="hidden progress-container">
            <div class="progress-header">
              <div class="progress-title">Validating Files</div>
              <div class="progress-percentage" id="uploadProgressPercentage">0%</div>
            </div>
            <div class="progress-bar">
              <div class="progress-fill" id="uploadProgressFill" style="width: 0%"></div>
            </div>
            <div class="progress-steps">
              <div class="progress-step" id="uploadStep1">
                <span>📁</span>
                <span>File A</span>
              </div>
              <div class="progress-step" id="uploadStep2">
                <span>📁</span>
                <span>File B</span>
              </div>
              <div class="progress-step" id="uploadStep3">
                <span>✅</span>
                <span>Validation</span>
              </div>
            </div>
          </div>

          <!-- Enhanced Progress Indicator -->
          <div id="reconciliationProgress" class="hidden progress-container">
            <div class="progress-header">
              <div class="progress-title">Processing Files</div>
              <div class="progress-percentage" id="progressPercentage">0%</div>
            </div>
            <div class="progress-bar">
              <div class="progress-fill" id="progressFill" style="width: 0%"></div>
            </div>
            <div class="progress-steps">
              <div class="progress-step" id="step1">
                <span>📁</span>
                <span>Upload Files</span>
              </div>
              <div class="progress-step" id="step2">
                <span>🔍</span>
                <span>Parse Data</span>
              </div>
              <div class="progress-step" id="step3">
                <span>⚖️</span>
                <span>Compare Records</span>
              </div>
              <div class="progress-step" id="step4">
                <span>📊</span>
                <span>Generate Results</span>
              </div>
            </div>
          </div>

          <!-- Enhanced Reconciliation Result -->
          <div id="reconciliationResult" class="hidden mt-6">
            <h3 class="text-lg font-semibold mb-4 text-header">Reconciliation Results</h3>
            <div id="reconciliationSummary" class="mb-6 p-4 rounded-lg" style="background: var(--barclays-surface); border: 1px solid var(--barclays-blue-dark);"></div>
            
            <!-- Enhanced Visual Diff Table -->
            <div class="overflow-x-auto max-h-96 border rounded-lg" style="border-color: var(--barclays-blue-dark);">
              <table id="reconciliationDiffTable" class="w-full border-collapse">
                <thead id="reconciliationDiffHeader" class="sticky top-0"></thead>
                <tbody id="reconciliationDiffBody"></tbody>
              </table>
            </div>
            
            <div id="noReconciliationMessage" class="hidden text-center p-6 mt-4 border border-dashed border-gray-600 rounded-lg text-gray-400">
              <span style="font-size:1.3em;vertical-align:middle;">🗂️</span> No differences found.
            </div>
            
            <div class="mt-6 flex gap-4 flex-wrap">
              <button onclick="storeReconciliationData()" id="storeDataBtn"
                      class="barclays-btn px-4 py-2 rounded-lg font-medium transition-all flex items-center gap-2">
                <span class="flex items-center gap-2"><span id="storeBtnText">💾 Store in Database</span><div id="storeBtnLoader" class="loading hidden"></div></span>
              </button>
              <button onclick="downloadMismatchesCSV()" id="downloadMismatchesBtn"
                      class="barclays-btn px-4 py-2 rounded-lg font-medium flex items-center gap-2 hidden">
                <span>📥 Download Mismatches CSV</span>
              </button>
              <button onclick="clearCSVData()" id="clearDataBtn"
                      class="barclays-secondary-btn px-4 py-2 rounded-lg font-medium transition-all flex items-center gap-2">
                <span class="flex items-center gap-2"><span id="clearBtnText">🗑️ Clear Data</span><div id="clearBtnLoader" class="loading hidden"></div></span>
              </button>
            </div>
          </div>

          <!-- Stored Reconciliation Records -->
          <div class="p-8 rounded-xl shadow-lg mt-8" style="background: var(--barclays-surface);">
            <div class="flex justify-between items-center mb-6">
              <h2 class="text-2xl font-semibold text-gray-800">Stored Records</h2>
              <div class="flex gap-4">
                <select id="batchFilter" class="border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500">
                  <option value="">All Batches</option>
                </select>
                <button onclick="loadReconciliationRecords()" class="text-blue-600 hover:text-blue-800 font-medium">
                  🔄 Refresh
                </button>
              </div>
            </div>

            <!-- Records Table -->
            <div class="table-container">
              <table id="reconciliationTable" class="w-full border-collapse">
                <thead>
                  <tr>
                    <th class="sortable" onclick="sortReconciliationTable('batchId')" data-sort="batchId">Batch ID</th>
                    <th class="sortable" onclick="sortReconciliationTable('uploadedAt')" data-sort="uploadedAt">Uploaded At</th>
                    <th class="sortable" onclick="sortReconciliationTable('uploadedBy')" data-sort="uploadedBy">Uploaded By</th>
                    <th class="sortable" onclick="sortReconciliationTable('recordData')" data-sort="recordData">Record Data</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody id="reconciliationTableBody">
                  <tr class="skeleton-table-row">
                    <td colspan="5">
                      <div class="flex space-x-2">
                        <div class="skeleton" style="width: 100px; height: 20px;"></div>
                        <div class="skeleton" style="width: 120px; height: 20px;"></div>
                        <div class="skeleton" style="width: 100px; height: 20px;"></div>
                        <div class="skeleton" style="width: 180px; height: 20px;"></div>
                        <div class="skeleton" style="width: 80px; height: 20px;"></div>
                      </div>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div id="noRecordsMessage" class="hidden flex flex-col items-center justify-center text-center p-8 mt-6 border-2 border-dashed border-blue-400 rounded-xl bg-barclays-surface text-barclays-muted transition-all">
              <img src="https://www.barclays.co.uk/content/dam/icons/favicons/barclays/Eagle_RGB_Cyan_Large.svg" alt="No Records" class="mx-auto mb-4" style="width:64px;height:64px;opacity:0.7;" />
              <h3 class="text-2xl font-bold mb-2 text-barclays-text">No Records Found</h3>
              <p class="mb-4 text-lg text-barclays-muted">You haven't stored any reconciliation records yet. Upload your data to get started and see results here.</p>
              <button onclick="scrollToReconciliationUpload()" class="barclays-btn px-6 py-3 rounded-lg font-medium text-lg">Upload Data</button>
            </div>

            <!-- Pagination Controls for Reconciliation -->
            <div id="reconciliationPagination" class="mt-4 flex justify-end gap-2">
              <button onclick="prevReconciliationPage()" id="reconciliationPrevBtn" class="barclays-secondary-btn px-4 py-2 rounded-lg font-medium transition-all" disabled>Previous</button>
              <button onclick="nextReconciliationPage()" id="reconciliationNextBtn" class="barclays-btn px-4 py-2 rounded-lg font-medium transition-all" disabled>Next</button>
            </div>

            <!-- Batch Statistics -->
            <div id="batchStats" class="mt-6 grid grid-cols-1 md:grid-cols-3 gap-4">
              <!-- Stats will be populated by JS -->
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Workflow Tab -->
    <div id="workflow" class="tab-content hidden fade-in">
      <div class="p-8 rounded-xl shadow-lg" style="background: var(--barclays-surface);">
        <div class="flex justify-between items-center mb-4">
          <div>
            <h2 class="text-2xl font-semibold text-header">Pending Account Requests</h2>
            <p class="text-sm text-barclays-muted mt-1">💡 <strong>Note:</strong> Select document IDs from the dropdown and click "Save and Upload" to assign accounts to documents in Firebase.</p>
          </div>
          <button id="refreshConsolidatedDataBtn" class="barclays-btn px-4 py-2 rounded-lg font-medium flex items-center gap-2">🔄 Refresh</button>
        </div>
        <div class="table-container">
          <table id="consolidatedDataTable" class="w-full border-collapse">
            <thead>
              <tr id="consolidatedDataHeaderRow">
                <!-- Headers will be dynamically generated -->
              </tr>
            </thead>
            <tbody id="consolidatedDataBody">
              <tr><td colspan="100%" class="text-center text-barclays-muted">Loading data...</td></tr>
            </tbody>
          </table>
        </div>
        
        <!-- Accounts in Workflow Table -->
        <div class="mt-8">
          <div class="mb-3 p-3 rounded-lg bg-blue-50 border-l-4 border-blue-400">
            <div class="flex items-center gap-2 text-blue-800">
              <svg xmlns="http://www.w3.org/2000/svg" class="barclays-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
              <span class="text-sm font-medium">Accounts created in Account Management automatically appear here for workflow processing.</span>
            </div>
          </div>
          <div class="flex justify-between items-center mb-4">
            <div class="flex items-center gap-3">
              <h3 class="text-xl font-semibold text-header">Accounts in Workflow</h3>
              <span id="accountManagementCounter" class="hidden bg-green-100 text-green-800 px-2 py-1 rounded-full text-xs font-medium">
                <span id="accountManagementCount">0</span> created accounts
              </span>
            </div>
            <button onclick="goToCreateAccount()" class="barclays-btn px-4 py-2 rounded-lg font-medium flex items-center gap-2" title="Go to Account Management to create a new account">
              <svg xmlns="http://www.w3.org/2000/svg" class="barclays-icon mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6" />
              </svg>
              Create New Account
            </button>
          </div>
          <div class="table-container">
            <table id="accountCreationTable" class="w-full border-collapse">
              <thead>
                <tr>
                  <th>Agent Bank Name</th>
                  <th>Account ID</th>
                  <th>LEI</th>
                  <th>Account Status</th>
                  <th>Assigned Document ID</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="accountCreationBody">
                <tr><td colspan="6" class="text-center text-barclays-muted">Accounts created in Account Management will appear here automatically</td></tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- Save and Upload Button -->
        <div class="mt-6 text-center">
          <div class="flex justify-center gap-4 flex-wrap">
            <button id="saveAndUploadBtn" onclick="saveAndUploadData()" class="barclays-btn px-6 py-3 rounded-lg font-medium flex items-center gap-2">
              <svg xmlns="http://www.w3.org/2000/svg" class="barclays-icon mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4" />
              </svg>
              <span id="saveUploadBtnText">Save and Upload</span>
            </button>
            <button id="undoUploadBtn" onclick="undoLastUpload()" class="bg-orange-600 hover:bg-orange-700 text-white px-6 py-3 rounded-lg font-medium flex items-center gap-2 hidden" title="Undo your most recent upload">
              <svg xmlns="http://www.w3.org/2000/svg" class="barclays-icon mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6" />
              </svg>
              <span id="undoBtnText">Undo Last Upload</span>
            </button>
          </div>
        </div>

        <!-- Unified Data Table -->
        <div id="unifiedDataSection" class="mt-8 hidden">
          <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-semibold text-header">Unified Data</h3>
            <button id="clearUnifiedDataBtn" onclick="clearUnifiedData()" class="barclays-secondary-btn px-4 py-2 rounded-lg font-medium flex items-center gap-2">
              <svg xmlns="http://www.w3.org/2000/svg" class="barclays-icon mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
              </svg>
              Clear
            </button>
          </div>
          <div class="table-container">
            <table id="unifiedDataTable" class="w-full border-collapse">
              <thead>
                <tr id="unifiedDataHeaderRow">
                  <!-- Headers will be dynamically generated from both tables -->
                </tr>
              </thead>
              <tbody id="unifiedDataBody">
                <tr><td colspan="100%" class="text-center text-barclays-muted">Click "Unify Data" to combine table data</td></tr>
              </tbody>
            </table>
          </div>
        </div>


      </div>
    </div>
  </main>

  <!-- Toast Notification -->
  <div id="toast" class="toast">
    <span class="toast-icon" style="display:none"></span>
    <span class="toast-message"></span>
    <button id="toastCloseBtn" type="button" aria-label="Close" style="background:transparent;border:none;color:inherit;font-size:1.2em;cursor:pointer;position:absolute;top:8px;right:12px;display:none;">✖️</button>
  </div>

  <!-- Edit Account Modal -->
  <div id="editAccountModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-60 hidden">
    <div class="rounded-xl shadow-lg p-8 w-full max-w-lg relative" style="background: var(--barclays-surface);">
      <button onclick="closeEditAccountModal()" class="absolute top-2 right-2 text-gray-400 hover:text-gray-700">✖️</button>
      <h2 class="text-xl font-semibold mb-4 text-gray-800 dark:text-gray-100 border-b pb-2">Edit Account</h2>
      <form id="editAccountForm" class="space-y-4">
        <input type="hidden" id="editAccountId" />
        <div>
          <label class="block text-sm font-medium mb-2">Agent Bank</label>
          <input id="editAccountName" type="text" class="w-full border border-gray-300 p-3 rounded-lg" required />
        </div>
        <div id="editLeiField">
          <label class="block text-sm font-medium mb-2">Legal Entity Identifier (LEI)</label>
          <input id="editLeiNumber" type="text" class="w-full border border-gray-300 p-3 rounded-lg" />
        </div>
        <div>
          <label class="block text-sm font-medium mb-2">Status</label>
          <select id="editAccountStatus" class="w-full border border-gray-300 p-3 rounded-lg">
            <option value="Active">Active</option>
            <option value="Dormant">Dormant</option>
            <option value="Closed">Closed</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium mb-2">Account Opening Date</label>
          <input id="editAccountOpeningDate" type="date" class="w-full border border-gray-300 p-3 rounded-lg" readonly />
        </div>
        <div>
          <label class="block text-sm font-medium mb-2">Account Closure Date</label>
          <input id="editAccountClosureDate" type="date" class="w-full border border-gray-300 p-3 rounded-lg" readonly />
        </div>
        <div class="flex gap-4 pt-2">
          <button type="submit" class="barclays-btn px-6 py-3 rounded-lg font-medium">Save Changes</button>
          <button type="button" onclick="closeEditAccountModal()" class="barclays-secondary-btn px-6 py-3 rounded-lg font-medium">Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Admin Passkey Modal -->
  <div id="adminPasskeyModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-60 hidden">
    <div class="rounded-xl shadow-lg p-8 w-full max-w-xs relative" style="background: var(--barclays-surface); color: var(--barclays-text);">
      <h2 class="text-lg font-semibold mb-4 text-center">Admin Confirmation</h2>
      <p class="text-sm text-center text-muted mb-4">Please enter the admin passkey to proceed.</p>
      <form id="adminPasskeyForm">
        <input id="adminPasskeyInput" type="password" class="w-full border border-gray-300 p-3 rounded-lg mb-4" placeholder="Passkey" autofocus />
        <div id="adminPasskeyError" class="text-red-500 text-sm mt-2 text-center hidden mb-4">Incorrect passkey.</div>
        <div class="flex gap-4 justify-center">
          <button type="submit" class="barclays-btn px-4 py-2 rounded-lg font-medium">Submit</button>
          <button type="button" onclick="cancelAdminPasskey()" class="barclays-secondary-btn px-4 py-2 rounded-lg font-medium">Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Dedicated Sign In/Up Page (hidden by default) -->
  <div id="authPage" class="fixed inset-0 z-50 flex items-center justify-center hidden" style="background: var(--barclays-bg);">
    <div class="rounded-xl shadow-lg p-8 w-full max-w-md relative" style="background: var(--barclays-surface); color: var(--barclays-text);">
      <h2 id="authTitle" class="text-2xl font-semibold mb-4 text-center">Sign in to Barclays Network Management Portal</h2>
      <form id="authForm" onsubmit="signInUser(event)">
        <div class="mb-4">
          <label class="block text-sm font-medium mb-2">Email</label>
          <input id="authEmail" type="email" class="w-full border border-gray-300 p-3 rounded-lg" required />
        </div>
        <div class="mb-4">
          <label class="block text-sm font-medium mb-2">Password</label>
          <input id="authPassword" type="password" class="w-full border border-gray-300 p-3 rounded-lg" required />
        </div>
        <div class="flex gap-4 mb-4">
          <button id="authButton" type="submit" class="barclays-btn px-6 py-3 rounded-lg font-medium w-full">Sign In</button>
        </div>
      </form>
      <p class="text-center text-sm">
        <a href="#" id="authLink" onclick="toggleAuthMode(event)" class="text-blue-400 hover:underline">Don't have an account? Sign Up</a>
      </p>
    </div>
  </div>

  <!-- Edit/Approve Request Modal -->
  <div id="approveRequestModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-60 hidden">
    <div class="rounded-xl shadow-lg p-8 w-full max-w-xl relative overflow-y-auto" style="background: var(--barclays-surface); max-height: 90vh; color: var(--barclays-text);">
      <div class="flex items-center justify-between mb-6 sticky top-0 z-20" style="background: var(--barclays-surface); border-bottom: 1px solid #2A3A4D; box-shadow: 0 2px 8px 0 rgba(0,0,0,0.04); padding-bottom: 1rem;">
        <h2 class="text-2xl font-semibold text-header">Approve & Create Account</h2>
        <button onclick="closeApproveRequestModal()" class="text-gray-400 hover:text-gray-700 text-2xl">✖️</button>
      </div>
      <form id="approveRequestForm" class="grid grid-cols-1 md:grid-cols-2 gap-6"></form>
    </div>
  </div>
  <script>
  (function() {
    'use strict';

    // --- App Initialization ---
    function initApp() {
      // Enhanced splash screen logic
      const splash = document.getElementById('splashScreen');
      const mainContent = document.getElementById('mainContent');
      const header = document.querySelector('header');
      
      // Ensure splash screen is visible and main content is hidden
      if (splash) {
        splash.style.display = 'flex';
        splash.classList.remove('fade-out');
      }
      if (mainContent) mainContent.style.display = 'none';
      if (header) header.style.display = 'none';
      
      if (splash) {
        // Add entrance animation
        splash.style.opacity = '0';
        splash.style.transform = 'scale(0.9) rotate(-1deg)';
        setTimeout(() => {
          splash.style.opacity = '1';
          splash.style.transform = 'scale(1) rotate(0deg)';
        }, 100);
        
        // Enhanced exit animation with smoother timing
        setTimeout(() => {
          splash.classList.add('fade-out');
          setTimeout(() => {
            splash.style.display = 'none';
            // Show header and main content
            if (header) {
              header.style.display = 'block';
              header.style.opacity = '0';
              header.style.transform = 'translateY(-20px)';
              setTimeout(() => {
                header.style.transition = 'all 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94)';
                header.style.opacity = '1';
                header.style.transform = 'translateY(0)';
              }, 100);
            }
            if (mainContent) {
              mainContent.style.display = 'block';
              // Add entrance animation for main content
              mainContent.style.opacity = '0';
              mainContent.style.transform = 'translateY(30px)';
              setTimeout(() => {
                mainContent.style.transition = 'all 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94)';
                mainContent.style.opacity = '1';
                mainContent.style.transform = 'translateY(0)';
              }, 200);
            }
          }, 1200); // match enhanced fade-out transition
        }, 2500); // 2.5 seconds for better user experience
      }
      
      // Prevent form submission
      const accountForm = document.getElementById('accountForm');
      if (accountForm) {
        accountForm.addEventListener('submit', (e) => {
          e.preventDefault();
          return false;
        });
      }

      // Initialize default tab after a brief delay to ensure DOM is ready
      setTimeout(() => {
        showTab('workflow');
      }, 100);
      fetchNextAccountIdPreview(); // Fetch next Account ID preview on load
    }

    // --- Form Validation ---
    function validate(value, type) {
      const patterns = {
        email: /^[^\s@]+@[^\s@]+\.[^\s@]+$/,
        pan: /^[A-Z]{5}[0-9]{4}[A-Z]{1}$/,
        // LEI validation removed - users can enter any format as per their preference
      };
      if (type && patterns[type]) {
        return patterns[type].test(value);
      }
      return value && value.trim().length > 0;
    }

    function validateField(field) {
      const value = field.value.trim();
      let isValid = false;
      let customMessage = '';

      if (field.type === 'email') {
        if (value.length === 0) {
          isValid = false;
          customMessage = 'Contact Email is required';
        } else {
          isValid = validate(value, 'email');
          if (!isValid) {
            customMessage = 'Please enter a valid email address';
          }
        }
      } else if (field.id === 'panNumber' || field.id === 'editPanNumber') {
        isValid = validate(value, 'pan');
        if (!isValid && value.length > 0) {
          customMessage = 'PAN must be 5 uppercase letters, 4 digits, 1 uppercase letter (e.g. ABCDE1234F)';
        }
      } else if (field.id === 'leiNumber' || field.id === 'editLeiNumber') {
        if (value.length === 0) {
          isValid = false;
          customMessage = 'Legal Entity Identifier (LEI) is required';
        } else {
          // LEI validation removed - users can enter any format as per their preference
          isValid = true;
        }
      } else if (field.tagName === 'SELECT') {
        isValid = validate(field.value, null);
      } else if (field.id === 'accountName' || field.id === 'requestAgentBankName') {
        if (value.length === 0) {
          isValid = false;
          customMessage = 'Agent Bank Name is required';
        } else {
          isValid = validate(value, null);
          if (!isValid) {
            customMessage = 'Agent Bank Name is required';
          }
        }
      } else if (field.id === 'requestTeam') {
        if (value.length === 0) {
          isValid = false;
          customMessage = 'Team name is required';
        } else {
          isValid = validate(value, null);
          if (!isValid) {
            customMessage = 'Team name is required';
          }
        }
      } else if (field.id === 'requestDetails') {
        if (value.length === 0) {
          isValid = false;
          customMessage = 'Request details are required';
        } else {
          isValid = validate(value, null);
          if (!isValid) {
            customMessage = 'Request details are required';
          }
        }
      } else {
        isValid = validate(value, null);
        if (!isValid && value.length > 0) {
          customMessage = 'This field is required';
        }
      }
      
      field.setCustomValidity(customMessage);
      
      // Update border colors
      field.classList.remove('border-red-500', 'focus:ring-red-500', 'border-green-500', 'focus:ring-green-500', 'border-gray-300', 'focus:ring-blue-500');
      if (!isValid && (value.length > 0 || field.required)) {
        field.classList.add('border-red-500', 'focus:ring-red-500');
      } else if (isValid && value.length > 0) {
        field.classList.add('border-green-500', 'focus:ring-green-500');
      } else {
        field.classList.add('border-gray-300', 'focus:ring-blue-500');
      }
      
      // Show/hide inline validation messages
      const errorElement = document.getElementById(field.id + 'Error');
      const successElement = document.getElementById(field.id + 'Success');
      
      if (errorElement) {
        if (!isValid && (value.length > 0 || field.required)) {
          errorElement.textContent = customMessage;
          errorElement.classList.add('show');
        } else {
          errorElement.classList.remove('show');
        }
      }
      
      if (successElement) {
        if (isValid && value.length > 0) {
          successElement.textContent = 'Field is valid';
          successElement.classList.add('show');
        } else {
          successElement.classList.remove('show');
        }
      }
      
      return isValid;
    }

    function updateButtonState() {
      const nameField = document.getElementById('accountName');
      const typeField = document.getElementById('accountType');
      const emailField = document.getElementById('contactEmail');
      const leiField = document.getElementById('leiNumber');
      if (nameField) validateField(nameField);
      if (typeField) validateField(typeField);
      if (emailField) validateField(emailField);
      if (leiField) validateField(leiField);
      // Enable/disable Account Closure Date
      const statusField = document.getElementById('accountStatus');
      const closureDateField = document.getElementById('accountClosureDate');
      if (statusField && closureDateField) {
        closureDateField.disabled = statusField.value !== 'Closed';
      }
    }

    async function updateAccountIdPreview() {
      const typeField = document.getElementById('accountType');
      const idField = document.getElementById('accountId');
      if (!typeField || !idField) return;
      const type = typeField.value;
      if (type === 'Corporate') {
        idField.value = 'BARC-C0001';
      } else {
        idField.value = '';
      }
    }

    function showAccountTypeFields() {
      // Only GST for Corporate
      document.getElementById('leiField').classList.remove('hidden');
    }

    function showEditAccountTypeFields() {
      // Only GST for Corporate
      document.getElementById('editLeiField').classList.remove('hidden');
    }
    
    function clearAccountFormValidation() {
      const fields = ['accountName', 'accountType', 'contactEmail', 'panNumber', 'leiNumber'];
      fields.forEach(id => {
        const field = document.getElementById(id);
        if (field) {
          field.classList.remove('border-red-500', 'focus:ring-red-500', 'border-green-500', 'focus:ring-green-500');
          field.classList.add('border-gray-300');
          
          // Clear inline validation messages
          const errorElement = document.getElementById(id + 'Error');
          const successElement = document.getElementById(id + 'Success');
          
          if (errorElement) {
            errorElement.classList.remove('show');
            errorElement.textContent = '';
          }
          
          if (successElement) {
            successElement.classList.remove('show');
            successElement.textContent = '';
          }
        }
      });
    }

    // --- Firebase & Core App State ---
    const firebaseConfig = {
      apiKey: "AIzaSyCgK8fg7tXgaU-0oWcCGO9bdHWnwImLBmQ",
      authDomain: "barclays-network-management.firebaseapp.com",
      projectId: "barclays-network-management",
      storageBucket: "barclays-network-management.firebasestorage.app",
      messagingSenderId: "308811523712",
      appId: "1:308811523712:web:69e0bc7919d1057cbc2865",
      measurementId: "G-X0HKTS2D3E"
    };

    let db, auth;
    let firebaseInitialized = false;
    let currentUser = null;
    let justSignedUp = false; 

    try {
      firebase.initializeApp(firebaseConfig);
      db = firebase.firestore();
      auth = firebase.auth();
      firebaseInitialized = true;
      console.log('✅ Firebase initialized successfully');
    } catch (error) {
      console.error('❌ Firebase initialization failed:', error);
    }

    if (firebaseInitialized) {
      auth.onAuthStateChanged(async (user) => {
        if (justSignedUp) {
          if (user) { return; } 
          else { justSignedUp = false; }
        }
        currentUser = user;
        let isAdmin = false;
        if (user) {
          try {
            const userDoc = await db.collection('users').doc(user.uid).get();
            console.log('Auth user:', user);
            console.log('Firestore userDoc:', userDoc.exists ? userDoc.data() : 'No doc');
            isAdmin = userDoc.exists && userDoc.data().role === 'admin';
            console.log('isAdmin:', isAdmin);
          } catch (e) {
            isAdmin = false;
            console.error('Error fetching user doc:', e);
          }
        }
        updateAuthUI(user, isAdmin);
      });
    }

    // --- Auditing ---
    async function logAudit(action, details) {
      if (!db) {
        console.error("Audit Log: Firestore not initialized.");
        return;
      }
      try {
        const userEmail = (currentUser && currentUser.email) ? currentUser.email : 'anonymous';
        await db.collection('audit_logs').add({
          action: action,
          user: userEmail,
          timestamp: firebase.firestore.FieldValue.serverTimestamp(),
          details: details
        });
      } catch (error) {
        console.error("Failed to write audit log:", error);
      }
    }

    // --- Admin & Security ---
    const ADMIN_PASSKEY = "barclays2024";
    let passkeyResolve = null;

    function requestAdminPasskey() {
      return new Promise((resolve) => {
        passkeyResolve = resolve;
        const modal = document.getElementById('adminPasskeyModal');
        const input = document.getElementById('adminPasskeyInput');
        const error = document.getElementById('adminPasskeyError');
        input.value = '';
        error.classList.add('hidden');
        modal.classList.add('modal-top'); // Ensure on top
        modal.classList.remove('hidden');
        setTimeout(() => input.focus(), 100);
      });
    }

    function cancelAdminPasskey() {
      if (passkeyResolve) passkeyResolve(false);
      passkeyResolve = null;
      const modal = document.getElementById('adminPasskeyModal');
      modal.classList.remove('modal-top'); // Remove on close
      modal.classList.add('hidden');
    }
    
    document.getElementById('adminPasskeyForm').addEventListener('submit', function(e) {
      e.preventDefault();
      const input = document.getElementById('adminPasskeyInput').value;
      const modal = document.getElementById('adminPasskeyModal');
      if (input === ADMIN_PASSKEY) {
        if (passkeyResolve) passkeyResolve(true);
        passkeyResolve = null;
        modal.classList.remove('modal-top'); // Remove on close
        modal.classList.add('hidden');
      } else {
        const error = document.getElementById('adminPasskeyError');
        error.classList.remove('hidden');
      }
    });

    // --- Button Loading State Management ---
    function setButtonLoadingState(buttonId, isLoading, loadingText = null, originalText = null) {
      const button = document.getElementById(buttonId);
      if (!button) return;
      
      if (isLoading) {
        button.disabled = true;
        button.classList.add('opacity-75', 'cursor-not-allowed');
        
        // Find or create loader element
        let loader = button.querySelector('.loading');
        if (!loader) {
          loader = document.createElement('div');
          loader.className = 'loading visible';
          button.appendChild(loader);
        } else {
          loader.classList.add('visible');
        }
        
        // Update text if provided
        if (loadingText) {
          const textSpan = button.querySelector('span') || button;
          if (textSpan !== button) {
            textSpan.textContent = loadingText;
          } else {
            button.textContent = loadingText;
          }
        }
      } else {
        button.disabled = false;
        button.classList.remove('opacity-75', 'cursor-not-allowed');
        
        // Hide loader
        const loader = button.querySelector('.loading');
        if (loader) {
          loader.classList.remove('visible');
        }
        
        // Restore original text if provided
        if (originalText) {
          const textSpan = button.querySelector('span') || button;
          if (textSpan !== button) {
            textSpan.textContent = originalText;
          } else {
            button.textContent = originalText;
          }
        }
      }
    }

    // --- Progress Indicator Functions ---
    function updateProgress(percentage, message = '') {
      const progressFill = document.getElementById('progressFill');
      const progressPercentage = document.getElementById('progressPercentage');
      
      if (progressFill) {
        progressFill.style.width = percentage + '%';
      }
      
      if (progressPercentage) {
        progressPercentage.textContent = percentage + '%';
      }
      
      if (message) {
        const progressTitle = document.querySelector('.progress-title');
        if (progressTitle) {
          progressTitle.textContent = message;
        }
      }
    }

    function updateProgressStep(stepNumber, status) {
      const stepElement = document.getElementById(`step${stepNumber}`);
      if (!stepElement) return;
      
      // Remove all status classes
      stepElement.classList.remove('active', 'completed');
      
      // Add the new status class
      if (status === 'active') {
        stepElement.classList.add('active');
      } else if (status === 'completed') {
        stepElement.classList.add('completed');
      }
    }

    function resetProgressSteps() {
      for (let i = 1; i <= 4; i++) {
        const stepElement = document.getElementById(`step${i}`);
        if (stepElement) {
          stepElement.classList.remove('active', 'completed');
        }
      }
    }

    function updateFileStatus(fileId, input) {
      const statusDiv = document.getElementById(fileId.replace('csvFile', 'file') + 'Status');
      const infoSpan = document.getElementById(fileId.replace('csvFile', 'file') + 'Info');
      
      if (input.files && input.files[0]) {
        const file = input.files[0];
        const fileSize = (file.size / 1024).toFixed(1); // KB
        const fileName = file.name;
        
        statusDiv.classList.remove('hidden');
        infoSpan.textContent = `${fileName} (${fileSize} KB)`;
        
        // Update upload progress
        updateUploadProgress();
      } else {
        statusDiv.classList.add('hidden');
      }
    }

    function updateUploadProgress() {
      const fileA = document.getElementById('csvFileA').files[0];
      const fileB = document.getElementById('csvFileB').files[0];
      const progressDiv = document.getElementById('fileUploadProgress');
      const progressFill = document.getElementById('uploadProgressFill');
      const progressPercentage = document.getElementById('uploadProgressPercentage');
      
      let progress = 0;
      let steps = 0;
      
      if (fileA) {
        progress += 33;
        steps++;
        updateUploadStep(1, 'completed');
      } else {
        updateUploadStep(1, '');
      }
      
      if (fileB) {
        progress += 33;
        steps++;
        updateUploadStep(2, 'completed');
      } else {
        updateUploadStep(2, '');
      }
      
      if (fileA && fileB) {
        progress += 34;
        updateUploadStep(3, 'active');
        progressDiv.classList.remove('hidden');
      } else {
        updateUploadStep(3, '');
        progressDiv.classList.add('hidden');
      }
      
      if (progressFill) progressFill.style.width = progress + '%';
      if (progressPercentage) progressPercentage.textContent = progress + '%';
    }

    function updateUploadStep(stepNumber, status) {
      const stepElement = document.getElementById(`uploadStep${stepNumber}`);
      if (!stepElement) return;
      
      stepElement.classList.remove('active', 'completed');
      
      if (status === 'active') {
        stepElement.classList.add('active');
      } else if (status === 'completed') {
        stepElement.classList.add('completed');
      }
    }

    // --- Account Management Functions ---
    async function generateAccountIdAndSave() {
      const createBtn = document.getElementById('createAccountBtn');
      const createBtnText = document.getElementById('createBtnText');
      const createBtnLoader = document.getElementById('createBtnLoader');
      try {
        const name = document.getElementById('accountName').value.trim();
        const email = document.getElementById('contactEmail').value.trim();
        const lei = document.getElementById('leiNumber').value.trim();
        // Removed subLedger and reconciliationSetup references
        // Set status and opening date automatically
        const status = 'Active';
        const accountOpeningDate = new Date();
        const accountClosureDate = null;
        let details = `Please confirm the account details:\n\nAgent Bank: ${name}\nEmail: ${email}\nLEI: ${lei}`;
        if (!window.confirm(details + '\nDo you want to proceed?')) {
          return;
        }
        
        // Set loading state
        setButtonLoadingState('createAccountBtn', true, 'Creating...', 'Create Account');
        
        if (!name || name.length === 0) throw new Error('Agent Bank Name is required');
        if (!email || email.length === 0) throw new Error('Contact Email is required');
        if (!validate(email, 'email')) throw new Error('Please enter a valid email address');
        if (!lei || lei.length === 0) throw new Error('Legal Entity Identifier (LEI) is required');
        if (!db) { showToast('Database not initialized!', 'error'); throw new Error('Firebase DB not initialized!'); }
        const existingEmail = await db.collection('accounts').where('email', '==', email).get();
        if (!existingEmail.empty) {
          showToast('Email address already registered', 'error');
          throw new Error('Email address already registered');
        }
        let newAccountId = '';
        const counterDocId = 'corporate_accounts';
        const prefix = 'BARC-C';
        await db.runTransaction(async (transaction) => {
          const counterRef = db.collection('counters').doc(counterDocId);
          const counterDoc = await transaction.get(counterRef);
          let nextId = 1;
          if (counterDoc.exists && counterDoc.data().nextId) {
            nextId = counterDoc.data().nextId;
            newAccountId = prefix + String(nextId).padStart(4, '0');
            transaction.update(counterRef, { nextId: nextId + 1 });
          } else {
            newAccountId = prefix + '0001';
            transaction.set(counterRef, { nextId: 2 });
          }
        });
        const account = {
          name, id: newAccountId, email, lei: lei || '', status,
          accountOpeningDate: accountOpeningDate,
          accountClosureDate: accountClosureDate,
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          createdBy: currentUser ? currentUser.uid : 'anonymous',
          lastModified: firebase.firestore.FieldValue.serverTimestamp(),
          
          // Enhanced Unified Data Model Fields
          lifecycleStatus: 'Account Created', // Status in the lifecycle chain
          requestId: null, // Link to originating request (if any)
          workflowStatus: 'In Workflow', // Status in workflow processing
          statusHistory: [
            {
              status: 'Account Created',
              timestamp: new Date(), // Use new Date() instead of serverTimestamp in arrays
              triggeredBy: currentUser ? currentUser.uid : 'anonymous',
              source: 'Account Management',
              notes: 'Account created via Account Management'
            }
          ],
          crossReferences: {
            requestId: null, // Will be populated if created from request
            workflowId: newAccountId, // Same as account ID for workflow tracking
            processedBy: []
          }
        };
        // Use Account ID as Firestore document ID
        try {
          await db.collection('accounts').doc(newAccountId).set(account);
        } catch (error) {
          if (error.code === 'already-exists') {
            showToast('Account ID already exists. Please try again.', 'error');
            throw error;
          } else {
            throw error;
          }
        }
        await logAudit('create_account', { accountId: newAccountId, data: account });
        
        // Add account to workflow pending table
        const workflowRow = await addAccountToWorkflowTable({
          name: account.name,
          id: account.id,
          lei: account.lei,
          status: account.status
        });
        
        showToast('Account created successfully and added to workflow!', 'success');
        
        // Show additional notification with workflow navigation option
        setTimeout(() => {
          const workflowNotification = document.createElement('div');
          workflowNotification.className = 'fixed bottom-4 right-4 p-4 rounded-lg shadow-lg z-50 border-l-4 border-blue-500';
          workflowNotification.style.background = 'var(--barclays-surface)';
          workflowNotification.style.color = 'var(--barclays-text)';
          workflowNotification.innerHTML = `
            <div class="flex items-center gap-3">
              <div class="flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="barclays-icon text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                <span class="text-sm font-medium">Account added to Workflow tab</span>
              </div>
              <div class="flex gap-2">
                <button onclick="showTab('workflow'); this.parentElement.parentElement.parentElement.remove();" class="barclays-btn px-3 py-1 text-xs rounded">
                  View in Workflow
                </button>
                <button onclick="this.parentElement.parentElement.parentElement.remove();" class="text-gray-400 hover:text-gray-600 text-lg">×</button>
              </div>
            </div>
          `;
          document.body.appendChild(workflowNotification);
          
          // Auto-remove after 8 seconds
          setTimeout(() => {
            if (workflowNotification.parentElement) {
              workflowNotification.remove();
            }
          }, 8000);
        }, 1000);
        // Checkmark animation before reset
        const form = document.getElementById('accountForm');
        let checkmark = document.createElement('span');
        checkmark.textContent = '✅';
        checkmark.style.fontSize = '2em';
        checkmark.style.display = 'block';
        checkmark.style.textAlign = 'center';
        checkmark.style.opacity = '0';
        checkmark.style.transition = 'opacity 0.2s, transform 0.4s';
        form.parentNode.insertBefore(checkmark, form);
        setTimeout(() => {
          checkmark.style.opacity = '1';
          checkmark.style.transform = 'scale(1.3)';
        }, 10);
        setTimeout(() => {
          if (checkmark && checkmark.parentNode) checkmark.parentNode.removeChild(checkmark);
          form.reset();
          clearAccountFormValidation();
          document.getElementById('accountId').value = '';
          fetchNextAccountIdPreview(); // Update preview after creation
        }, 600);
        if (!document.getElementById('accountsSection').classList.contains('hidden')) {
          // Optionally refresh account list
        }
      } catch (error) {
        showToast(error && error.message ? error.message : 'An unknown error occurred.', 'error');
        console.error('Error in generateAccountIdAndSave:', error);
      } finally {
        setButtonLoadingState('createAccountBtn', false, null, 'Create Account');
      }
    }

    async function promptAccess() {
      setButtonLoadingState('viewAccountsBtn', true, 'Verifying...', 'View Stored Accounts');
      try {
        const confirmed = await requestAdminPasskey();
        if (!confirmed) return;
        var section = document.getElementById('accountsSection');
        if (section) {
          section.classList.remove('hidden');
          section.scrollIntoView({ behavior: 'smooth' });
        }
        if (typeof refreshAccounts === 'function') {
          refreshAccounts();
        }
      } catch (error) {
        showToast('Access verification failed', 'error');
        console.error('Error in promptAccess:', error);
      } finally {
        setButtonLoadingState('viewAccountsBtn', false, null, 'View Stored Accounts');
      }
    }

    const ACCOUNTS_PAGE_SIZE = 10;
    let accountsLastVisible = null;
    let accountsCurrentPageStart = null;
    let accountsPrevPageStarts = [];
    
    // Table sorting and filtering variables
    let allAccountsData = [];
    let filteredAccountsData = [];
    let currentSortColumn = '';
    let currentSortDirection = 'asc';
    let currentFilters = {
      status: '',
      reconciliation: '',
      search: ''
    };
    // Consolidated table sorting variables
    let consolidatedTableData = [];
    let consolidatedCurrentSortColumn = '';
    let consolidatedCurrentSortDirection = 'asc';

    async function refreshAccounts(startAfterDoc = null) {
      const tbody = document.getElementById('accountListBody');
      const nextBtn = document.getElementById('accountsNextBtn');
      const prevBtn = document.getElementById('accountsNextBtn');
      const table = document.getElementById('accountList');
      const pagination = document.getElementById('accountsPagination');
      const noDataMessage = document.getElementById('noAccountsMessage');
      if (!tbody) return;
      
      // Set loading state for refresh button if it exists
      const refreshBtn = document.querySelector('button[onclick="refreshAccounts()"]');
      if (refreshBtn) {
        setButtonLoadingState(refreshBtn.id || 'refreshAccountsBtn', true, 'Loading...', 'Refresh');
      }
      
      // Show loading state
      table.classList.remove('hidden');
      pagination.classList.remove('hidden');
      noDataMessage.classList.add('hidden');
      tbody.innerHTML = `<tr class="skeleton-table-row">
        <td colspan="10">
          <div class="flex space-x-2">
            <div class="skeleton" style="width: 80px; height: 20px;"></div>
            <div class="skeleton" style="width: 100px; height: 20px;"></div>
            <div class="skeleton" style="width: 120px; height: 20px;"></div>
            <div class="skeleton" style="width: 80px; height: 20px;"></div>
            <div class="skeleton" style="width: 80px; height: 20px;"></div>
            <div class="skeleton" style="width: 100px; height: 20px;"></div>
            <div class="skeleton" style="width: 80px; height: 20px;"></div>
            <div class="skeleton" style="width: 120px; height: 20px;"></div>
            <div class="skeleton" style="width: 120px; height: 20px;"></div>
            <div class="skeleton" style="width: 100px; height: 20px;"></div>
          </div>
        </td>
      </tr>`;
      
      if(nextBtn) nextBtn.disabled = true;
      if(prevBtn) prevBtn.disabled = true;
      accountsCurrentPageStart = startAfterDoc;
      
      try {
        // Load all accounts data for filtering and sorting
        const snapshot = await db.collection('accounts').orderBy('createdAt', 'desc').get();
        
        if (snapshot.empty && !startAfterDoc) {
          table.classList.add('hidden');
          pagination.classList.add('hidden');
          noDataMessage.classList.remove('hidden');
          allAccountsData = [];
          filteredAccountsData = [];
          return;
        }
        
        // Convert snapshot to array and store in allAccountsData
        allAccountsData = [];
        snapshot.forEach(doc => {
          const acc = doc.data();
          allAccountsData.push({
            ...acc,
            docId: doc.id
          });
        });
        
        // Apply current filters and sorting
        filteredAccountsData = [...allAccountsData];
        if (Object.values(currentFilters).some(filter => filter !== '')) {
          filterAccountsData();
        }
        
        // Render the table
        renderAccountsTable();
        
        // Update pagination buttons (disabled for now since we're showing all data)
        if (nextBtn) nextBtn.disabled = true;
        if (prevBtn) prevBtn.disabled = true;
        
      } catch (error) {
        if (error.code === 'permission-denied') {
          tbody.innerHTML = '<tr><td colspan="10" class="p-4 text-center text-red-500">Access Denied. You do not have permission to view accounts.</td></tr>';
        } else {
          tbody.innerHTML = '<tr><td colspan="10" class="p-4 text-center text-red-500">Failed to load accounts.</td></tr>';
        }
        console.error('Error loading accounts:', error);
      } finally {
        // Restore loading state for refresh button
        const refreshBtn = document.querySelector('button[onclick="refreshAccounts()"]');
        if (refreshBtn) {
          setButtonLoadingState(refreshBtn.id || 'refreshAccountsBtn', false, null, 'Refresh');
        }
      }
    }

    function nextAccountsPage() {
      if (accountsLastVisible) {
        accountsPrevPageStarts.push(accountsCurrentPageStart);
        refreshAccounts(accountsLastVisible);
      }
    }

    function prevAccountsPage() {
      const prevStart = accountsPrevPageStarts.pop();
      refreshAccounts(prevStart);
    }
    
    async function openEditAccountModal(accountId) {
      try {
        const doc = await db.collection('accounts').doc(accountId).get();
        if (!doc.exists) {
          showToast('Account not found.', 'error');
          return;
        }
        const acc = doc.data();
        document.getElementById('editAccountId').value = accountId;
        document.getElementById('editAccountName').value = acc.name || '';
        document.getElementById('editAccountStatus').value = acc.status || 'Active';
        document.getElementById('editLeiNumber').value = acc.lei || '';
        document.getElementById('editAccountOpeningDate').value = acc.accountOpeningDate ? (acc.accountOpeningDate.toDate ? acc.accountOpeningDate.toDate().toISOString().split('T')[0] : new Date(acc.accountOpeningDate).toISOString().split('T')[0]) : '';
        document.getElementById('editAccountClosureDate').value = acc.accountClosureDate ? (acc.accountClosureDate.toDate ? acc.accountClosureDate.toDate().toISOString().split('T')[0] : new Date(acc.accountClosureDate).toISOString().split('T')[0]) : '';
        showModal('editAccountModal');
      } catch (error) {
        showToast('Failed to load account for editing.', 'error');
        console.error(error);
      }
    }

    function closeEditAccountModal() {
      hideModal('editAccountModal');
    }

    async function saveEditAccount(event) {
      event.preventDefault();
      
      // Find the save button and set loading state
      const saveBtn = document.querySelector('#editAccountModal button[type="submit"]');
      if (saveBtn) {
        setButtonLoadingState(saveBtn.id || 'saveEditAccountBtn', true, 'Saving...', 'Save Changes');
      }
      
      try {
        const confirmed = await requestAdminPasskey();
        if (!confirmed) return;
        
        const accountId = document.getElementById('editAccountId').value;
        const name = document.getElementById('editAccountName').value.trim();
        const status = document.getElementById('editAccountStatus').value;
        const lei = document.getElementById('editLeiNumber').value.trim();
        const accountOpeningDate = document.getElementById('editAccountOpeningDate').value;
        let accountClosureDate = document.getElementById('editAccountClosureDate').value;
        // If status is set to Closed, set closure date to now
        if (status === 'Closed') {
          const now = new Date();
          accountClosureDate = now.toISOString(); // full ISO string for Firestore
          document.getElementById('editAccountClosureDate').value = now.toISOString().split('T')[0]; // only date for input
        } else {
          accountClosureDate = '';
          document.getElementById('editAccountClosureDate').value = '';
        }
        
        const updateData = {
          name, status, lei,
          accountOpeningDate: accountOpeningDate ? new Date(accountOpeningDate) : null,
          accountClosureDate: accountClosureDate ? new Date(accountClosureDate) : null,
          lastModified: firebase.firestore.FieldValue.serverTimestamp()
        };
        await db.collection('accounts').doc(accountId).update(updateData);
        await logAudit('update_account', { accountId: accountId, changes: updateData });
        showToast('Account updated successfully!', 'success');
        closeEditAccountModal();
        refreshAccounts();
      } catch (error) {
        if (error.code === 'permission-denied') {
            showToast('Access Denied. You do not have permission to edit accounts.', 'error');
        } else {
            showToast('Failed to update account.', 'error');
        }
        console.error(error);
      } finally {
        // Restore loading state
        if (saveBtn) {
          setButtonLoadingState(saveBtn.id || 'saveEditAccountBtn', false, null, 'Save Changes');
        }
      }
    }
    document.getElementById('editAccountForm').onsubmit = saveEditAccount;

    // --- Table Sorting and Filtering Functions ---
    
    function sortTable(column) {
      const table = document.getElementById('accountList');
      const thead = table.querySelector('thead');
      const headers = thead.querySelectorAll('th.sortable');
      
      // Remove existing sort classes
      headers.forEach(header => {
        header.classList.remove('sort-asc', 'sort-desc');
      });
      
      // Toggle sort direction if same column
      if (currentSortColumn === column) {
        currentSortDirection = currentSortDirection === 'asc' ? 'desc' : 'asc';
      } else {
        currentSortDirection = 'asc';
        currentSortColumn = column;
      }
      
      // Add sort class to current header
      const currentHeader = thead.querySelector(`[data-sort="${column}"]`);
      if (currentHeader) {
        currentHeader.classList.add(`sort-${currentSortDirection}`);
      }
      
      // Sort the filtered data
      sortAccountsData();
      renderAccountsTable();
    }
    
    function sortAccountsData() {
      if (!filteredAccountsData.length) return;
      
      filteredAccountsData.sort((a, b) => {
        let aVal = a[currentSortColumn] || '';
        let bVal = b[currentSortColumn] || '';
        
        // Handle date sorting
        if (currentSortColumn === 'accountOpeningDate' || currentSortColumn === 'accountClosureDate') {
          aVal = aVal ? new Date(aVal) : new Date(0);
          bVal = bVal ? new Date(bVal) : new Date(0);
        } else {
          // String sorting (case-insensitive)
          aVal = String(aVal).toLowerCase();
          bVal = String(bVal).toLowerCase();
        }
        
        if (aVal < bVal) return currentSortDirection === 'asc' ? -1 : 1;
        if (aVal > bVal) return currentSortDirection === 'asc' ? 1 : -1;
        return 0;
      });
    }
    
    function applyFilters() {
      const statusFilter = document.getElementById('statusFilter').value;
      const reconciliationFilter = document.getElementById('reconciliationFilter').value;
      const searchFilter = document.getElementById('searchFilter').value.toLowerCase();
      
      currentFilters = {
        status: statusFilter,
        reconciliation: reconciliationFilter,
        search: searchFilter
      };
      
      filterAccountsData();
      renderAccountsTable();
    }
    
    function filterAccountsData() {
      filteredAccountsData = allAccountsData.filter(account => {
        // Status filter (case-insensitive)
        if (currentFilters.status && account.status && 
            account.status.toLowerCase() !== currentFilters.status.toLowerCase()) {
          return false;
        }
        
        // Reconciliation filter (case-insensitive)
        if (currentFilters.reconciliation && account.reconciliationSetup && 
            account.reconciliationSetup.toLowerCase() !== currentFilters.reconciliation.toLowerCase()) {
          return false;
        }
        
        // Search filter
        if (currentFilters.search) {
          const searchTerm = currentFilters.search.toLowerCase();
          const searchableFields = [
            account.name || '',
            account.id || '',
            account.email || '',
            account.lei || '',
          ];
          
          if (!searchableFields.some(field => field.toLowerCase().includes(searchTerm))) {
            return false;
          }
        }
        
        return true;
      });
      
      // Apply current sort
      if (currentSortColumn) {
        sortAccountsData();
      }
    }
    
    function clearFilters() {
      document.getElementById('statusFilter').value = '';
      document.getElementById('reconciliationFilter').value = '';
      document.getElementById('searchFilter').value = '';
      
      currentFilters = {
        status: '',
        reconciliation: '',
        search: ''
      };
      
      filteredAccountsData = [...allAccountsData];
      renderAccountsTable();
    }
    
    function renderAccountsTable() {
      const tbody = document.getElementById('accountListBody');
      if (!tbody) return;
      
      if (filteredAccountsData.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="10" class="text-center py-8 text-barclays-muted">
              <div class="flex flex-col items-center">
                <span style="font-size: 2em; margin-bottom: 8px;">🔍</span>
                <p class="text-lg">No accounts found matching your filters</p>
                <button onclick="clearFilters()" class="barclays-btn px-4 py-2 rounded-lg mt-4">
                  Clear Filters
                </button>
              </div>
            </td>
          </tr>
        `;
        return;
      }
      
      let rows = '';
      filteredAccountsData.forEach(account => {
        // Enhanced rendering with cross-reference information
        const hasRequestLink = account.requestId;
        const rowClass = hasRequestLink ? 'bg-blue-50 border-l-4 border-blue-500' : '';
        const sourceIcon = hasRequestLink ? '📋' : '➕';
        const sourceText = hasRequestLink ? 'From Request' : 'Direct Creation';
        
        rows += `
          <tr class="${rowClass}" data-account-id="${account.id}">
            <td>
              <div class="flex items-center gap-2">
                <span>${sourceIcon}</span>
                <div>
                  <div>${account.name || ''}</div>
                  <div class="text-xs text-gray-500 mt-1">${sourceText}</div>
                </div>
              </div>
            </td>
            <td>
              <div>${account.id || ''}</div>
              ${hasRequestLink ? `
                <div class="text-xs text-blue-600 mt-1">
                  <button onclick="showAccountRequestConnection('${account.requestId}')" class="underline hover:no-underline" title="View original request">
                    From request: ${account.requestId.substring(0, 8)}...
                  </button>
                </div>
              ` : ''}
            </td>
            <td>${account.email || ''}</td>
            <td>${account.lei || ''}</td>
            <td>
              <div>${renderStatusTag(account.status)}</div>
              ${account.lifecycleStatus ? `
                <div class="text-xs text-purple-600 mt-1">Lifecycle: ${account.lifecycleStatus}</div>
              ` : ''}
              ${account.workflowStatus ? `
                <div class="text-xs ${account.workflowStatus === 'Processed' ? 'text-yellow-600' : 'text-green-600'} mt-1">Workflow: ${account.workflowStatus}</div>
              ` : ''}
              ${account.lifecycleStatus === 'Processed' && account.processedAt ? `
                <div class="text-xs text-yellow-600 mt-1 flex items-center gap-1">
                  <span>🎯</span>
                  <span>Fully Processed</span>
                </div>
              ` : ''}
            </td>
            <td>${account.accountOpeningDate ? (account.accountOpeningDate.toDate ? account.accountOpeningDate.toDate().toLocaleString() : new Date(account.accountOpeningDate).toLocaleString()) : ''}</td>
            <td>${account.accountClosureDate ? (account.accountClosureDate.toDate ? account.accountClosureDate.toDate().toLocaleString() : new Date(account.accountClosureDate).toLocaleString()) : ''}</td>
            <td class="text-center">
              <div class="flex flex-col gap-1">
                <button onclick="openEditAccountModal('${account.docId}')" class="barclays-secondary-btn px-2 py-1 text-xs rounded">Edit</button>
                <button onclick="viewAccountTimeline('${account.id}')" class="barclays-secondary-btn px-2 py-1 text-xs rounded" title="View account timeline">Timeline</button>
                <button onclick="deleteAccount('${account.docId}')" class="bg-red-600 text-white px-2 py-1 text-xs rounded hover:bg-red-700">Delete</button>
              </div>
            </td>
          </tr>
        `;
      });
      tbody.innerHTML = rows;
    }
    
    function renderStatusTag(status) {
      const statusClass = status ? `status-${status.toLowerCase()}` : 'status-inactive';
      return `<span class="status-badge ${statusClass}">${status || 'Unknown'}</span>`;
    }
    
    // Reconciliation table sorting
    function sortReconciliationTable(column) {
      // Implementation for reconciliation table sorting
      console.log('Sorting reconciliation table by:', column);
    }
    
    // Account Request table sorting and filtering variables
    let allRequestData = [];
    let filteredRequestData = [];
    let currentRequestSortColumn = '';
    let currentRequestSortDirection = 'asc';
    let currentRequestFilters = {
      status: '',
      type: '',
      search: ''
    };
    
    function sortRequestTable(column) {
      const table = document.querySelector('#accountrequest table');
      const thead = table.querySelector('thead');
      const headers = thead.querySelectorAll('th.sortable');
      
      // Remove existing sort classes
      headers.forEach(header => {
        header.classList.remove('sort-asc', 'sort-desc');
      });
      
      // Toggle sort direction if same column
      if (currentRequestSortColumn === column) {
        currentRequestSortDirection = currentRequestSortDirection === 'asc' ? 'desc' : 'asc';
      } else {
        currentRequestSortDirection = 'asc';
        currentRequestSortColumn = column;
      }
      
      // Add sort class to current header
      const currentHeader = thead.querySelector(`[data-sort="${column}"]`);
      if (currentHeader) {
        currentHeader.classList.add(`sort-${currentRequestSortDirection}`);
      }
      
      // Sort the filtered data
      sortRequestData();
      renderRequestTable();
    }
    
    function sortRequestData() {
      if (!filteredRequestData.length) return;
      
      filteredRequestData.sort((a, b) => {
        let aVal = a[currentRequestSortColumn] || '';
        let bVal = b[currentRequestSortColumn] || '';
        
        // Handle date sorting
        if (currentRequestSortColumn === 'submittedAt') {
          aVal = aVal ? new Date(aVal) : new Date(0);
          bVal = bVal ? new Date(bVal) : new Date(0);
        } else {
          // String sorting (case-insensitive)
          aVal = String(aVal).toLowerCase();
          bVal = String(bVal).toLowerCase();
        }
        
        if (aVal < bVal) return currentRequestSortDirection === 'asc' ? -1 : 1;
        if (aVal > bVal) return currentRequestSortDirection === 'asc' ? 1 : -1;
        return 0;
      });
    }
    
    function applyRequestFilters() {
      const statusFilter = document.getElementById('requestStatusFilter').value;
      const typeFilter = document.getElementById('requestTypeFilter').value;
      const searchFilter = document.getElementById('requestSearchFilter').value.toLowerCase();
      
      currentRequestFilters = {
        status: statusFilter,
        type: typeFilter,
        search: searchFilter
      };
      
      filterRequestData();
      renderRequestTable();
    }
    
    function filterRequestData() {
      console.log('Filtering with:', currentRequestFilters);
      filteredRequestData = allRequestData.filter(request => {
        // Status filter (case-insensitive)
        if (currentRequestFilters.status && request.status && 
            request.status.toLowerCase() !== currentRequestFilters.status.toLowerCase()) {
          console.log('Filtered out:', request.status, 'vs', currentRequestFilters.status);
          return false;
        }
        
        // Type filter (case-insensitive)
        if (currentRequestFilters.type && request.type && 
            request.type.toLowerCase() !== currentRequestFilters.type.toLowerCase()) {
          console.log('Filtered out by type:', request.type, 'vs', currentRequestFilters.type);
          return false;
        }
        
        // Search filter
        if (currentRequestFilters.search) {
          const searchTerm = currentRequestFilters.search.toLowerCase();
          const searchableFields = [
            request.type || '',
            request.team || '',
            request.email || '',
            request.accountId || '',
            request.details || ''
          ];
          
          if (!searchableFields.some(field => field.toLowerCase().includes(searchTerm))) {
            return false;
          }
        }
        
        return true;
      });
      
      // Apply current sort
      if (currentRequestSortColumn) {
        sortRequestData();
      }
    }
    
    function clearRequestFilters() {
      document.getElementById('requestStatusFilter').value = '';
      document.getElementById('requestTypeFilter').value = '';
      document.getElementById('requestSearchFilter').value = '';
      
      currentRequestFilters = {
        status: '',
        type: '',
        search: ''
      };
      
      filteredRequestData = [...allRequestData];
    }
    
    // Consolidated table sorting function
    function sortConsolidatedTable(column) {
      const table = document.getElementById('consolidatedDataTable');
      const thead = table.querySelector('thead');
      const headers = thead.querySelectorAll('th.sortable');
      
      // Remove existing sort classes
      headers.forEach(header => {
        header.classList.remove('sort-asc', 'sort-desc');
      });
      
      // Toggle sort direction if same column
      if (consolidatedCurrentSortColumn === column) {
        consolidatedCurrentSortDirection = consolidatedCurrentSortDirection === 'asc' ? 'desc' : 'asc';
      } else {
        consolidatedCurrentSortDirection = 'asc';
        consolidatedCurrentSortColumn = column;
      }
      
      // Add sort class to current header
      const currentHeader = thead.querySelector(`[data-sort="${column}"]`);
      if (currentHeader) {
        currentHeader.classList.add(`sort-${consolidatedCurrentSortDirection}`);
        // Update header text to show sort direction
        if (column === 'ClientID_Forex') {
          currentHeader.innerHTML = `ClientID_Forex ${consolidatedCurrentSortDirection === 'asc' ? '↑' : '↓'}`;
        } else if (column === 'Counterparty') {
          currentHeader.innerHTML = `Counterparty ${consolidatedCurrentSortDirection === 'asc' ? '↑' : '↓'}`;
        } else if (column === 'id') {
          currentHeader.innerHTML = `id ${consolidatedCurrentSortDirection === 'asc' ? '↑' : '↓'}`;
        }
      }
      
      // Sort the consolidated data
      sortConsolidatedData();
      renderConsolidatedTable();
    }
    
    function sortConsolidatedData() {
      if (!consolidatedTableData.length) return;
      
      consolidatedTableData.sort((a, b) => {
        let aVal = a[consolidatedCurrentSortColumn] || '';
        let bVal = b[consolidatedCurrentSortColumn] || '';
        
        // String sorting (case-insensitive)
        aVal = String(aVal).toLowerCase();
        bVal = String(bVal).toLowerCase();
        
        if (aVal < bVal) return consolidatedCurrentSortDirection === 'asc' ? -1 : 1;
        if (aVal > bVal) return consolidatedCurrentSortDirection === 'asc' ? 1 : -1;
        return 0;
      });
    }
    
    function renderConsolidatedTable() {
      const consolidatedDataBody = document.getElementById('consolidatedDataBody');
      if (!consolidatedDataBody || !consolidatedTableData.length) return;
      
      let rows = '';
      consolidatedTableData.forEach(data => {
        rows += `<tr data-docid="${data.docId}">
          <td class="consolidated-data-cell" data-key="ClientID_Forex" data-original="${data.ClientID_Forex || ''}">${data.ClientID_Forex || ''}</td>
          <td class="consolidated-data-cell" data-key="Counterparty" data-original="${data.Counterparty || ''}">${data.Counterparty || ''}</td>
          <td class="consolidated-data-cell" data-key="id" data-original="${data.docId}">${data.docId}</td>
          <td>
            <button class="barclays-secondary-btn px-2 py-1 rounded edit-consolidated-btn mr-1" data-docid="${data.docId}">Edit</button>
            <button class="barclays-btn px-2 py-1 rounded save-consolidated-btn hidden mr-1" data-docid="${data.docId}">Save</button>
            <button class="bg-gray-600 text-white px-2 py-1 rounded cancel-consolidated-btn hidden" data-docid="${data.docId}">Cancel</button>
          </td>
        </tr>`;
      });
      consolidatedDataBody.innerHTML = rows;
    }
    
    function renderRequestTable() {
      const tbody = document.getElementById('arRequestsTableBody');
      if (!tbody) return;
      
      if (filteredRequestData.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="8" class="text-center py-8 text-barclays-muted">
              <div class="flex flex-col items-center">
                <span style="font-size: 2em; margin-bottom: 8px;">🔍</span>
                <p class="text-lg">No requests found matching your filters</p>
                <button onclick="clearRequestFilters()" class="barclays-btn px-4 py-2 rounded-lg mt-4">
                  Clear Filters
                </button>
              </div>
            </td>
          </tr>
        `;
        return;
      }
      
      let rows = '';
      filteredRequestData.forEach(request => {
        // Convert database type values to display names
        const getTypeDisplayName = (type) => {
          switch(type) {
            case 'create': return 'Account Creation';
            case 'alter': return 'Account Modification';
            case 'delete': return 'Account Closure';
            default: return type || '';
          }
        };
        
        // Enhanced rendering with cross-reference information
        const isApproved = request.status && request.status.toLowerCase() === 'approved';
        const hasLinkedAccount = request.linkedAccountId;
        const rowClass = isApproved ? 'bg-green-50 border-l-4 border-green-500' : '';
        
        rows += `
          <tr class="${rowClass}" data-request-id="${request.docId}">
            <td>${getTypeDisplayName(request.type)}</td>
            <td>${request.team || ''}</td>
            <td>${request.email || ''}</td>
            <td>
              <div>${request.accountId || ''}</div>
              ${hasLinkedAccount ? `
                <div class="text-xs text-green-600 mt-1 flex items-center gap-1">
                  <span>🔗</span>
                  <button onclick="showLinkedAccount('${request.linkedAccountId}')" class="underline hover:no-underline" title="View linked account">
                    Linked: ${request.linkedAccountId}
                  </button>
                </div>
              ` : ''}
            </td>
            <td>
              <div>${request.details || ''}</div>
              ${request.lifecycleStatus ? `
                <div class="text-xs text-blue-600 mt-1">Lifecycle: ${request.lifecycleStatus}</div>
              ` : ''}
              ${request.flowStatus ? `
                <div class="text-xs text-purple-600 mt-1">Flow: ${request.flowStatus}</div>
              ` : ''}
            </td>
            <td>
              ${renderRequestStatusTag(request.status)}
              ${hasLinkedAccount ? `
                <div class="text-xs text-green-600 mt-1 flex items-center gap-1">
                  <span>✅</span>
                  <span>Account Created</span>
                </div>
              ` : ''}
              ${request.lifecycleStatus === 'Fully Completed' ? `
                <div class="text-xs text-purple-600 mt-1 flex items-center gap-1">
                  <span>🎯</span>
                  <span>Fully Processed</span>
                </div>
              ` : request.lifecycleStatus === 'Completed' ? `
                <div class="text-xs text-blue-600 mt-1 flex items-center gap-1">
                  <span>✅</span>
                  <span>Request Completed</span>
                </div>
              ` : ''}
            </td>
            <td>
              <div>${request.submittedAt ? (request.submittedAt.toDate ? request.submittedAt.toDate().toLocaleString() : new Date(request.submittedAt).toLocaleString()) : ''}</div>
              ${request.processedAt ? `
                <div class="text-xs text-gray-500 mt-1">
                  Processed: ${request.processedAt.toDate ? request.processedAt.toDate().toLocaleString() : new Date(request.processedAt).toLocaleString()}
                </div>
              ` : ''}
            </td>
            <td class="text-center">
              ${request.status && request.status.toLowerCase() === 'pending' ? `
                <div class="flex flex-col gap-1">
                  <button onclick="openApproveRequestModal('${request.docId}')" class="barclays-btn px-2 py-1 text-xs rounded">Create Account</button>
                  <button onclick="rejectRequest('${request.docId}')" class="bg-red-600 text-white px-2 py-1 text-xs rounded hover:bg-red-700">Reject</button>
                </div>
              ` : hasLinkedAccount ? `
                <div class="flex flex-col gap-1">
                  <button onclick="showLinkedAccount('${request.linkedAccountId}')" class="barclays-secondary-btn px-2 py-1 text-xs rounded" title="View created account">
                    View Account
                  </button>
                  <button onclick="viewRequestTimeline('${request.docId}')" class="barclays-secondary-btn px-2 py-1 text-xs rounded" title="View request timeline">
                    Timeline
                  </button>
                </div>
              ` : `
                <span class="text-gray-500 text-xs">${request.status}</span>
              `}
            </td>
          </tr>
        `;
      });
      tbody.innerHTML = rows;
    }
    
    function renderRequestStatusTag(status) {
      const statusClass = status ? `status-${status.toLowerCase()}` : 'status-pending';
      return `<span class="status-badge ${statusClass}">${status || 'Pending'}</span>`;
    }
    
    // Make functions globally available
    window.applyRequestFilters = applyRequestFilters;
    window.clearRequestFilters = clearRequestFilters;
    window.sortRequestTable = sortRequestTable;
    window.applyFilters = applyFilters;
    window.clearFilters = clearFilters;
    window.sortTable = sortTable;
    window.sortReconciliationTable = sortReconciliationTable;
    window.sortConsolidatedTable = sortConsolidatedTable;
    window.sortConsolidatedData = sortConsolidatedData;
    window.renderConsolidatedTable = renderConsolidatedTable;
    window.loadConsolidatedData = loadConsolidatedData;
    window.getFirstDocumentIdFromOriginalOrder = getFirstDocumentIdFromOriginalOrder;
    window.generateDocumentIdOptions = generateDocumentIdOptions;
    window.updateAssignedDocumentId = updateAssignedDocumentId;
    
    async function approveRequest(requestId) {
      if (!confirm('Are you sure you want to approve this request?')) return;
      const confirmed = await requestAdminPasskey();
      if (!confirmed) return;
      
      try {
        await db.collection('account_requests').doc(requestId).update({ 
          status: 'approved',
          approvedAt: firebase.firestore.FieldValue.serverTimestamp(),
          approvedBy: currentUser ? currentUser.email : 'admin'
        });
        showToast('Request approved successfully!', 'success');
        loadAccountRequests(); // Refresh the table
      } catch (error) {
        showToast('Failed to approve request.', 'error');
        console.error('Error approving request:', error);
      }
    }
    
    async function rejectRequest(requestId) {
      if (!confirm('Are you sure you want to reject this request?')) return;
      const confirmed = await requestAdminPasskey();
      if (!confirmed) return;
      
      try {
        await db.collection('account_requests').doc(requestId).update({ 
          status: 'rejected',
          rejectedAt: firebase.firestore.FieldValue.serverTimestamp(),
          rejectedBy: currentUser ? currentUser.email : 'admin'
        });
        showToast('Request rejected successfully!', 'success');
        loadAccountRequests(); // Refresh the table
      } catch (error) {
        showToast('Failed to reject request.', 'error');
        console.error('Error rejecting request:', error);
      }
    }
    window.rejectRequest = rejectRequest;
    // Batch Mismatches Modal Functions
    async function viewBatchMismatches(batchDocId) {
      try {
        const modal = document.getElementById('mismatchesModal');
        const content = document.getElementById('mismatchesModalContent');
        
        // Show modal with loading state
        modal.classList.remove('hidden');
        content.innerHTML = '<div class="text-center text-barclays-muted p-8"><div class="animate-spin inline-block w-6 h-6 border-2 border-current border-t-transparent rounded-full mr-2"></div>Loading batch mismatches...</div>';
        
        // Fetch batch data
        const doc = await db.collection('reconciliation_batches').doc(batchDocId).get();
        if (!doc.exists) {
          content.innerHTML = '<div class="text-center text-red-500 p-4">Batch not found.</div>';
          return;
        }
        
        const batchData = doc.data();
        const result = batchData.result;
        
        if (!result || (!result.added?.length && !result.removed?.length && !result.statusChanged?.length)) {
          content.innerHTML = '<div class="text-center text-barclays-muted p-4">No mismatches found in this batch.</div>';
          return;
        }
        
        // Generate table HTML
        let tableHTML = `
          <table class="w-full">
            <thead>
              <tr>
                <th>Client ID</th>
                <th>Status in File A</th>
                <th>Status in File B</th>
              </tr>
            </thead>
            <tbody>
        `;
        
        // Add removed records (show as having status in A but not in B)
        if (result.removed?.length) {
          result.removed.forEach(record => {
            const clientId = record['Client ID'] || 'N/A';
            const status = record['Account Status'] || 'N/A';
            
            tableHTML += `
              <tr>
                <td>${clientId}</td>
                <td><span class="status-badge status-${status.toLowerCase().replace(/\s+/g, '-')}">${status}</span></td>
                <td><span class="status-badge status-closed">closed</span></td>
              </tr>
            `;
          });
        }
        
        // Add new records (show as not having status in A but having in B)
        if (result.added?.length) {
          result.added.forEach(record => {
            const clientId = record['Client ID'] || 'N/A';
            const status = record['Account Status'] || 'N/A';
            
            tableHTML += `
              <tr>
                <td>${clientId}</td>
                <td><span class="status-badge status-closed">closed</span></td>
                <td><span class="status-badge status-${status.toLowerCase().replace(/\s+/g, '-')}">${status}</span></td>
              </tr>
            `;
          });
        }
        
        // Add status changed records
        if (result.statusChanged?.length) {
          result.statusChanged.forEach(change => {
            const clientId = change.clientId || 'N/A';
            const fromStatus = change.from || 'N/A';
            const toStatus = change.to || 'N/A';
            
            tableHTML += `
              <tr>
                <td>${clientId}</td>
                <td><span class="status-badge status-${fromStatus.toLowerCase().replace(/\s+/g, '-')}">${fromStatus}</span></td>
                <td><span class="status-badge status-${toStatus.toLowerCase().replace(/\s+/g, '-')}">${toStatus}</span></td>
              </tr>
            `;
          });
        }
        
        tableHTML += '</tbody></table>';
        
        // Add summary information
        const totalMismatches = (result.added?.length || 0) + (result.removed?.length || 0) + (result.statusChanged?.length || 0);
        const summaryHTML = `
          <div class="mb-4 p-4 bg-blue-50 rounded-lg border border-blue-200">
            <h3 class="font-semibold text-blue-900 mb-2">Batch Summary</h3>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
              <div class="text-center">
                <div class="font-bold text-lg text-blue-600">${totalMismatches}</div>
                <div class="text-blue-800">Total Mismatches</div>
              </div>
              <div class="text-center">
                <div class="font-bold text-lg text-green-600">${result.added?.length || 0}</div>
                <div class="text-green-800">Added</div>
              </div>
              <div class="text-center">
                <div class="font-bold text-lg text-red-600">${result.removed?.length || 0}</div>
                <div class="text-red-800">Removed</div>
              </div>
              <div class="text-center">
                <div class="font-bold text-lg text-yellow-600">${result.statusChanged?.length || 0}</div>
                <div class="text-yellow-800">Changed</div>
              </div>
            </div>
          </div>
        `;
        
        content.innerHTML = summaryHTML + tableHTML;
        
      } catch (error) {
        console.error('Error viewing batch mismatches:', error);
        document.getElementById('mismatchesModalContent').innerHTML = 
          '<div class="text-center text-red-500 p-4">Failed to load batch mismatches.</div>';
      }
    }
    
    function closeMismatchesModal() {
      const modal = document.getElementById('mismatchesModal');
      modal.classList.add('hidden');
    }
    
    async function downloadBatchMismatches(batchDocId) {
      try {
        // Set loading state for download button
        const downloadBtn = document.querySelector(`button[onclick="downloadBatchMismatches('${batchDocId}')"]`);
        if (downloadBtn) {
          downloadBtn.disabled = true;
          downloadBtn.textContent = 'Downloading...';
        }
        
        const doc = await db.collection('reconciliation_batches').doc(batchDocId).get();
        if (!doc.exists) {
          showToast('Batch not found.', 'error');
          return;
        }
        
        const batchData = doc.data();
        const result = batchData.result;
        
        if (!result || (!result.added?.length && !result.removed?.length && !result.statusChanged?.length)) {
          showToast('No mismatches found in this batch.', 'info');
          return;
        }
        
        // Prepare CSV data
        const csvData = [];
        csvData.push(['Client ID', 'Change Type', 'Previous Status', 'Current Status', 'Batch ID', 'Upload Date']);
        
        // Add removed records
        if (result.removed?.length) {
          result.removed.forEach(record => {
            csvData.push([
              record['Client ID'] || 'N/A',
              'Removed',
              record['Account Status'] || 'N/A',
              'N/A',
              batchData.batchId || 'N/A',
              batchData.uploadedAt ? (batchData.uploadedAt.toDate ? batchData.uploadedAt.toDate().toLocaleString() : new Date(batchData.uploadedAt).toLocaleString()) : 'N/A'
            ]);
          });
        }
        
        // Add new records
        if (result.added?.length) {
          result.added.forEach(record => {
            csvData.push([
              record['Client ID'] || 'N/A',
              'Added',
              'N/A',
              record['Account Status'] || 'N/A',
              batchData.batchId || 'N/A',
              batchData.uploadedAt ? (batchData.uploadedAt.toDate ? batchData.uploadedAt.toDate().toLocaleString() : new Date(batchData.uploadedAt).toLocaleString()) : 'N/A'
            ]);
          });
        }
        
        // Add status changed records
        if (result.statusChanged?.length) {
          result.statusChanged.forEach(change => {
            csvData.push([
              change.clientId || 'N/A',
              'Status Changed',
              change.from || 'N/A',
              change.to || 'N/A',
              batchData.batchId || 'N/A',
              batchData.uploadedAt ? (batchData.uploadedAt.toDate ? batchData.uploadedAt.toDate().toLocaleString() : new Date(batchData.uploadedAt).toLocaleString()) : 'N/A'
            ]);
          });
        }
        
        // Generate CSV
        const csv = csvData.map(row => 
          row.map(cell => '"' + (cell || '').toString().replace(/"/g,'""') + '"').join(',')
        ).join('\n');
        
        // Download CSV
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `batch-mismatches-${batchData.batchId || 'unknown'}.csv`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        showToast('Batch mismatches CSV downloaded successfully!', 'success');
        
      } catch (error) {
        console.error('Error downloading batch mismatches:', error);
        showToast('Failed to download batch mismatches.', 'error');
      } finally {
        // Restore button state
        const downloadBtn = document.querySelector(`button[onclick="downloadBatchMismatches('${batchDocId}')"]`);
        if (downloadBtn) {
          downloadBtn.disabled = false;
          downloadBtn.textContent = 'Download Mismatches';
        }
      }
    }
    
    // Make modal functions globally available
    window.viewBatchMismatches = viewBatchMismatches;
    window.closeMismatchesModal = closeMismatchesModal;
    window.downloadBatchMismatches = downloadBatchMismatches;
    



    async function deleteAccount(accountId) {
      if (!confirm('Are you sure you want to delete this account? This action cannot be undone.')) return;
      
      // Find the delete button and set loading state
      const deleteBtn = document.querySelector(`button[onclick="deleteAccount('${accountId}')"]`);
      if (deleteBtn) {
        setButtonLoadingState(deleteBtn.id || 'deleteAccountBtn', true, 'Deleting...', 'Delete');
      }
      
      try {
        const confirmed = await requestAdminPasskey();
        if (!confirmed) return;
        
        await db.collection('accounts').doc(accountId).delete();
        await logAudit('delete_account', { accountId: accountId });
        showToast('Account deleted successfully!', 'success');
        refreshAccounts();
      } catch (error) {
        if (error.code === 'permission-denied') {
            showToast('Access Denied. You do not have permission to delete accounts.', 'error');
        } else {
            showToast('Failed to delete account.', 'error');
        }
        console.error(error);
      } finally {
        // Restore loading state
        if (deleteBtn) {
          setButtonLoadingState(deleteBtn.id || 'deleteAccountBtn', false, null, 'Delete');
        }
      }
    }
    
    async function downloadAccountsCSV() {
      // Find the download button and set loading state
      const downloadBtn = document.querySelector('button[onclick="downloadAccountsCSV()"]');
      if (downloadBtn) {
        setButtonLoadingState(downloadBtn.id || 'downloadAccountsBtn', true, 'Downloading...', 'Download CSV');
      }
      
      try {
        const snapshot = await db.collection('accounts').orderBy('createdAt', 'desc').get();
        if (snapshot.empty) {
          showToast('No accounts to download.', 'error');
          return;
        }
        const headers = ['Agent Bank', 'Account ID', 'Email', 'LEI', 'Status', 'Account Opening Date', 'Account Closure Date', 'Created By'];
        const rows = [headers];
        snapshot.forEach(doc => {
          const acc = doc.data();
          rows.push([
            acc.name || '', acc.id || '', acc.email || '',
            acc.lei || '', acc.status || '',
            acc.accountOpeningDate ? (acc.accountOpeningDate.toDate ? acc.accountOpeningDate.toDate().toLocaleString() : new Date(acc.accountOpeningDate).toLocaleString()) : '',
            acc.accountClosureDate ? (acc.accountClosureDate.toDate ? acc.accountClosureDate.toDate().toLocaleString() : new Date(acc.accountClosureDate).toLocaleString()) : '',
            acc.createdBy || ''
          ]);
        });
        const csv = rows.map(row => row.map(cell => '"' + (cell || '').toString().replace(/"/g,'""') + '"').join(',')).join('\n');
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'accounts.csv';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        showToast('CSV downloaded successfully!', 'success');
      } catch (error) {
        showToast('Failed to download accounts: ' + (error && error.message ? error.message : 'An unknown error occurred.'), 'error');
        console.error(error);
      } finally {
        // Restore loading state
        if (downloadBtn) {
          setButtonLoadingState(downloadBtn.id || 'downloadAccountsBtn', false, null, 'Download CSV');
        }
      }
    }

    // --- UI & Tab Management ---
    let reconciliationLoaded = false;
    let consolidatedDataLoaded = false;

    function showTab(tab) {
      document.querySelectorAll('.tab-content').forEach(el => {
        el.classList.remove('active');
        el.classList.add('hidden');
      });
      document.querySelectorAll('.tab-btn').forEach(el => {
        el.classList.remove('active-tab');
        el.classList.add('inactive-tab');
      });
      if (tab === 'reconciliation') {
        if (!reconciliationLoaded) {
          if (typeof loadReconciliationRecords === 'function') {
            loadReconciliationRecords();
            reconciliationLoaded = true;
          }
        }
      }
      if (tab === 'workflow') {
        if (!consolidatedDataLoaded) {
          if (typeof loadConsolidatedData === 'function') {
            loadConsolidatedData();
            consolidatedDataLoaded = true;
          }
        }
      }
      var tabContent = document.getElementById(tab);
      if (tabContent) {
        tabContent.classList.remove('hidden');
        setTimeout(() => tabContent.classList.add('active'), 10);
      }
      var tabBtn = document.getElementById('tab-' + tab);
      if (tabBtn) {
        tabBtn.classList.add('active-tab');
        tabBtn.classList.remove('inactive-tab');
      }
    }
    
    // --- Reconciliation Functions ---
    let reconciliationResultData = null;
    let parsedCSVData = null;
    let parsedCSVHeader = null;

    async function compareCSVFiles() {
      const fileAInput = document.getElementById('csvFileA');
      const fileBInput = document.getElementById('csvFileB');
      const resultDiv = document.getElementById('reconciliationResult');
      const progressDiv = document.getElementById('reconciliationProgress');
      const summaryDiv = document.getElementById('reconciliationSummary');
      const diffHeader = document.getElementById('reconciliationDiffHeader');
      const diffBody = document.getElementById('reconciliationDiffBody');
      const tableContainer = document.getElementById('reconciliationDiffTable').parentElement;
      const noDataMessage = document.getElementById('noReconciliationMessage');
      const storeBtn = document.getElementById('storeDataBtn');

      if (!fileAInput.files.length || !fileBInput.files.length) {
        showToast('Please select both CSV files to compare.', 'error');
        return;
      }
      
      // Show progress indicator and set loading state
      progressDiv.classList.remove('hidden');
      resultDiv.classList.add('hidden');
      updateProgress(0, 'Starting comparison...');
      setButtonLoadingState('compareBtn', true, 'Comparing...', 'Compare & Reconcile');
      
      // Reset progress steps
      resetProgressSteps();
      
      try {
        // Step 1: Upload Files (25%)
        updateProgress(25, 'Reading files...');
        updateProgressStep(1, 'active');
        
        const [dataA, dataB] = await Promise.all([
          new Promise((resolve, reject) => Papa.parse(fileAInput.files[0], { header: true, skipEmptyLines: true, complete: r => resolve(r.data), error: reject })),
          new Promise((resolve, reject) => Papa.parse(fileBInput.files[0], { header: true, skipEmptyLines: true, complete: r => resolve(r.data), error: reject }))
        ]);

        // Step 2: Parse Data (50%)
        updateProgress(50, 'Parsing data...');
        updateProgressStep(1, 'completed');
        updateProgressStep(2, 'active');

        // Only consider 'Client ID' and 'Account Status'
        const key = 'Client ID';
        const statusField = 'Account Status';
        const columnsA = dataA.length ? Object.keys(dataA[0]) : [];
        const columnsB = dataB.length ? Object.keys(dataB[0]) : [];
        if (!columnsA.includes(key) || !columnsA.includes(statusField) || !columnsB.includes(key) || !columnsB.includes(statusField)) {
          showToast('Both files must contain "Client ID" and "Account Status" columns.', 'error');
          progressDiv.classList.add('hidden');
          setButtonLoadingState('compareBtn', false, null, 'Compare & Reconcile');
          return;
        }

        // Step 3: Compare Records (75%)
        updateProgress(75, 'Comparing records...');
        updateProgressStep(2, 'completed');
        updateProgressStep(3, 'active');

        const mapA = dataA.reduce((m, row) => { if(row[key]) m[row[key]] = row; return m; }, {});
        const mapB = dataB.reduce((m, row) => { if(row[key]) m[row[key]] = row; return m; }, {});
        
        const added = [], removed = [], statusChanged = [], unchanged = [];
        const allKeys = new Set([...Object.keys(mapA), ...Object.keys(mapB)]);
        
        allKeys.forEach(k => {
          if (!mapA[k]) {
            added.push(mapB[k]);
          } else if (!mapB[k]) {
            removed.push(mapA[k]);
          } else {
            // Compare only the Account Status field
            const statusA = (mapA[k][statusField] || '').toLowerCase();
            const statusB = (mapB[k][statusField] || '').toLowerCase();
            if (statusA !== statusB) {
              statusChanged.push({ clientId: k, from: statusA, to: statusB, rowA: mapA[k], rowB: mapB[k] });
            } else {
              unchanged.push(mapA[k]);
            }
          }
        });
        
        reconciliationResultData = { added, removed, statusChanged };

        // Step 4: Generate Results (100%)
        updateProgress(100, 'Generating results...');
        updateProgressStep(3, 'completed');
        updateProgressStep(4, 'active');

        // Hide progress indicator
        setTimeout(() => {
          progressDiv.classList.add('hidden');
        }, 1000);

        if(added.length === 0 && removed.length === 0 && statusChanged.length === 0) {
          summaryDiv.innerHTML = `
            <div class="text-center">
              <div class="text-2xl mb-2">✅</div>
              <div class="text-lg font-semibold text-green-600">No Differences Found</div>
              <div class="text-sm text-barclays-muted">Both files are identical</div>
            </div>
          `;
          tableContainer.classList.add('hidden');
          storeBtn.classList.add('hidden');
          noDataMessage.classList.remove('hidden');
        } else {
          // Enhanced summary with better styling
          summaryDiv.innerHTML = `
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
              <div class="text-center p-3 rounded-lg" style="background: rgba(0, 193, 213, 0.1); border: 1px solid rgba(0, 193, 213, 0.3);">
                <div class="text-2xl font-bold text-cyan-400">${added.length}</div>
                <div class="text-sm text-barclays-muted">Added Records</div>
              </div>
              <div class="text-center p-3 rounded-lg" style="background: rgba(255, 107, 107, 0.1); border: 1px solid rgba(255, 107, 107, 0.3);">
                <div class="text-2xl font-bold text-red-400">${removed.length}</div>
                <div class="text-sm text-barclays-muted">Removed Records</div>
              </div>
              <div class="text-center p-3 rounded-lg" style="background: rgba(255, 224, 102, 0.1); border: 1px solid rgba(255, 224, 102, 0.3);">
                <div class="text-2xl font-bold text-yellow-400">${statusChanged.length}</div>
                <div class="text-sm text-barclays-muted">Status Changes</div>
              </div>
            </div>
          `;
          
          tableContainer.classList.remove('hidden');
          storeBtn.classList.remove('hidden');
          noDataMessage.classList.add('hidden');
          
          // Enhanced table with visual diff columns
          diffHeader.innerHTML = '<tr>' +
            `<th>Client ID</th>` +
            `<th>Previous Status</th>` +
            `<th>Current Status</th>` +
            `<th>Change Type</th>` +
            '</tr>';
          
          let bodyHtml = '';
          
          // Removed records
          removed.forEach(row => { 
            bodyHtml += `<tr class="row-removed">
              <td>${row[key]}</td>
              <td><span class="diff-from">${row[statusField] || 'N/A'}</span></td>
              <td><span class="diff-to">—</span></td>
              <td><span class="diff-status removed">Removed</span></td>
            </tr>`; 
          });
          
          // Added records
          added.forEach(row => { 
            bodyHtml += `<tr class="row-added">
              <td>${row[key]}</td>
              <td><span class="diff-from">—</span></td>
              <td><span class="diff-to">${row[statusField] || 'N/A'}</span></td>
              <td><span class="diff-status added">Added</span></td>
            </tr>`; 
          });
          
          // Status changed records
          statusChanged.forEach(pair => { 
            bodyHtml += `<tr class="row-changed">
              <td>${pair.clientId}</td>
              <td><span class="diff-from">${pair.from || 'N/A'}</span></td>
              <td><span class="diff-to">${pair.to || 'N/A'}</span></td>
              <td><span class="diff-status changed">Changed</span></td>
            </tr>`; 
          });
          
          if (!added.length && !removed.length && !statusChanged.length) {
            bodyHtml += `<tr><td colspan="4" class="text-center p-4 text-green-600">No differences found. Files are identical.</td></tr>`;
          }
          
          diffBody.innerHTML = bodyHtml;
        }

        resultDiv.classList.remove('hidden');
        const downloadMismatchesBtn = document.getElementById('downloadMismatchesBtn');
        if (statusChanged.length > 0) {
          downloadMismatchesBtn.classList.remove('hidden');
        } else {
          downloadMismatchesBtn.classList.add('hidden');
        }
      } catch (err) {
        showToast('Failed to compare files: ' + (err && err.message ? err.message : 'An unknown error occurred.'), 'error');
        console.error(err);
        reconciliationResultData = null;
        progressDiv.classList.add('hidden');
      } finally {
        setButtonLoadingState('compareBtn', false, null, 'Compare & Reconcile');
      }
    }
    
    async function storeReconciliationData() {
      if (!reconciliationResultData || (!reconciliationResultData.added.length && !reconciliationResultData.removed.length && !reconciliationResultData.statusChanged.length)) {
        showToast('No data to store. Please perform a reconciliation first.', 'error');
        return;
      }
      
      // Set loading state for store button
      setButtonLoadingState('storeDataBtn', true, 'Storing...', 'Store in Database');
      try {
        const batchId = 'BATCH-' + Date.now();
        const userEmail = (currentUser && currentUser.email) ? currentUser.email : 'anonymous';
        const dataToStore = {
          batchId,
          uploadedAt: firebase.firestore.FieldValue.serverTimestamp(),
          uploadedBy: userEmail,
          result: reconciliationResultData
        };
        await db.collection('reconciliation_batches').add(dataToStore);
        await logAudit('store_reconciliation', { batchId: batchId, summary: { added: reconciliationResultData.added.length, removed: reconciliationResultData.removed.length, statusChanged: reconciliationResultData.statusChanged.length } });
        showToast('Data stored successfully!', 'success');
        clearCSVData();
        loadReconciliationRecords();
      } catch (error) {
        showToast('Failed to store data: ' + (error && error.message ? error.message : 'An unknown error occurred.'), 'error');
        console.error(error);
      } finally {
        setButtonLoadingState('storeDataBtn', false, null, 'Store in Database');
      }
    }

    function clearCSVData() {
      const fileA = document.getElementById('csvFileA');
      const fileB = document.getElementById('csvFileB');
      if (fileA) fileA.value = '';
      if (fileB) fileB.value = '';
      
      // Clear file status indicators
      document.getElementById('fileAStatus').classList.add('hidden');
      document.getElementById('fileBStatus').classList.add('hidden');
      document.getElementById('fileUploadProgress').classList.add('hidden');
      
      // Clear reconciliation results
      document.getElementById('reconciliationResult').classList.add('hidden');
      document.getElementById('reconciliationDiffHeader').innerHTML = '';
      document.getElementById('reconciliationDiffBody').innerHTML = '';
      document.getElementById('reconciliationSummary').innerHTML = '';
      
      // Reset progress indicators
      updateUploadProgress();
    }

    const RECONCILIATION_PAGE_SIZE = 5;
    let reconciliationLastVisible = null;
    let reconciliationCurrentPageStart = null;
    let reconciliationPrevPageStarts = [];

    async function loadReconciliationRecords(startAfterDoc = null) {
      const tbody = document.getElementById('reconciliationTableBody');
      const batchFilter = document.getElementById('batchFilter');
      const nextBtn = document.getElementById('reconciliationNextBtn');
      const prevBtn = document.getElementById('reconciliationPrevBtn');

      tbody.innerHTML = `<tr class="skeleton-table-row">
        <td colspan="5">
          <div class="flex space-x-2">
            <div class="skeleton" style="width: 100px; height: 20px;"></div>
            <div class="skeleton" style="width: 120px; height: 20px;"></div>
            <div class="skeleton" style="width: 100px; height: 20px;"></div>
            <div class="skeleton" style="width: 180px; height: 20px;"></div>
            <div class="skeleton" style="width: 80px; height: 20px;"></div>
          </div>
        </td>
      </tr>`;
      if(nextBtn) nextBtn.disabled = true;
      if(prevBtn) prevBtn.disabled = true;

      reconciliationCurrentPageStart = startAfterDoc;
      if (!startAfterDoc) {
        reconciliationPrevPageStarts = [];
      }
      
      try {
        let query;
        const selectedBatch = batchFilter.value;
        let baseQuery = db.collection('reconciliation_batches');

        if (selectedBatch) {
          query = baseQuery.where('batchId', '==', selectedBatch).limit(RECONCILIATION_PAGE_SIZE);
        } else {
          query = baseQuery.orderBy('uploadedAt', 'desc').limit(RECONCILIATION_PAGE_SIZE);
        }

        if (startAfterDoc) {
          query = query.startAfter(startAfterDoc);
        }
        
        const snapshot = await query.get();
        if (snapshot.empty) {
          document.getElementById('reconciliationTable').classList.add('hidden');
          document.getElementById('noRecordsMessage').classList.remove('hidden');
          tbody.innerHTML = `<tr><td colspan="5" class="border p-4 text-center text-gray-500"> <span style='font-size:1.3em;vertical-align:middle;'>🗂️</span> ${startAfterDoc ? 'No more records found.' : 'No records found.'}</td></tr>`;
          if (prevBtn) prevBtn.disabled = reconciliationPrevPageStarts.length === 0;
          return;
        }
        document.getElementById('reconciliationTable').classList.remove('hidden');
        document.getElementById('noRecordsMessage').classList.add('hidden');

        reconciliationLastVisible = snapshot.docs[snapshot.docs.length - 1];

        let rows = '';
        let batchOptions = '<option value="">All Batches</option>';
        const allBatchesSnap = await db.collection('reconciliation_batches').get();
        allBatchesSnap.forEach(doc => {
          const rec = doc.data();
          batchOptions += `<option value="${rec.batchId}">${rec.batchId}</option>`;
        });
        snapshot.forEach(doc => {
          const rec = doc.data();
          let recordPreview = '';
          if (rec.result && Array.isArray(rec.result.added)) {
            rec.result.added.slice(0,2).forEach(r => { recordPreview += '<div class="text-xs">' + JSON.stringify(r) + '</div>'; });
            if (rec.result.added.length > 2) recordPreview += `<div class="text-xs text-gray-400">...and ${rec.result.added.length-2} more</div>`;
          } else if (Array.isArray(rec.records)) {
            rec.records.slice(0,2).forEach(r => { recordPreview += '<div class="text-xs">' + JSON.stringify(r) + '</div>'; });
            if (rec.records.length > 2) recordPreview += `<div class="text-xs text-gray-400">...and ${rec.records.length-2} more</div>`;
          }
          rows += `
            <tr>
              <td class="border border-gray-300 p-3">${rec.batchId || ''}</td>
              <td class="border border-gray-300 p-3">${rec.uploadedAt && rec.uploadedAt.toDate ? rec.uploadedAt.toDate().toLocaleString() : ''}</td>
              <td class="border border-gray-300 p-3">${rec.uploadedBy || ''}</td>
              <td class="border border-gray-300 p-3">${recordPreview}</td>
              <td class="border border-gray-300 p-3 text-center">
                <div class='flex flex-col gap-2 items-start'>
                  <button onclick="deleteBatch('${doc.id}')" class="text-red-500 hover:underline">Delete</button>
                  <button onclick="viewBatchMismatches('${doc.id}')" class="barclays-btn px-2 py-1 rounded">View Mismatches</button>
                  <button onclick="downloadBatchMismatches('${doc.id}')" class="barclays-btn px-2 py-1 rounded">Download Mismatches</button>
                </div>
              </td>
            </tr>`;
        });
        tbody.innerHTML = rows;
        batchFilter.innerHTML = batchOptions;
        batchFilter.value = selectedBatch;

        let nextQuery;
        if (selectedBatch) {
          nextQuery = baseQuery.where('batchId', '==', selectedBatch).startAfter(reconciliationLastVisible).limit(1);
        } else {
          nextQuery = baseQuery.orderBy('uploadedAt', 'desc').startAfter(reconciliationLastVisible).limit(1);
        }
        const nextSnapshot = await nextQuery.get();
        if(nextBtn) nextBtn.disabled = nextSnapshot.empty;
        if(prevBtn) prevBtn.disabled = reconciliationPrevPageStarts.length === 0;

      } catch (error) {
        tbody.innerHTML = '<tr><td colspan="5" class="border p-4 text-center text-red-500">Failed to load records.</td></tr>';
        console.error(error);
      }
    }

    function nextReconciliationPage() {
      if (reconciliationLastVisible) {
        reconciliationPrevPageStarts.push(reconciliationCurrentPageStart);
        loadReconciliationRecords(reconciliationLastVisible);
      }
    }

    function prevReconciliationPage() {
      const prevStart = reconciliationPrevPageStarts.pop();
      loadReconciliationRecords(prevStart);
    }
    document.getElementById('batchFilter').onchange = () => loadReconciliationRecords();

    async function deleteBatch(batchDocId) {
      if (!confirm('Are you sure you want to delete this batch? This action cannot be undone.')) return;
      
      // Find the delete button and set loading state
      const deleteBtn = document.querySelector(`button[onclick="deleteBatch('${batchDocId}')"]`);
      if (deleteBtn) {
        setButtonLoadingState(deleteBtn.id || 'deleteBatchBtn', true, 'Deleting...', 'Delete');
      }
      
      try {
        const confirmed = await requestAdminPasskey();
        if (!confirmed) return;
        
        await db.collection('reconciliation_batches').doc(batchDocId).delete();
        await logAudit('delete_reconciliation_batch', { batchDocId: batchDocId });
        showToast('Batch deleted successfully!', 'success');
        loadReconciliationRecords();
      } catch (error) {
        if (error.code === 'permission-denied') {
            showToast('Access Denied. You do not have permission to delete batches.', 'error');
        } else {
            showToast('Failed to delete batch.', 'error');
        }
        console.error(error);
      } finally {
        // Restore loading state
        if (deleteBtn) {
          setButtonLoadingState(deleteBtn.id || 'deleteBatchBtn', false, null, 'Delete');
        }
      }
    }
    
    // --- Firebase Authentication ---
    let isSignInMode = true;

    function toggleAuthMode(event) {
        event.preventDefault();
        isSignInMode = !isSignInMode;
        const title = document.getElementById('authTitle');
        const button = document.getElementById('authButton');
        const link = document.getElementById('authLink');
        const form = document.getElementById('authForm');
        const emailInput = document.getElementById('authEmail');
        const passwordInput = document.getElementById('authPassword');
        emailInput.value = '';
        passwordInput.value = '';

        if (isSignInMode) {
            title.textContent = 'Sign in to Barclays Network Management Portal';
            button.textContent = 'Sign In';
            link.innerHTML = 'Don\'t have an account? Sign Up';
            form.onsubmit = (e) => signInUser(e);
        } else {
            title.textContent = 'Sign up for Barclays Network Management Portal';
            button.textContent = 'Sign Up';
            link.innerHTML = 'Already have an account? Sign In';
            form.onsubmit = (e) => signUpUser(e);
        }
    }
    
    function openSignInModal() {
      showModal('authPage');
    }

    function closeSignInModal() {
      hideModal('authPage');
    }
    function updateAuthUI(user, isAdmin) {
      const signInBtn = document.getElementById('signInBtn');
      const signOutBtn = document.getElementById('signOutBtn');
      const authStatus = document.getElementById('authStatus');
      const mainContent = document.getElementById('mainContent');
      const authPage = document.getElementById('authPage');
      const tabNav = document.querySelector('.shadow-sm.rounded-xl.mb-6.flex.justify-center');
      const tabContents = document.querySelectorAll('.tab-content');
      const dashboardTabBtn = document.getElementById('tab-dashboard');
      const dashboardTab = document.getElementById('dashboard');

      if (!isAdmin) {
        if (mainContent) mainContent.style.display = 'block';
        if (tabNav) tabNav.style.display = 'none';
        tabContents.forEach(tab => tab.classList.add('hidden'));
        if (dashboardTabBtn) dashboardTabBtn.classList.add('hidden');
        if (dashboardTab) dashboardTab.classList.add('hidden');
      } else {
        if (mainContent) mainContent.style.display = 'block';
        if (tabNav) tabNav.style.display = '';
        tabContents.forEach(tab => tab.classList.remove('hidden'));
        if (dashboardTabBtn) dashboardTabBtn.classList.remove('hidden');
        if (dashboardTab) dashboardTab.classList.remove('hidden');
        // Ensure workflow tab is active for admin users
        setTimeout(() => {
          showTab('workflow');
        }, 50);
      }

      if (user) {
        if (signInBtn) signInBtn.classList.add('hidden');
        if (signOutBtn) signOutBtn.classList.remove('hidden');
        if (authStatus) authStatus.textContent = `Signed in as ${user.email}`;
        if (authPage) authPage.classList.add('hidden');
      } else {
        if (signInBtn) signInBtn.classList.remove('hidden');
        if (signOutBtn) signOutBtn.classList.add('hidden');
        if (authStatus) authStatus.textContent = 'Not signed in';
        if (mainContent) mainContent.style.display = 'none';
        if (authPage) authPage.classList.remove('hidden');
      }
    }

    async function signInUser(event) {
      event.preventDefault();
      
      // Find the submit button and set loading state
      const submitBtn = event.target.querySelector('button[type="submit"]');
      if (submitBtn) {
        setButtonLoadingState(submitBtn.id || 'signInBtn', true, 'Signing In...', 'Sign In');
      }
      
      try {
        const email = document.getElementById('authEmail').value.trim();
        const password = document.getElementById('authPassword').value;
        await auth.signInWithEmailAndPassword(email, password);
        showToast('Signed in successfully!', 'success');
      } catch (error) {
        console.error('Sign in error:', error);
        showToast('Sign in failed: ' + (error && error.message ? error.message : 'An unknown error occurred.'), 'error');
      } finally {
        // Restore loading state
        if (submitBtn) {
          setButtonLoadingState(submitBtn.id || 'signInBtn', false, null, 'Sign In');
        }
      }
    }

    async function signUpUser(event) {
      event.preventDefault();
      
      // Find the submit button and set loading state
      const submitBtn = event.target.querySelector('button[type="submit"]');
      if (submitBtn) {
        setButtonLoadingState(submitBtn.id || 'signUpBtn', true, 'Creating Account...', 'Sign Up');
      }
      
      try {
        const email = document.getElementById('authEmail').value.trim();
        const password = document.getElementById('authPassword').value;
        justSignedUp = true;
        await auth.createUserWithEmailAndPassword(email, password);
        await auth.signOut();
        showToast('Account created successfully! Please sign in.', 'success');
        if (!isSignInMode) {
          toggleAuthMode({ preventDefault: () => {} });
        }
      } catch (error) {
        console.error('Sign up error:', error);
        if (error.code === 'auth/email-already-in-use') {
          showToast('This email is already registered. Please sign in.', 'error');
          if (!isSignInMode) {
            toggleAuthMode({ preventDefault: () => {} });
          }
        } else {
          showToast('Sign up failed: ' + (error && error.message ? error.message : 'An unknown error occurred.'), 'error');
        }
        justSignedUp = false;
      } finally {
        // Restore loading state
        if (submitBtn) {
          setButtonLoadingState(submitBtn.id || 'signUpBtn', false, null, 'Sign Up');
        }
      }
    }

    async function signOutUser() {
      // Find the sign out button and set loading state
      const signOutBtn = document.getElementById('signOutBtn');
      if (signOutBtn) {
        setButtonLoadingState(signOutBtn.id || 'signOutBtn', true, 'Signing Out...', 'Sign Out');
      }
      
      try {
        await auth.signOut();
        showToast('Signed out successfully!', 'success');
      } catch (error) {
        showToast('Sign out failed: ' + (error && error.message ? error.message : 'An unknown error occurred.'), 'error');
      } finally {
        // Restore loading state
        if (signOutBtn) {
          setButtonLoadingState(signOutBtn.id || 'signOutBtn', false, null, 'Sign Out');
        }
      }
    }

    // --- Toast Notifications ---
    let toastTimeout = null;
    function showToast(message, type = 'info') {
        const toast = document.getElementById('toast');
        if (!toast) return;
        const iconSpan = toast.querySelector('.toast-icon');
        const msgSpan = toast.querySelector('.toast-message');
        const closeBtn = document.getElementById('toastCloseBtn');
        let icon = '';
        if (type === 'success') icon = '✅';
        else if (type === 'error') icon = '❌';
        else icon = 'ℹ️';
        if (iconSpan) {
          iconSpan.textContent = icon;
          iconSpan.style.display = 'inline-flex';
        }
        if (msgSpan) msgSpan.textContent = message;
        toast.className = 'toast toast-animate ' + type;
        // Animate in
        setTimeout(() => {
          toast.classList.add('toast-animate-in');
        }, 10);
        if (closeBtn) {
          closeBtn.style.display = 'inline-block';
          closeBtn.onclick = function() {
            hideToast();
            if (toastTimeout) clearTimeout(toastTimeout);
          };
        }
        if (toastTimeout) clearTimeout(toastTimeout);
        toastTimeout = setTimeout(() => {
            hideToast();
        }, 3000);
    }
    function hideToast() {
      const toast = document.getElementById('toast');
      if (!toast) return;
      toast.classList.remove('toast-animate-in');
      toast.classList.add('toast-animate-out');
      setTimeout(() => {
        toast.classList.remove('toast-animate-out');
        toast.classList.remove('show');
        toast.className = 'toast toast-animate';
        const closeBtn = document.getElementById('toastCloseBtn');
        if (closeBtn) closeBtn.style.display = 'none';
      }, 400);
    }
    
    // Function to navigate from workflow tab to account management create account
    function goToCreateAccount() {
      // Switch to account management tab
      showTab('account');
      
      // Wait for tab to load and then focus on the account name field
      setTimeout(() => {
        // Show the workflow redirect notice
        const redirectNotice = document.getElementById('workflowRedirectNotice');
        if (redirectNotice) {
          redirectNotice.classList.remove('hidden');
          // Auto-hide the notice after 8 seconds
          setTimeout(() => {
            redirectNotice.classList.add('hidden');
          }, 8000);
        }
        
        const accountNameField = document.getElementById('accountName');
        if (accountNameField) {
          // Scroll to the create account form
          accountNameField.scrollIntoView({ behavior: 'smooth', block: 'start' });
          // Focus on the first input field after a brief delay
          setTimeout(() => {
            accountNameField.focus();
          }, 500);
          // Add a subtle highlight effect
          const form = document.getElementById('accountForm');
          if (form) {
            form.style.border = '2px solid var(--barclays-blue)';
            form.style.borderRadius = '0.5rem';
            setTimeout(() => {
              form.style.border = '';
            }, 3000);
          }
        }
      }, 100);
      
      // Show a helpful toast message
      showToast('Switched to Account Management - Create your account below', 'info');
    }
    
    // --- Global Exposures ---
    // Expose functions to the global scope to be accessible by inline event handlers
    window.showToast = showToast;
    window.showTab = showTab;
    window.openSignInModal = openSignInModal;
    window.signOutUser = signOutUser;
    window.toggleAuthMode = toggleAuthMode;
    window.signInUser = signInUser;
    window.signUpUser = signUpUser;
    window.generateAccountIdAndSave = generateAccountIdAndSave;
    window.goToCreateAccount = goToCreateAccount;
    window.addAccountToWorkflowTable = addAccountToWorkflowTable;
    window.validateField = validateField;
    window.updateButtonState = updateButtonState;
    window.updateAccountIdPreview = updateAccountIdPreview;
    window.showAccountTypeFields = showAccountTypeFields;
    window.promptAccess = promptAccess;
    window.refreshAccounts = refreshAccounts;
    window.downloadAccountsCSV = downloadAccountsCSV;
    window.prevAccountsPage = prevAccountsPage;
    window.nextAccountsPage = nextAccountsPage;
    window.openEditAccountModal = openEditAccountModal;
    window.deleteAccount = deleteAccount;
    window.closeEditAccountModal = closeEditAccountModal;
    window.showEditAccountTypeFields = showEditAccountTypeFields;
    window.cancelAdminPasskey = cancelAdminPasskey;
    window.compareCSVFiles = compareCSVFiles;
    window.storeReconciliationData = storeReconciliationData;
    window.clearCSVData = clearCSVData;
    window.loadReconciliationRecords = loadReconciliationRecords;
    window.prevReconciliationPage = prevReconciliationPage;
    window.nextReconciliationPage = nextReconciliationPage;
    window.deleteBatch = deleteBatch;
    window.loadTradeRecords = loadTradeRecords;
    window.onTradeSearchInput = onTradeSearchInput;
    window.onTradeFilterChange = onTradeFilterChange;
    window.nextTradePage = nextTradePage;
    window.prevTradePage = prevTradePage;
    window.openEditTradeModal = openEditTradeModal;
    window.closeEditTradeModal = closeEditTradeModal;
    window.deleteTradeRecord = deleteTradeRecord;
    window.deleteAllAccounts = deleteAllAccounts;
    window.maybeShowAccountIdPreview = maybeShowAccountIdPreview;
    window.downloadMismatchesCSV = downloadMismatchesCSV;
    window.viewBatchMismatches = viewBatchMismatches;
    window.closeMismatchesModal = closeMismatchesModal;
    window.downloadBatchMismatches = downloadBatchMismatches;

    // --- App Entry Point ---
    document.addEventListener('DOMContentLoaded', initApp);

    // Failsafe: Ensure workflow tab is opened after page is fully loaded
    window.addEventListener('load', () => {
      setTimeout(() => {
        // Double-check that workflow tab is active
        const workflowTab = document.getElementById('workflow');
        const workflowBtn = document.getElementById('tab-workflow');
        if (workflowTab && workflowBtn && workflowTab.classList.contains('hidden')) {
          showTab('workflow');
        }
      }, 200);
    });

    // Expose db and firebase globally for demo/data injection
    window.db = db;
    window.firebase = firebase;



    // --- Trade Table State ---
    let tradePageSize = 25; // Show 25 trade records per page in Trade Upload section
    let tradeCurrentPage = 1;
    let tradeLastVisible = null;
    let tradeFirstVisible = null;
    let tradePrevPageStarts = [];
    let tradeSearchTerm = '';
    let tradeUploadedByFilter = '';
    let tradeDateFrom = '';
    let tradeDateTo = '';
    let tradeTraderIdFilter = '';
    let tradeDeskFilter = '';
    let tradeBatchIdFilter = '';
    let tradeLoadAll = false;
    let tradeLastQuerySnapshot = null;

    function onTradeSearchInput() {
      tradeSearchTerm = document.getElementById('tradeSearchInput').value.trim();
      tradeCurrentPage = 1;
      tradePrevPageStarts = [];
      window.loadTradeRecords(tradeLoadAll);
    }
    function onTradeFilterChange() {
      tradeUploadedByFilter = document.getElementById('tradeUploadedByFilter').value;
      tradeDateFrom = document.getElementById('tradeDateFrom').value;
      tradeDateTo = document.getElementById('tradeDateTo').value;
      tradeTraderIdFilter = document.getElementById('tradeTraderIdFilter') ? document.getElementById('tradeTraderIdFilter').value : '';
      tradeDeskFilter = document.getElementById('tradeDeskFilter') ? document.getElementById('tradeDeskFilter').value : '';
      tradeBatchIdFilter = document.getElementById('tradeBatchIdFilter') ? document.getElementById('tradeBatchIdFilter').value : '';
      tradeCurrentPage = 1;
      tradePrevPageStarts = [];
      window.loadTradeRecords(tradeLoadAll);
    }
    function nextTradePage() {
      if (tradeLastVisible && tradeLastQuerySnapshot && tradeLastQuerySnapshot.size === tradePageSize) {
        tradePrevPageStarts.push(tradeFirstVisible);
        tradeCurrentPage++;
        window.loadTradeRecords(false, tradeLastVisible);
      }
    }
    function prevTradePage() {
      const prevStart = tradePrevPageStarts.pop();
      tradeCurrentPage = Math.max(1, tradeCurrentPage - 1);
      window.loadTradeRecords(tradeLoadAll, prevStart);
    }

    async function loadTradeRecords(loadAll = false, startAfterDoc = null) {
      tradeLoadAll = loadAll;
      const tableHead = document.getElementById('tradeRecordsTableHead');
      const tableBody = document.getElementById('tradeRecordsTableBody');
      const noDataMessage = document.getElementById('noTradeRecordsMessage');
      const viewAllBtn = document.getElementById('viewAllTradesBtn');
      const showRecentBtn = document.getElementById('showRecentTradesBtn');
      const viewAllLoader = document.getElementById('viewAllTradesBtnLoader');
      const showRecentLoader = document.getElementById('showRecentTradesBtnLoader');
      const pagination = document.getElementById('tradePaginationControls');
      const prevBtn = document.getElementById('tradePrevBtn');
      const nextBtn = document.getElementById('tradeNextBtn');
      const pageInfo = document.getElementById('tradePageInfo');
      if (viewAllBtn) viewAllBtn.disabled = false;
      if (showRecentBtn) showRecentBtn.disabled = false;
      if (viewAllLoader) viewAllLoader.classList.remove('visible');
      if (showRecentLoader) showRecentLoader.classList.remove('visible');
      tableHead.innerHTML = '';
      tableBody.innerHTML = '';
      noDataMessage.classList.add('hidden');
      if (pagination) pagination.classList.remove('hidden');
      if (prevBtn) prevBtn.disabled = true;
      if (nextBtn) nextBtn.disabled = true;
      if (pageInfo) pageInfo.textContent = '';
      if (loadAll) {
        if (viewAllBtn) viewAllBtn.disabled = true;
        if (viewAllLoader) viewAllLoader.classList.add('visible');
      } else {
        if (showRecentBtn) showRecentBtn.disabled = true;
        if (showRecentLoader) showRecentLoader.classList.add('visible');
      }
      try {
        let query = db.collection('trades').orderBy('uploadedAt', 'desc');
        if (tradeUploadedByFilter) {
          query = query.where('uploadedBy', '==', tradeUploadedByFilter);
        }
        if (tradeTraderIdFilter) {
          query = query.where('traderId', '==', tradeTraderIdFilter);
        }
        if (tradeDeskFilter) {
          query = query.where('desk', '==', tradeDeskFilter);
        }
        if (tradeBatchIdFilter) {
          query = query.where('batchId', '==', tradeBatchIdFilter);
        }
        if (tradeDateFrom) {
          const fromDate = new Date(tradeDateFrom);
          query = query.where('uploadedAt', '>=', fromDate);
        }
        if (tradeDateTo) {
          const toDate = new Date(tradeDateTo);
          toDate.setHours(23,59,59,999);
          query = query.where('uploadedAt', '<=', toDate);
        }
        const LIMIT = tradePageSize;
        if (startAfterDoc) {
          query = query.startAfter(startAfterDoc);
        }
        query = query.limit(LIMIT);
        const snapshot = await query.get();
        tradeLastQuerySnapshot = snapshot;
        if (snapshot.empty) {
          if (tradeCurrentPage > 1) {
            // Go back to previous page if no records
            tradeCurrentPage--;
            tradePrevPageStarts.pop();
            window.loadTradeRecords(false, tradePrevPageStarts[tradePrevPageStarts.length - 1]);
            return;
          }
          noDataMessage.classList.remove('hidden');
          if (pagination) pagination.classList.add('hidden');
          return;
        }
        // Use fixed column order and display names for header
        const TRADE_TABLE_COLUMNS = [
          { key: "Client ID", label: "Client ID" },
          { key: "Trade ID", label: "Trade ID" },
          { key: "Order ID", label: "Order ID" },
          { key: "Trade Date", label: "Trade Date" },
          { key: "Settlement Date", label: "Settlement Date" },
          { key: "Symbol", label: "Symbol" },
          { key: "ISIN", label: "ISIN" },
          { key: "Trade Type", label: "Trade Type" },
          { key: "Quantity", label: "Quantity" },
          { key: "Price", label: "Price" },
          { key: "Currency", label: "Currency" },
          { key: "FX Rate Applied", label: "FX Rate Applied" },
          { key: "Net Amount", label: "Net Amount" },
          { key: "Total Cost", label: "Total Cost" },
          { key: "Commission", label: "Commission" },
          { key: "Taxes", label: "Taxes" },
          { key: "Collateral Required", label: "Collateral Required" },
          { key: "Margin Type", label: "Margin Type" },
          { key: "Margin Status", label: "Margin Status" },
          { key: "Market Impact Cost", label: "Market Impact Cost" },
          { key: "Confirmation Status", label: "Confirmation Status" },
          { key: "Settlement Status", label: "Settlement Status" },
          { key: "Reference Data Validated", label: "Reference Data Validated" },
          { key: "KYC Status", label: "KYC Status" },
          { key: "Counterparty", label: "Counterparty" },
          { key: "Trading Venue", label: "Trading Venue" },
          { key: "Pricing Source", label: "Pricing Source" },
          { key: "Ops Team Notes", label: "Ops Team Notes" },
          { key: "batchId", label: "Batch ID" },
          { key: "desk", label: "Desk" },
          { key: "Trader Name", label: "Trader Name" },
          { key: "uploadedBy", label: "Uploaded By" },
          { key: "uploadedAt", label: "Uploaded At" }
        ];
        tableHead.innerHTML = '<tr>' +
          TRADE_TABLE_COLUMNS.map(col => `<th class="border border-gray-300 p-2">${col.label}</th>`).join('') +
          '<th class="border border-gray-300 p-2">Actions</th>' +
          '</tr>';
        let rows = '';
        let found = false;
        snapshot.forEach(doc => {
          const rec = doc.data();
          // Search filter (client-side for now)
          if (tradeSearchTerm) {
            const searchStr = JSON.stringify(rec).toLowerCase();
            if (!searchStr.includes(tradeSearchTerm.toLowerCase())) return;
          }
          found = true;
          rows += '<tr>' +
            TRADE_TABLE_COLUMNS.map(col => {
              if (col.key === "uploadedAt") {
                let displayValue = "";
                const val = rec.uploadedAt;
                if (val) {
                  if (typeof val.toDate === "function") {
                    displayValue = val.toDate().toLocaleString();
                  } else if (
                    typeof val === "object" &&
                    val.seconds !== undefined &&
                    val.nanoseconds !== undefined
                  ) {
                    displayValue = new Date(
                      val.seconds * 1000 + Math.floor(val.nanoseconds / 1e6)
                    ).toLocaleString();
                  } else {
                    displayValue = String(val);
                  }
                }
                return `<td class="border border-gray-300 p-2">${displayValue}</td>`;
              }
              return `<td class="border border-gray-300 p-2">${rec[col.key] || ""}</td>`;
            }).join('') +
            `<td class="border border-gray-300 p-2 text-center">\n          <button onclick=\"openEditTradeModal('${doc.id}')\" class=\"text-blue-500 hover:underline mr-2\">Edit</button>\n          <button onclick=\"deleteTradeRecord('${doc.id}')\" class=\"text-red-500 hover:underline\">Delete</button>\n        </td></tr>`;
        });
        tableBody.innerHTML = found ? rows : `<tr><td colspan=\"100\" class=\"border p-4 text-center text-gray-400\">No records match your search/filter.</td></tr>`;
        // Pagination
        tradeFirstVisible = snapshot.docs[0];
        tradeLastVisible = snapshot.docs[snapshot.docs.length - 1];
        if (prevBtn) prevBtn.disabled = tradePrevPageStarts.length === 0;
        if (nextBtn) nextBtn.disabled = snapshot.size < LIMIT;
        if (pageInfo) pageInfo.textContent = `Page ${tradeCurrentPage}`;
        // Populate Uploaded By, TraderId, Desk, BatchId filters
        const uploadedBySet = new Set();
        const traderIdSet = new Set();
        const deskSet = new Set();
        const batchIdSet = new Set();
        const allTradesSnap = await db.collection('trades').limit(1000).get();
        allTradesSnap.forEach(doc => {
          const rec = doc.data();
          if (rec.uploadedBy) uploadedBySet.add(rec.uploadedBy);
          if (rec.traderId) traderIdSet.add(rec.traderId);
          if (rec.desk) deskSet.add(rec.desk);
          if (rec.batchId) batchIdSet.add(rec.batchId);
        });
        const uploadedByFilter = document.getElementById('tradeUploadedByFilter');
        if (uploadedByFilter) {
          const current = uploadedByFilter.value;
          uploadedByFilter.innerHTML = '<option value="">All</option>' + Array.from(uploadedBySet).map(u => `<option value="${u}">${u}</option>`).join('');
          uploadedByFilter.value = current;
        }
        const traderIdFilter = document.getElementById('tradeTraderIdFilter');
        if (traderIdFilter) {
          const current = traderIdFilter.value;
          traderIdFilter.innerHTML = '<option value="">All</option>' + Array.from(traderIdSet).map(u => `<option value="${u}">${u}</option>`).join('');
          traderIdFilter.value = current;
        }
        const deskFilter = document.getElementById('tradeDeskFilter');
        if (deskFilter) {
          const current = deskFilter.value;
          deskFilter.innerHTML = '<option value="">All</option>' + Array.from(deskSet).map(u => `<option value="${u}">${u}</option>`).join('');
          deskFilter.value = current;
        }
        const batchIdFilter = document.getElementById('tradeBatchIdFilter');
        if (batchIdFilter) {
          const current = batchIdFilter.value;
          batchIdFilter.innerHTML = '<option value="">All</option>' + Array.from(batchIdSet).map(u => `<option value="${u}">${u}</option>`).join('');
          batchIdFilter.value = current;
        }
      } catch (error) {
        noDataMessage.classList.remove('hidden');
        tableBody.innerHTML = '<tr><td colspan=\"100\" class=\"border p-4 text-center text-red-500\">Failed to load trade records.</td></tr>';
        console.error(error);
      } finally {
        if (viewAllBtn) viewAllBtn.disabled = false;
        if (showRecentBtn) showRecentBtn.disabled = false;
        if (viewAllLoader) viewAllLoader.classList.remove('visible');
        if (showRecentLoader) showRecentLoader.classList.remove('visible');
      }
    }

    async function openEditTradeModal(tradeId) {
      const doc = await db.collection('trades').doc(tradeId).get();
      if (!doc.exists) {
        showToast('Trade record not found.', 'error');
        return;
      }
      const rec = doc.data();
      const form = document.getElementById('editTradeForm');
      form.innerHTML = '';
      Object.keys(rec).forEach(key => {
        if (key === 'uploadedAt' || key === 'uploadedBy') return;
        form.innerHTML += `
          <div>
            <label class="block text-sm font-medium mb-2">${key}</label>
            <input name="${key}" type="text" value="${rec[key] || ''}" class="w-full border border-gray-300 p-3 rounded-lg" />
          </div>
        `;
      });
      form.innerHTML += `
        <div class="flex gap-4 pt-2">
          <button type="submit" class="barclays-btn px-6 py-3 rounded-lg font-medium">Save Changes</button>
          <button type="button" onclick="closeEditTradeModal()" class="barclays-secondary-btn px-6 py-3 rounded-lg font-medium">Cancel</button>
        </div>
        <input type="hidden" name="tradeId" value="${tradeId}" />
      `;
      form.onsubmit = saveEditTrade;
      showModal('editTradeModal');
    }

    function closeEditTradeModal() {
      hideModal('editTradeModal');
    }

    async function saveEditTrade(event) {
      event.preventDefault();
      const form = event.target;
      const tradeId = form.tradeId.value;
      const updateData = {};
      Array.from(form.elements).forEach(el => {
        if (el.name && el.name !== 'tradeId') updateData[el.name] = el.value;
      });
      try {
        await db.collection('trades').doc(tradeId).update(updateData);
        showToast('Trade record updated successfully!', 'success');
        closeEditTradeModal();
        loadTradeRecords();
      } catch (error) {
        showToast('Failed to update trade record.', 'error');
        console.error(error);
      }
    }

    async function deleteTradeRecord(tradeId) {
      if (!confirm('Are you sure you want to delete this trade record? This action cannot be undone.')) return;
      try {
        await db.collection('trades').doc(tradeId).delete();
        showToast('Trade record deleted successfully!', 'success');
        loadTradeRecords();
      } catch (error) {
        showToast('Failed to delete trade record.', 'error');
        console.error(error);
      }
    }



    // In the loadTradeRecords function, update the table rendering logic to include checkboxes
    // ... existing code ...
    // Replace the table header rendering:
    // ... existing code ...
    // Add the following JavaScript functions near the other Trade Upload JS functions:

    // ... existing code ...

    const accountStatusEl = document.getElementById('accountStatus');
    if (accountStatusEl) {
      accountStatusEl.addEventListener('change', updateButtonState);
    }
    const editAccountStatusEl = document.getElementById('editAccountStatus');
    if (editAccountStatusEl) {
      editAccountStatusEl.addEventListener('change', function() {
        const closureDateField = document.getElementById('editAccountClosureDate');
        if (closureDateField) closureDateField.disabled = this.value !== 'Closed';
      });
    }

    // --- Fetch Next Account ID Preview ---
    async function fetchNextAccountIdPreview() {
      try {
        if (!db) return;
        const counterDoc = await db.collection('counters').doc('corporate_accounts').get();
        let nextId = 1;
        if (counterDoc.exists && counterDoc.data().nextId) {
          nextId = counterDoc.data().nextId;
        }
        const previewId = 'BARC-C' + String(nextId).padStart(4, '0');
        document.getElementById('accountId').value = previewId;
      } catch (e) {
        document.getElementById('accountId').value = '';
      }
    }

    async function deleteAllAccounts() {
      if (!confirm('Are you sure you want to delete ALL accounts? This action cannot be undone!')) return;
      
      // Find the delete all button and set loading state
      const deleteAllBtn = document.querySelector('button[onclick="deleteAllAccounts()"]');
      if (deleteAllBtn) {
        setButtonLoadingState(deleteAllBtn.id || 'deleteAllAccountsBtn', true, 'Deleting All...', 'Delete All Accounts');
      }
      
      try {
        const confirmed = await requestAdminPasskey();
        if (!confirmed) return;
        
        const snapshot = await db.collection('accounts').get();
        if (snapshot.empty) {
          showToast('No accounts to delete.', 'info');
          return;
        }
        const batch = db.batch();
        snapshot.forEach(doc => batch.delete(doc.ref));
        await batch.commit();
        await logAudit('delete_all_accounts', { count: snapshot.size });
        showToast('All accounts deleted!', 'success');
        refreshAccounts();
      } catch (e) {
        showToast('Failed to delete all accounts.', 'error');
        console.error(e);
      } finally {
        // Restore loading state
        if (deleteAllBtn) {
          setButtonLoadingState(deleteAllBtn.id || 'deleteAllAccountsBtn', false, null, 'Delete All Accounts');
        }
      }
    }

    // --- Show Account ID Preview Only When Name and Email Are Filled ---
    function maybeShowAccountIdPreview() {
      const name = document.getElementById('accountName').value.trim();
      const email = document.getElementById('contactEmail').value.trim();
      if (name && email) {
        fetchNextAccountIdPreview();
      } else {
        document.getElementById('accountId').value = '';
      }
    }

    // --- Account Request Portal Logic ---
    function showARSubTab(tab) {
      document.querySelectorAll('.ar-subtab').forEach(el => el.classList.add('hidden'));
      document.querySelectorAll('.ar-tab-btn').forEach(el => {
        el.classList.remove('active-tab');
        el.classList.add('inactive-tab');
      });
      document.getElementById('ar-' + tab).classList.remove('hidden');
      document.getElementById('ar-tab-' + tab).classList.add('active-tab');
      document.getElementById('ar-tab-' + tab).classList.remove('inactive-tab');
      if (tab === 'status') loadAccountRequests();
    }
    window.showARSubTab = showARSubTab;



    async function loadAccountRequests() {
      // Set loading state for refresh button
      const refreshBtn = document.querySelector('button[onclick="loadAccountRequests()"]');
      if (refreshBtn) {
        setButtonLoadingState(refreshBtn.id || 'loadAccountRequestsBtn', true, 'Loading...', 'Refresh');
      }
      
      const tbody = document.getElementById('arRequestsTableBody');
      tbody.innerHTML = `<tr class="skeleton-table-row">
        <td colspan="8">
          <div class="flex space-x-2">
            <div class="skeleton" style="width: 60px; height: 20px;"></div>
            <div class="skeleton" style="width: 100px; height: 20px;"></div>
            <div class="skeleton" style="width: 160px; height: 20px;"></div>
            <div class="skeleton" style="width: 100px; height: 20px;"></div>
            <div class="skeleton" style="width: 180px; height: 20px;"></div>
            <div class="skeleton" style="width: 80px; height: 20px;"></div>
            <div class="skeleton" style="width: 120px; height: 20px;"></div>
            <div class="skeleton" style="width: 120px; height: 20px;"></div>
          </div>
        </td>
      </tr>`;
      
      try {
        const snap = await db.collection('account_requests').orderBy('submittedAt', 'desc').limit(100).get();
        
        // Convert snapshot to array and store in allRequestData
        allRequestData = [];
        snap.forEach(doc => {
          const r = doc.data();
          allRequestData.push({
            ...r,
            docId: doc.id
          });
        });
        
        // Debug: Log the loaded data
        console.log('Loaded request data:', allRequestData);
        console.log('Sample status values:', allRequestData.map(r => r.status));
        console.log('Sample type values:', allRequestData.map(r => r.type));
        
        // Apply current filters and sorting
        filteredRequestData = [...allRequestData];
        if (Object.values(currentRequestFilters).some(filter => filter !== '')) {
          filterRequestData();
        }
        
        // Render the table
        renderRequestTable();
        
      } catch (e) {
        tbody.innerHTML = '<tr><td colspan="8" class="p-4 text-center text-red-500"><span style="font-size:1.3em;vertical-align:middle;">📭</span> Failed to load requests.</td></tr>';
      } finally {
        // Restore loading state
        if (refreshBtn) {
          setButtonLoadingState(refreshBtn.id || 'loadAccountRequestsBtn', false, null, 'Refresh');
        }
      }
    }
    window.loadAccountRequests = loadAccountRequests;

    async function updateAccountRequestStatus(docId, newStatus) {
      try {
        await db.collection('account_requests').doc(docId).update({ status: newStatus });
        showToast('Request status updated!', 'success');
        loadAccountRequests();
      } catch (e) {
        showToast('Failed to update status.', 'error');
      }
    }
    window.updateAccountRequestStatus = updateAccountRequestStatus;

    // Load requests when the tab is shown
    const origShowTabAR = showTab;
    showTab = function(tab) {
      origShowTabAR(tab);
      if (tab === 'accountrequest') {
        loadAccountRequests();
      }
    }
    window.showTab = showTab;
    // Approve & Create Account Modal Logic
    let currentApproveRequestId = null;
    async function openApproveRequestModal(requestId) {
      currentApproveRequestId = requestId;
      const doc = await db.collection('account_requests').doc(requestId).get();
      if (!doc.exists) {
        showToast('Request not found.', 'error');
        return;
      }
      const r = doc.data();
      const form = document.getElementById('approveRequestForm');
      form.innerHTML = `
        <div><label class='block text-sm font-medium mb-2'>Agent Bank Name</label><input name='name' type='text' class='w-full border border-gray-300 p-3 rounded-lg' value='${r.name || ''}' required /></div>
        <div><label class='block text-sm font-medium mb-2'>Contact Email</label><input name='email' type='email' class='w-full border border-gray-300 p-3 rounded-lg' value='${r.email || ''}' required /></div>
        <div><label class='block text-sm font-medium mb-2'>LEI</label><input name='lei' type='text' class='w-full border border-gray-300 p-3 rounded-lg' value='${r.lei || ''}' /></div>
        <div><label class='block text-sm font-medium mb-2'>Status</label><select name='status' class='w-full border border-gray-300 p-3 rounded-lg'><option value='Active' ${r.status==='Active'?'selected':''}>Active</option><option value='Dormant' ${r.status==='Dormant'?'selected':''}>Dormant</option><option value='Closed' ${r.status==='Closed'?'selected':''}>Closed</option></select></div>
        <div><label class='block text-sm font-medium mb-2'>Account Closure Date</label><input name='accountClosureDate' type='date' class='w-full border border-gray-300 p-3 rounded-lg' value='${r.accountClosureDate || ''}' /></div>
        <div><label class='block text-sm font-medium mb-2'>Details</label><textarea name='details' class='w-full border border-gray-300 p-3 rounded-lg'>${r.details || ''}</textarea></div>
        <div class='flex gap-4 pt-2'><button type='submit' class='barclays-btn px-6 py-3 rounded-lg font-medium'>Approve & Create Account</button><button type='button' onclick='closeApproveRequestModal()' class='bg-gray-300 hover:bg-gray-400 text-gray-700 px-6 py-3 rounded-lg font-medium'>Cancel</button></div>
      `;
      form.onsubmit = approveAndCreateAccount;
      showModal('approveRequestModal');
    }
    window.openApproveRequestModal = openApproveRequestModal;
    function closeApproveRequestModal() {
      hideModal('approveRequestModal');
      currentApproveRequestId = null;
    }
    async function approveAndCreateAccount(event) {
      event.preventDefault();
      
      // Find the submit button and set loading state
      const submitBtn = event.target.querySelector('button[type="submit"]');
      if (submitBtn) {
        setButtonLoadingState(submitBtn.id || 'approveAndCreateBtn', true, 'Creating...', 'Approve & Create Account');
      }
      
      try {
        const confirmed = await requestAdminPasskey();
        if (!confirmed) return;
        
        const form = event.target;
        const data = Object.fromEntries(new FormData(form).entries());
        
        // Create account in accounts collection with enhanced linking
        const accountData = {
          name: data.name,
          email: data.email,
          lei: data.lei,
          status: data.status,
          accountOpeningDate: firebase.firestore.FieldValue.serverTimestamp(),
          accountClosureDate: data.accountClosureDate ? new Date(data.accountClosureDate) : null,
          details: data.details,
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          createdBy: currentUser ? currentUser.uid : 'admin',
          lastModified: firebase.firestore.FieldValue.serverTimestamp(),
          
          // Enhanced Unified Data Model Fields
          lifecycleStatus: 'Account Created', // Status in the lifecycle chain
          requestId: currentApproveRequestId, // Link to originating request
          workflowStatus: 'In Workflow', // Status in workflow processing
          statusHistory: [
            {
              status: 'Requested',
              timestamp: new Date(Date.now() - 24*60*60*1000), // Use new Date() - simulate request was 1 day ago
              triggeredBy: 'system',
              source: 'Account Request Portal',
              notes: 'Original request submitted'
            },
            {
              status: 'Approved',
              timestamp: new Date(Date.now() - 60*1000), // 1 minute ago
              triggeredBy: currentUser ? currentUser.uid : 'admin',
              source: 'Account Request Portal',
              notes: 'Request approved by admin'
            },
            {
              status: 'Account Created',
              timestamp: new Date(), // Use new Date() instead of serverTimestamp in arrays
              triggeredBy: currentUser ? currentUser.uid : 'admin',
              source: 'Account Request Portal',
              notes: 'Account created from approved request'
            }
          ],
          crossReferences: {
            requestId: currentApproveRequestId,
            workflowId: null, // Will be set after account ID generation
            processedBy: [currentUser ? currentUser.uid : 'admin']
          }
        };
        // Auto-generate Account ID
        let newAccountId = '';
        const counterDocId = 'corporate_accounts';
        const prefix = 'BARC-C';
        await db.runTransaction(async (transaction) => {
          const counterRef = db.collection('counters').doc(counterDocId);
          const counterDoc = await transaction.get(counterRef);
          let nextId = 1;
          if (counterDoc.exists && counterDoc.data().nextId) {
            nextId = counterDoc.data().nextId;
            newAccountId = prefix + String(nextId).padStart(4, '0');
            transaction.update(counterRef, { nextId: nextId + 1 });
          } else {
            newAccountId = prefix + '0001';
            transaction.set(counterRef, { nextId: 2 });
          }
        });
        accountData.id = newAccountId;
        accountData.crossReferences.workflowId = newAccountId; // Set workflow ID
        
        // Create account with enhanced cross-referencing
        await db.collection('accounts').doc(newAccountId).set(accountData);
        
        // Update request status with account link and mark as completed
        await db.collection('account_requests').doc(currentApproveRequestId).update({ 
          status: 'approved',
          linkedAccountId: newAccountId,
          processedAt: firebase.firestore.FieldValue.serverTimestamp(),
          processedBy: currentUser ? currentUser.uid : 'admin',
          lifecycleStatus: 'Completed', // Mark as completed since account was created
          completedAt: firebase.firestore.FieldValue.serverTimestamp(),
          flowStatus: 'Request Completed - Account Created' // Add flow status tracking
        });
        
        // Add to workflow with enhanced data
        const workflowData = {
          accountId: newAccountId,
          name: accountData.name,
          lei: accountData.lei,
          status: accountData.status,
          source: 'Account Request',
          requestId: currentApproveRequestId,
          addedAt: firebase.firestore.FieldValue.serverTimestamp(),
          lifecycleStatus: 'In Workflow'
        };
        
        // Add account to workflow table visually
        await addAccountToWorkflowTable({
          name: accountData.name,
          id: accountData.id,
          lei: accountData.lei,
          status: accountData.status,
          source: 'Request Approved',
          requestId: currentApproveRequestId
        });
        
        showToast('🎯 Request completed! Account created and added to workflow.', 'success');
        
        // Show success notification with navigation options
        setTimeout(() => {
          const notification = document.createElement('div');
          notification.className = 'fixed bottom-4 right-4 p-4 rounded-lg shadow-lg z-50 border-l-4 border-green-500';
          notification.style.background = 'var(--barclays-surface)';
          notification.style.color = 'var(--barclays-text)';
          notification.innerHTML = `
            <div class="flex flex-col gap-2">
              <div class="flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="barclays-icon text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                <span class="text-sm font-medium">Account ${newAccountId} created from request!</span>
              </div>
              <div class="flex gap-2 text-xs">
                <button onclick="showTab('account'); this.parentElement.parentElement.parentElement.remove();" class="barclays-secondary-btn px-2 py-1 rounded">
                  View in Account Management
                </button>
                <button onclick="showTab('workflow'); this.parentElement.parentElement.parentElement.remove();" class="barclays-btn px-2 py-1 rounded">
                  View in Workflow
                </button>
                <button onclick="this.parentElement.parentElement.parentElement.remove();" class="text-gray-400 hover:text-gray-600">×</button>
              </div>
            </div>
          `;
          document.body.appendChild(notification);
          
          // Auto-remove after 10 seconds
          setTimeout(() => {
            if (notification.parentElement) {
              notification.remove();
            }
          }, 10000);
        }, 1000);
        
        closeApproveRequestModal();
        loadAccountRequests();
        refreshAccounts && refreshAccounts();
      } catch (e) {
        showToast('Failed to create account: ' + (e && e.message ? e.message : 'Unknown error'), 'error');
      } finally {
        // Restore loading state
        if (submitBtn) {
          setButtonLoadingState(submitBtn.id || 'approveAndCreateBtn', false, null, 'Approve & Create Account');
        }
      }
    }
    window.closeApproveRequestModal = closeApproveRequestModal;



    
    // Add new functions for handling completion and rejection
    async function markRequestCompleted() {
      const form = document.getElementById('integratedAccountRequestForm');
      const data = Object.fromEntries(new FormData(form).entries());
      const req = {
        type: data.type,
        team: data.team,
        email: data.email,
        accountId: data.accountId || '',
        details: data.details,
        status: 'completed',
        submittedAt: firebase.firestore.FieldValue.serverTimestamp(),
        completedAt: firebase.firestore.FieldValue.serverTimestamp(),
        adminOnly: true
      };
      try {
        await db.collection('account_requests').add(req);
        form.reset();
        showToast('Request marked as completed successfully!', 'success');
        loadAccountRequests();
      } catch (e) {
        showToast('Failed to complete request. Please try again.', 'error');
      }
    }
    window.markRequestCompleted = markRequestCompleted;

    window.approveRequest = approveRequest;

    async function requestRejectAccountRequest(docId) {
      const confirmed = await requestAdminPasskey();
      if (!confirmed) return;
      updateAccountRequestStatus(docId, 'rejected');
    }
    window.requestRejectAccountRequest = requestRejectAccountRequest;



    function downloadMismatchesCSV() {
      if (!reconciliationResultData || !reconciliationResultData.statusChanged || reconciliationResultData.statusChanged.length === 0) {
        showToast('No mismatches to download.', 'error');
        return;
      }
      const headers = ['Client ID', 'Status in File A', 'Status in File B'];
      const rows = [headers];
      reconciliationResultData.statusChanged.forEach(item => {
        rows.push([
          item.clientId || '',
          item.from || '',
          item.to || ''
        ]);
      });
      const csv = rows.map(row => row.map(cell => `"${(cell || '').toString().replace(/"/g,'""')}"`).join(',')).join('\n');
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'reconciliation_mismatches.csv';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    async function viewBatchMismatches(batchDocId) {
      const modal = document.getElementById('mismatchesModal');
      const content = document.getElementById('mismatchesModalContent');
      modal.classList.remove('hidden');
      content.innerHTML = '<div class="text-center text-gray-400">Loading...</div>';
      try {
        const doc = await db.collection('reconciliation_batches').doc(batchDocId).get();
        if (!doc.exists) {
          content.innerHTML = '<div class="text-center text-red-500">Batch not found.</div>';
          return;
        }
        const data = doc.data();
        const mismatches = (data.result && Array.isArray(data.result.statusChanged)) ? data.result.statusChanged : [];
        if (!mismatches.length) {
          content.innerHTML = '<div class="text-center text-green-500">No mismatches found in this batch.</div>';
          return;
        }
        let table = `
          <div class="overflow-x-auto max-h-96 border rounded-lg">
            <table class="w-full border-collapse" id="reconciliationDiffTable">
              <thead class="bg-blue-100">
                <tr>
                  <th class="border border-gray-300 p-2">Client ID</th>
                  <th class="border border-gray-300 p-2">Status in File A</th>
                  <th class="border border-gray-300 p-2">Status in File B</th>
                </tr>
              </thead>
              <tbody>
                ${mismatches.map(item => `
                  <tr class="row-changed">
                    <td class="border border-gray-300 p-2">${item.clientId || ''}</td>
                    <td class="border border-gray-300 p-2">${item.from || ''}</td>
                    <td class="border border-gray-300 p-2">${item.to || ''}</td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </div>
        `;
        content.innerHTML = table;
      } catch (e) {
        content.innerHTML = '<div class="text-center text-red-500">Failed to load mismatches.</div>';
      }
    }
    window.viewBatchMismatches = viewBatchMismatches;

    function closeMismatchesModal() {
      hideModal('mismatchesModal');
    }
    window.closeMismatchesModal = closeMismatchesModal;





    // Download CSV for a submission
    async function downloadUserCsv(docId) {
      try {
        const doc = await db.collection('user_reconciliation_submissions').doc(docId).get();
        if (!doc.exists) return;
        const r = doc.data();
        const csv = r.csv || '';
        const a = document.createElement('a');
        a.href = URL.createObjectURL(new Blob([csv], { type: 'text/csv' }));
        a.download = 'user_reconciliation.csv';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
      } catch (e) {
        showToast('Failed to download CSV.', 'error');
      }
    }
    
    window.downloadUserCsv = downloadUserCsv;



    async function downloadBatchMismatches(batchDocId) {
      // Find the download button and set loading state
      const downloadBtn = document.querySelector(`button[onclick="downloadBatchMismatches('${batchDocId}')"]`);
      if (downloadBtn) {
        setButtonLoadingState(downloadBtn.id || 'downloadBatchMismatchesBtn', true, 'Downloading...', 'Download Mismatches');
      }
      
      try {
        const doc = await db.collection('reconciliation_batches').doc(batchDocId).get();
        if (!doc.exists) {
          showToast('Batch not found.', 'error');
          return;
        }
        const data = doc.data();
        const mismatches = (data.result && Array.isArray(data.result.statusChanged)) ? data.result.statusChanged : [];
        if (!mismatches.length) {
          showToast('No mismatches found in this batch.', 'info');
          return;
        }
        const headers = ['Client ID', 'Status in File A', 'Status in File B'];
        const rows = [headers];
        mismatches.forEach(item => {
          rows.push([
            item.clientId || '',
            item.from || '',
            item.to || ''
          ]);
        });
        const csv = rows.map(row => row.map(cell => `"${(cell || '').toString().replace(/"/g,'""')}"`).join(',')).join('\n');
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'batch_mismatches.csv';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        showToast('Mismatches downloaded successfully!', 'success');
      } catch (e) {
        showToast('Failed to download mismatches.', 'error');
      } finally {
        // Restore loading state
        if (downloadBtn) {
          setButtonLoadingState(downloadBtn.id || 'downloadBatchMismatchesBtn', false, null, 'Download Mismatches');
        }
      }
    }
    window.downloadBatchMismatches = downloadBatchMismatches;

    // Add this helper function near other helpers in the <script> section:
    function renderStatusTag(status) {
      let color = 'bg-gray-500 text-white';
      let label = status || '';
      if (status === 'Active') color = 'bg-green-600 text-white';
      else if (status === 'Dormant') color = 'bg-yellow-400 text-gray-900';
      else if (status === 'Closed') color = 'bg-red-600 text-white';
      return `<span class='inline-block px-3 py-1 rounded-full text-xs font-semibold ${color}'>${label}</span>`;
    }

    // --- Dark Mode Toggle ---
    function applyDarkMode(isDark) {
      const body = document.body;
      const root = document.documentElement;
      const toggleBtn = document.getElementById('darkModeToggle');
      const icon = document.getElementById('darkModeIcon');
      const text = document.getElementById('darkModeText');
      if (isDark) {
        body.classList.add('dark');
        body.classList.remove('light-mode');
        root.style.setProperty('--barclays-bg', '#10151A');
        root.style.setProperty('--barclays-surface', '#1A222B');
              root.style.setProperty('--barclays-text', '#E6F6FB');
      root.style.setProperty('--barclays-muted', '#A8D4E0');
        root.style.setProperty('--barclays-header', '#1A222B');
        root.style.setProperty('--barclays-table-header', '#0077A3');
        root.style.setProperty('--barclays-table-text', '#E6F6FB');
        if (toggleBtn && icon && text) {
          icon.textContent = '☀️';
          text.textContent = 'Light Mode';
        }
      } else {
        body.classList.remove('dark');
        body.classList.add('light-mode');
        root.style.setProperty('--barclays-bg', '#fff');
        root.style.setProperty('--barclays-surface', '#f7fafc');
              root.style.setProperty('--barclays-text', '#0077A3'); // Barclays blue for text
      root.style.setProperty('--barclays-muted', '#475569'); // Enhanced contrast for muted text
        root.style.setProperty('--barclays-header', '#fff');
        root.style.setProperty('--barclays-table-header', '#00AEEF'); // Barclays blue for table header
        root.style.setProperty('--barclays-table-text', '#0077A3');
        if (toggleBtn && icon && text) {
          icon.textContent = '🌙';
          text.textContent = 'Dark Mode';
        }
      }

      // Update header, table, and card backgrounds and text for light mode
      document.querySelectorAll('.barclays-header').forEach(el => {
        el.style.background = isDark ? 'var(--barclays-surface)' : 'var(--barclays-header)';
        el.style.color = isDark ? 'var(--barclays-text)' : 'var(--barclays-text)';
        el.style.borderBottom = isDark ? '1px solid var(--barclays-blue-dark)' : '1px solid var(--barclays-blue)';
      });
      document.querySelectorAll('.tab-content, .rounded-xl.shadow-lg').forEach(el => {
        el.style.background = isDark ? 'var(--barclays-surface)' : 'var(--barclays-surface)';
        el.style.color = isDark ? 'var(--barclays-text)' : 'var(--barclays-text)';
      });
      document.querySelectorAll('th').forEach(el => {
        el.style.background = isDark ? 'var(--barclays-blue-dark)' : 'var(--barclays-table-header)';
        el.style.color = isDark ? '#fff' : 'var(--barclays-table-text)';
        el.style.fontWeight = 'bold';
      });
      document.querySelectorAll('td').forEach(el => {
        el.style.background = isDark ? 'var(--barclays-surface)' : '#fff';
        el.style.color = isDark ? 'var(--barclays-text)' : 'var(--barclays-muted)';
      });
      document.querySelectorAll('.barclays-btn').forEach(el => {
        el.style.background = isDark ? 'var(--barclays-blue)' : 'var(--barclays-blue)';
        el.style.color = '#fff';
        el.style.border = 'none';
      });
      document.querySelectorAll('.barclays-secondary-btn').forEach(el => {
        el.style.background = isDark ? '#232c36' : '#e6f6fb';
        el.style.color = isDark ? '#E6F6FB' : '#0077A3';
        el.style.border = isDark ? '1px solid #2A3A4D' : '1px solid #00AEEF';
      });
      // Inputs
      document.querySelectorAll('input, select, textarea').forEach(el => {
        if (isDark) {
          el.style.background = '#232c36';
          el.style.color = '#E6F6FB';
          el.style.borderColor = '#2A3A4D';
        } else {
          el.style.background = '#fff';
          el.style.color = '#0077A3';
          el.style.borderColor = '#00AEEF';
        }
      });
    }

    function toggleDarkMode() {
      const isDark = !(localStorage.getItem('barclaysDarkMode') === 'false');
      localStorage.setItem('barclaysDarkMode', (!isDark).toString());
      applyDarkMode(!isDark);
    }

    function initDarkMode() {
      let isDark = true;
      if (localStorage.getItem('barclaysDarkMode') !== null) {
        isDark = localStorage.getItem('barclaysDarkMode') === 'true';
      }
      applyDarkMode(isDark);
    }

    window.toggleDarkMode = toggleDarkMode;

    // Initialize dark mode on page load
    document.addEventListener('DOMContentLoaded', initDarkMode);

    // Add these helper functions to the <script> section:
    function scrollToAccountForm() {
      const form = document.getElementById('accountForm');
      if (form) {
        form.scrollIntoView({ behavior: 'smooth', block: 'center' });
        form.querySelector('input,select,textarea')?.focus();
      }
    }
    window.scrollToAccountForm = scrollToAccountForm;
    function scrollToReconciliationUpload() {
      const section = document.getElementById('reconciliation');
      if (section) {
        section.scrollIntoView({ behavior: 'smooth', block: 'start' });
        document.getElementById('csvFileA')?.focus();
      }
    }
    window.scrollToReconciliationUpload = scrollToReconciliationUpload;

    // Modal animation helpers
    function showModal(modalId) {
      const modal = document.getElementById(modalId);
      if (!modal) return;
      modal.classList.remove('hidden');
      const inner = modal.querySelector('div.rounded-xl, div.max-w-lg, div.max-w-xs, div.max-w-md, div.max-w-xl, div.max-w-2xl');
      if (inner) {
        inner.classList.add('modal-animate');
        setTimeout(() => {
          inner.classList.add('modal-animate-in');
        }, 10);
      }
    }
    function hideModal(modalId) {
      const modal = document.getElementById(modalId);
      if (!modal) return;
      const inner = modal.querySelector('div.rounded-xl, div.max-w-lg, div.max-w-xs, div.max-w-md, div.max-w-xl, div.max-w-2xl');
      if (inner) {
        inner.classList.remove('modal-animate-in');
        inner.classList.add('modal-animate-out');
        setTimeout(() => {
          inner.classList.remove('modal-animate', 'modal-animate-out');
          modal.classList.add('hidden');
        }, 400);
      } else {
        modal.classList.add('hidden');
      }
    }

    // --- Dashboard Data Fetching & Rendering ---
    async function loadDashboardData() {
      // Recent Reconciliation Mismatches
      try {
        const recSnap = await db.collection('reconciliation_batches').orderBy('uploadedAt', 'desc').limit(5).get();
        let mismatchCount = 0;
        let mismatchList = '';
        recSnap.forEach(doc => {
          const d = doc.data();
          const mismatches = (d.result && Array.isArray(d.result.statusChanged)) ? d.result.statusChanged.length : 0;
          mismatchCount += mismatches;
          if (mismatches > 0) {
            mismatchList += `<li>${d.batchId || doc.id}: <span class='text-red-400 font-bold'>${mismatches}</span> mismatches</li>`;
          }
        });
        document.getElementById('dashboardRecentMismatchesCount').textContent = mismatchCount;
        document.getElementById('dashboardRecentMismatchesList').innerHTML = mismatchList || '<li class="text-barclays-muted">No recent mismatches</li>';
      } catch (e) {
        document.getElementById('dashboardRecentMismatchesCount').textContent = '-';
        document.getElementById('dashboardRecentMismatchesList').innerHTML = '<li class="text-barclays-muted">Error loading</li>';
      }
      // Account Creation Trends Chart
      try {
        console.log('Loading account creation trends chart...');
        const canvas = document.getElementById('dashboardAccountTrendsChart');
        const placeholderContainer = document.getElementById('accountTrendsPlaceholderContainer');
        const accSnap = await db.collection('accounts').orderBy('createdAt', 'desc').limit(100).get();
        console.log('Accounts fetched:', accSnap.size);
        
        // Group by day for daily trends
        const counts = {};
        const today = new Date();
        const thirtyDaysAgo = new Date(today.getTime() - (30 * 24 * 60 * 60 * 1000)); // Last 30 days
        
        // Initialize all days in the last 30 days with 0
        for (let d = new Date(thirtyDaysAgo); d <= today; d.setDate(d.getDate() + 1)) {
          const key = d.toISOString().split('T')[0]; // YYYY-MM-DD format
          counts[key] = 0;
        }
        
        // Count accounts created on each day
        accSnap.forEach(doc => {
          const d = doc.data();
          let date = d.createdAt && d.createdAt.toDate ? d.createdAt.toDate() : (d.createdAt ? new Date(d.createdAt) : null);
          if (!date) return;
          
          // Only include accounts from the last 30 days
          if (date >= thirtyDaysAgo) {
            const key = date.toISOString().split('T')[0]; // YYYY-MM-DD format
            counts[key] = (counts[key] || 0) + 1;
          }
        });
        
        const labels = Object.keys(counts).sort();
        const data = labels.map(l => counts[l]);
        
        console.log('Chart data prepared:', { labels, data });
        
        // Format labels for better readability (show day and date)
        const formattedLabels = labels.map(label => {
          const date = new Date(label);
          return date.toLocaleDateString('en-US', { 
            month: 'short', 
            day: 'numeric' 
          });
        });
        
        // Check if canvas element exists
        if (!canvas) {
          console.error('Canvas element not found: dashboardAccountTrendsChart');
          return;
        }
        
        // Check if Chart.js is available
        if (typeof Chart === 'undefined') {
          console.error('Chart.js is not loaded');
          return;
        }
        
        // Check if there is any non-zero data
        const hasData = data.some(val => val > 0);
        if (!hasData) {
          // No data: show image, hide chart
          canvas.style.display = 'none';
          if (placeholderContainer) placeholderContainer.style.display = 'flex';
          if (window.dashboardAccountTrendsChart && typeof window.dashboardAccountTrendsChart.destroy === 'function') {
            window.dashboardAccountTrendsChart.destroy();
            window.dashboardAccountTrendsChart = null;
          }
          return;
        } else {
          // Data exists: show chart, hide image
          canvas.style.display = 'block';
          if (placeholderContainer) placeholderContainer.style.display = 'none';
        }
        
        if (window.dashboardAccountTrendsChart && typeof window.dashboardAccountTrendsChart.destroy === 'function') {
          console.log('Destroying existing chart');
          window.dashboardAccountTrendsChart.destroy();
        }
        
        const ctx = canvas.getContext('2d');
        console.log('Creating new chart with data:', { formattedLabels, data });
        
        window.dashboardAccountTrendsChart = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: formattedLabels,
            datasets: [{
              label: 'Accounts Created',
              data,
              backgroundColor: 'rgba(0,174,239,0.7)',
              borderColor: 'rgba(0,119,163,1)',
              borderWidth: 1
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { 
              legend: { display: false },
              tooltip: {
                callbacks: {
                  title: function(context) {
                    const date = new Date(labels[context[0].dataIndex]);
                    return date.toLocaleDateString('en-US', { 
                      weekday: 'long',
                      year: 'numeric', 
                      month: 'long', 
                      day: 'numeric' 
                    });
                  }
                }
              }
            },
            scales: { 
              y: { 
                beginAtZero: true,
                ticks: {
                  stepSize: 1
                }
              },
              x: {
                ticks: {
                  maxRotation: 45,
                  minRotation: 45
                }
              }
            }
          }
        });
        
        console.log('Chart created successfully');
      } catch (e) {
        console.error('Chart error:', e);
      }
    }
    // Load dashboard data when dashboard tab is shown
    const origShowTabDashboard = showTab;
    showTab = function(tab) {
      origShowTabDashboard(tab);
      if (tab === 'dashboard') {
        loadDashboardData();
      }
    }
    window.showTab = showTab;

    // Consolidated Data Tab Logic
    async function loadConsolidatedData() {
      try {
        console.log("Consolidated Data tab shown");
        const consolidatedDataHeaderRow = document.getElementById('consolidatedDataHeaderRow');
        const consolidatedDataBody = document.getElementById('consolidatedDataBody');
        consolidatedDataBody.innerHTML = '<tr><td colspan="100%" class="text-center text-barclays-muted">Loading data...</td></tr>';

        // Listen for real-time updates
        console.log("Listening for unified_data...");
        db.collection('unified_data').orderBy('__name__').onSnapshot(snapshot => {
          console.log("Snapshot received", snapshot.size, snapshot);
          if (snapshot.empty) {
            consolidatedDataBody.innerHTML = '<tr><td colspan="100%" class="text-center text-barclays-muted">No data available.</td></tr>';
            consolidatedDataHeaderRow.innerHTML = '';
            consolidatedTableData = [];
            return;
          }

          console.log("Using fixed headers: ClientID_Forex, Counterparty, id");
          consolidatedDataHeaderRow.innerHTML = '<th class="sortable" onclick="sortConsolidatedTable(\'ClientID_Forex\')" data-sort="ClientID_Forex">ClientID_Forex ↕</th><th class="sortable" onclick="sortConsolidatedTable(\'Counterparty\')" data-sort="Counterparty">Counterparty ↕</th><th class="sortable" onclick="sortConsolidatedTable(\'id\')" data-sort="id">id ↕</th><th>Actions</th>';

          // Store data in consolidatedTableData array in original order
          consolidatedTableData = [];
          snapshot.forEach(doc => {
            const data = doc.data();
            const docId = doc.id;
            console.log("Row data for docId", docId, data);
            consolidatedTableData.push({
              docId: docId,
              ClientID_Forex: data.ClientID_Forex || '',
              Counterparty: data.Counterparty || '',
              id: docId,
              originalIndex: consolidatedTableData.length, // Store original position
              assigned: data.assigned || false // Track assignment status
            });
          });

          // Apply current sort if any
          if (consolidatedCurrentSortColumn) {
            sortConsolidatedData();
          }
          
          // Render the table
          renderConsolidatedTable();
        });
      } catch (error) {
        console.error('Error loading consolidated data:', error);
        const consolidatedDataBody = document.getElementById('consolidatedDataBody');
        consolidatedDataBody.innerHTML = '<tr><td colspan="100%" class="text-center text-red-500">Failed to load data.</td></tr>';
      }
    }
    // Enhanced inline editing for Consolidated Data with one-at-a-time editing and validation
    let currentlyEditingRow = null;

    document.addEventListener('click', function(e) {
      // Edit button clicked
      if (e.target && e.target.classList.contains('edit-consolidated-btn')) {
        // Check if another row is currently being edited
        if (currentlyEditingRow && currentlyEditingRow !== e.target.closest('tr')) {
          showToast('Please finish editing the current row before starting to edit another row.', 'error');
          return;
        }

        const row = e.target.closest('tr');
        const docId = e.target.getAttribute('data-docid');
        currentlyEditingRow = row;
        
        // Get all cells and convert to editable inputs (except id column)
        const cells = row.querySelectorAll('.consolidated-data-cell');
        cells.forEach(cell => {
          const key = cell.getAttribute('data-key');
          const value = cell.textContent;
          const originalValue = cell.getAttribute('data-original');
          
          // Store original value if not already stored
          if (!originalValue) {
            cell.setAttribute('data-original', value);
          }
          
          // Skip making the id column editable since it's the document ID
          if (key === 'id') {
            return;
          }
          
          // Create input with validation to prevent empty values
          cell.innerHTML = `<input type="text" class="w-full p-1 rounded bg-barclays-surface text-barclays-text border border-gray-300" 
                           value="${value}" data-key="${key}" required minlength="1" 
                           placeholder="Cannot be empty" title="This field cannot be empty">`;
        });

        // Hide Edit button, show Save and Cancel buttons
        e.target.classList.add('hidden');
        row.querySelector('.save-consolidated-btn').classList.remove('hidden');
        row.querySelector('.cancel-consolidated-btn').classList.remove('hidden');
        
        // Add visual indication for editing row
        row.classList.add('editing-row');
        
        // Focus on first input
        const firstInput = row.querySelector('input');
        if (firstInput) {
          firstInput.focus();
        }

      // Save button clicked
      } else if (e.target && e.target.classList.contains('save-consolidated-btn')) {
        const row = e.target.closest('tr');
        const docId = e.target.getAttribute('data-docid');
        const inputs = row.querySelectorAll('input[data-key]');
        const updatedData = {};
        let hasEmptyFields = false;
        let changesDetected = false;

        // Validate inputs and collect data
        inputs.forEach(input => {
          const value = input.value.trim();
          const originalValue = input.closest('td').getAttribute('data-original');
          
          // Check for empty fields
          if (!value) {
            hasEmptyFields = true;
            input.classList.add('border-red-500');
          } else {
            input.classList.remove('border-red-500');
          }
          
          // Check if changes were made
          if (value !== originalValue) {
            changesDetected = true;
          }
          
          updatedData[input.getAttribute('data-key')] = value;
        });

        // Prevent saving if there are empty fields
        if (hasEmptyFields) {
          showToast('All fields must be filled. Empty fields are not allowed.', 'error');
          return;
        }

        // Show confirmation dialog only if changes were detected
        if (!changesDetected) {
          showToast('No changes detected.', 'info');
          // Cancel edit mode without saving
          cancelEdit(row);
          return;
        }

        // Show confirmation dialog before saving
        const confirmationMessage = `Are you sure you want to save these changes?\n\nThis will permanently update the data in the database.`;
        if (!confirm(confirmationMessage)) {
          return;
        }

        // Show loading state
        const saveBtn = e.target;
        const originalText = saveBtn.textContent;
        saveBtn.textContent = 'Saving...';
        saveBtn.disabled = true;

        // Update data in Firestore (only ClientID_Forex and Counterparty, not id)
        const dataToUpdate = {};
        if (updatedData.ClientID_Forex !== undefined) {
          dataToUpdate.ClientID_Forex = updatedData.ClientID_Forex;
        }
        if (updatedData.Counterparty !== undefined) {
          dataToUpdate.Counterparty = updatedData.Counterparty;
        }
        
        db.collection('unified_data').doc(docId).update(dataToUpdate)
          .then(() => {
            showToast('Row updated successfully!', 'success');
            
            // Update the original values to reflect the new saved state
            inputs.forEach(input => {
              const cell = input.closest('td');
              cell.setAttribute('data-original', input.value.trim());
              cell.textContent = input.value.trim();
            });
            
            // Reset editing state
            resetEditingState(row);
          })
          .catch(err => {
            showToast('Failed to update row. Please try again.', 'error');
            console.error('Update error:', err);
            
            // Reset button state
            saveBtn.textContent = originalText;
            saveBtn.disabled = false;
          });

      // Cancel button clicked
      } else if (e.target && e.target.classList.contains('cancel-consolidated-btn')) {
        const row = e.target.closest('tr');
        
        // Show confirmation dialog before canceling
        const confirmCancel = confirm('Are you sure you want to cancel editing?\n\nAll unsaved changes will be lost.');
        if (confirmCancel) {
          cancelEdit(row);
        }
      }
    });

    // Helper function to cancel edit mode and restore original values
    function cancelEdit(row) {
      const cells = row.querySelectorAll('.consolidated-data-cell');
      
      // Restore original values
      cells.forEach(cell => {
        const originalValue = cell.getAttribute('data-original');
        cell.textContent = originalValue || '';
      });
      
      resetEditingState(row);
      showToast('Edit cancelled. Original values restored.', 'info');
    }

    // Helper function to reset editing state
    function resetEditingState(row) {
      // Show Edit button, hide Save and Cancel buttons
      row.querySelector('.edit-consolidated-btn').classList.remove('hidden');
      row.querySelector('.save-consolidated-btn').classList.add('hidden');
      row.querySelector('.cancel-consolidated-btn').classList.add('hidden');
      
      // Remove visual editing indication
      row.classList.remove('editing-row');
      
      // Reset button states
      const saveBtn = row.querySelector('.save-consolidated-btn');
      saveBtn.textContent = 'Save';
      saveBtn.disabled = false;
      
      // Clear current editing row
      currentlyEditingRow = null;
    }

    // Add keyboard support for editing
    document.addEventListener('keydown', function(e) {
      if (currentlyEditingRow) {
        // ESC key to cancel editing
        if (e.key === 'Escape') {
          const confirmCancel = confirm('Are you sure you want to cancel editing?\n\nAll unsaved changes will be lost.');
          if (confirmCancel) {
            cancelEdit(currentlyEditingRow);
          }
        }
        // Ctrl+S or Cmd+S to save
        else if ((e.ctrlKey || e.metaKey) && e.key === 's') {
          e.preventDefault();
          const saveBtn = currentlyEditingRow.querySelector('.save-consolidated-btn');
          if (saveBtn && !saveBtn.classList.contains('hidden')) {
            saveBtn.click();
          }
        }
      }
    });

    // Prevent accidental page refresh when editing
    window.addEventListener('beforeunload', function(e) {
      if (currentlyEditingRow) {
        const confirmationMessage = 'You have unsaved changes. Are you sure you want to leave?';
        e.returnValue = confirmationMessage;
        return confirmationMessage;
      }
    });

    // Add event listener for refresh button
    document.addEventListener('DOMContentLoaded', function() {
      const refreshBtn = document.getElementById('refreshConsolidatedDataBtn');
      if (refreshBtn) {
        refreshBtn.addEventListener('click', function() {
          consolidatedDataLoaded = false; // Reset flag to allow fresh loading
          loadConsolidatedData();
          consolidatedDataLoaded = true; // Set flag after loading
        });
      }
    });

    // Unify Data Functionality
    function unifyTablesData() {
      try {
        const unifiedSection = document.getElementById('unifiedDataSection');
        const unifiedHeaderRow = document.getElementById('unifiedDataHeaderRow');
        const unifiedBody = document.getElementById('unifiedDataBody');
        
        // Get data from first table (consolidated data)
        const consolidatedTable = document.getElementById('consolidatedDataTable');
        const consolidatedRows = consolidatedTable.querySelectorAll('tbody tr');
        const consolidatedHeaders = Array.from(consolidatedTable.querySelectorAll('thead th')).map(th => th.textContent.trim()).filter(header => header !== 'Actions');
        
        // Get data from second table (account creation)
        const accountTable = document.getElementById('accountCreationTable');
        const accountRows = accountTable.querySelectorAll('tbody tr');
        const accountHeaders = Array.from(accountTable.querySelectorAll('thead th')).map(th => th.textContent.trim()).filter(header => header !== 'Actions');
        
        // Check if tables have data
        let consolidatedData = [];
        let accountData = [];
        
        // Extract consolidated data
        consolidatedRows.forEach(row => {
          const cells = row.querySelectorAll('td');
          if (cells.length > 1 && !row.textContent.includes('Loading data') && !row.textContent.includes('No data available')) {
            const rowData = {};
            consolidatedHeaders.forEach((header, index) => {
              if (cells[index]) {
                rowData[header] = cells[index].textContent.trim();
              }
            });
            consolidatedData.push(rowData);
          }
        });
        
        // Extract account creation data
        accountRows.forEach(row => {
          const cells = row.querySelectorAll('td');
          if (cells.length > 1 && !row.textContent.includes('Click "Add New Account"')) {
            const rowData = {};
            accountHeaders.forEach((header, index) => {
              if (cells[index]) {
                rowData[header] = cells[index].textContent.trim();
              }
            });
            accountData.push(rowData);
          }
        });
        
        // Check if we have data to unify
        if (consolidatedData.length === 0 && accountData.length === 0) {
          showToast('No data available in either table to unify.', 'info');
          return;
        }
        
        // Create combined headers (consolidate + account headers, avoiding duplicates)
        const allHeaders = [...new Set([...consolidatedHeaders, ...accountHeaders])];
        
        // Generate unified table headers
        unifiedHeaderRow.innerHTML = allHeaders.map(header => `<th>${header}</th>`).join('');
        
        // Determine the maximum number of rows
        const maxRows = Math.max(consolidatedData.length, accountData.length);
        
        // Generate unified data by matching row indexes
        let unifiedRows = '';
        for (let i = 0; i < maxRows; i++) {
          const consolidatedRow = consolidatedData[i] || {};
          const accountRow = accountData[i] || {};
          
          // Merge data from both tables (account data takes precedence for common fields)
          const unifiedRowData = { ...consolidatedRow, ...accountRow };
          
          unifiedRows += `<tr>`;
          allHeaders.forEach(header => {
            const value = unifiedRowData[header] || '';
            unifiedRows += `<td class="unified-data-cell">${value}</td>`;
          });
          unifiedRows += `</tr>`;
        }
        
        // Update the unified table
        unifiedBody.innerHTML = unifiedRows || '<tr><td colspan="100%" class="text-center text-barclays-muted">No unified data to display</td></tr>';
        
        // Show the unified data section
        unifiedSection.classList.remove('hidden');
        
        // Show upload button
        const uploadBtn = document.getElementById('uploadUnifiedDataBtn');
        if (uploadBtn) {
          uploadBtn.classList.remove('hidden');
        }
        
        // Show success message
        const unifiedCount = Math.max(consolidatedData.length, accountData.length);
        showToast(`Successfully unified ${unifiedCount} row${unifiedCount !== 1 ? 's' : ''} from both tables.`, 'success');
        
        // Scroll to unified section
        unifiedSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
        
      } catch (error) {
        console.error('Error unifying table data:', error);
        showToast('Failed to unify table data. Please try again.', 'error');
      }
    }

    // Clear Unified Data
    function clearUnifiedData() {
      const unifiedSection = document.getElementById('unifiedDataSection');
      const unifiedHeaderRow = document.getElementById('unifiedDataHeaderRow');
      const unifiedBody = document.getElementById('unifiedDataBody');
      const uploadBtn = document.getElementById('uploadUnifiedDataBtn');
      
      // Clear the table
      unifiedHeaderRow.innerHTML = '';
      unifiedBody.innerHTML = '<tr><td colspan="100%" class="text-center text-barclays-muted">Click "Unify Data" to combine table data</td></tr>';
      
      // Hide the unified section
      unifiedSection.classList.add('hidden');
      
      // Hide upload button
      if (uploadBtn) {
        uploadBtn.classList.add('hidden');
      }
      
      showToast('Unified data cleared successfully.', 'info');
    }

    // Upload Unified Data to Firebase
    async function uploadUnifiedDataToFirebase() {
      if (!db) {
        showToast('Firebase not initialized. Cannot upload data.', 'error');
        return;
      }
      
      try {
        const uploadBtn = document.getElementById('uploadUnifiedDataBtn');
        const uploadBtnText = document.getElementById('uploadBtnText');
        
        // Set loading state
        if (uploadBtn) {
          uploadBtn.disabled = true;
          uploadBtn.classList.add('opacity-75', 'cursor-not-allowed');
        }
        if (uploadBtnText) {
          uploadBtnText.textContent = 'Uploading...';
        }
        
        // Get unified data from the table
        const unifiedTable = document.getElementById('unifiedDataTable');
        const unifiedRows = unifiedTable.querySelectorAll('tbody tr');
        const unifiedHeaders = Array.from(unifiedTable.querySelectorAll('thead th')).map(th => th.textContent.trim());
        
        let uploadedCount = 0;
        const batch = db.batch();
        
        // Process each row
        for (let i = 0; i < unifiedRows.length; i++) {
          const row = unifiedRows[i];
          const cells = row.querySelectorAll('td');
          
          // Skip empty or placeholder rows
          if (cells.length <= 1 || row.textContent.includes('Click "Unify Data"') || row.textContent.includes('No unified data')) {
            continue;
          }
          
          // Create document data
          const documentData = {};
          unifiedHeaders.forEach((header, index) => {
            if (cells[index] && header) {
              documentData[header] = cells[index].textContent.trim();
            }
          });
          
          // Add metadata
          documentData.uploadedAt = firebase.firestore.FieldValue.serverTimestamp();
          documentData.uploadedBy = currentUser ? currentUser.email : 'anonymous';
          documentData.source = 'unified_data';
          
          // Create a new document reference
          const docRef = db.collection('NWM_Management').doc();
          batch.set(docRef, documentData);
          
          uploadedCount++;
        }
        
        // Check if we have any data to upload
        if (uploadedCount === 0) {
          showToast('No valid data found to upload.', 'info');
          return;
        }
        
        // Commit the batch
        await batch.commit();
        
        // Log audit
        await logAudit('upload_unified_data', {
          collection: 'NWM_Management',
          recordCount: uploadedCount,
          source: 'consolidated_data_unification'
        });
        
        showToast(`Successfully uploaded ${uploadedCount} record${uploadedCount !== 1 ? 's' : ''} to NWM_Management collection.`, 'success');
        
      } catch (error) {
        console.error('Error uploading unified data to Firebase:', error);
        showToast('Failed to upload data to Firebase. Please try again.', 'error');
      } finally {
        // Reset button state
        const uploadBtn = document.getElementById('uploadUnifiedDataBtn');
        const uploadBtnText = document.getElementById('uploadBtnText');
        
        if (uploadBtn) {
          uploadBtn.disabled = false;
          uploadBtn.classList.remove('opacity-75', 'cursor-not-allowed');
        }
        if (uploadBtnText) {
          uploadBtnText.textContent = 'Upload to Firebase';
        }
      }
    }

    // Global variable to track recent uploads
    let recentUploads = [];

    // Combined Save and Upload Function
    async function saveAndUploadData() {
      if (!db) {
        showToast('Firebase not initialized. Cannot upload data.', 'error');
        return;
      }
      
      try {
        const saveUploadBtn = document.getElementById('saveAndUploadBtn');
        const saveUploadBtnText = document.getElementById('saveUploadBtnText');
        const undoUploadBtn = document.getElementById('undoUploadBtn');
        
        // Generate unique batch ID for this upload
        const batchId = 'batch_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        
        // Set loading state
        if (saveUploadBtn) {
          saveUploadBtn.disabled = true;
          saveUploadBtn.classList.add('opacity-75', 'cursor-not-allowed');
        }
        if (saveUploadBtnText) {
          saveUploadBtnText.textContent = 'Unifying data...';
        }
        // Hide undo button during upload
        if (undoUploadBtn) {
          undoUploadBtn.classList.add('hidden');
        }
        
        // Step 1: Process document assignments and prepare data for upload
        // Get data from first table (consolidated data)
        const consolidatedTable = document.getElementById('consolidatedDataTable');
        const consolidatedRows = consolidatedTable.querySelectorAll('tbody tr');
        const consolidatedHeaders = Array.from(consolidatedTable.querySelectorAll('thead th')).map(th => th.textContent.trim()).filter(header => header !== 'Actions');
        
        // Get data from second table (account creation)
        const accountTable = document.getElementById('accountCreationTable');
        const accountRows = accountTable.querySelectorAll('tbody tr');
        const accountHeaders = Array.from(accountTable.querySelectorAll('thead th')).map(th => th.textContent.trim()).filter(header => header !== 'Actions');
        
        // Check if tables have data
        let consolidatedData = [];
        let accountData = [];
        
        // Extract consolidated data
        consolidatedRows.forEach(row => {
          const cells = row.querySelectorAll('td');
          if (cells.length > 1 && !row.textContent.includes('Loading data') && !row.textContent.includes('No data available')) {
            const rowData = {};
            consolidatedHeaders.forEach((header, index) => {
              if (cells[index]) {
                rowData[header] = cells[index].textContent.trim();
              }
            });
            consolidatedData.push(rowData);
          }
        });
        
        // Extract account creation data
        accountRows.forEach(row => {
          const cells = row.querySelectorAll('td');
          if (cells.length > 1 && !row.textContent.includes('Click "Add New Account"')) {
            const rowData = {};
            accountHeaders.forEach((header, index) => {
              if (cells[index]) {
                rowData[header] = cells[index].textContent.trim();
              }
            });
            accountData.push(rowData);
          }
        });
        
        // Check if we have data to process
        if (consolidatedData.length === 0 && accountData.length === 0) {
          showToast('No data available in either table to process.', 'info');
          return;
        }
        
        // Create combined headers (consolidate + account headers, avoiding duplicates)
        const allHeaders = [...new Set([...consolidatedHeaders, ...accountHeaders])];
        
        // Determine the maximum number of rows
        const maxRows = Math.max(consolidatedData.length, accountData.length);
        
        // Generate unified data by matching row indexes (for upload only, not display)
        let unifiedDataArray = [];
        
        for (let i = 0; i < maxRows; i++) {
          const consolidatedRow = consolidatedData[i] || {};
          const accountRow = accountData[i] || {};
          
          // Merge data from both tables (account data takes precedence for common fields)
          const unifiedRowData = { ...consolidatedRow, ...accountRow };
          unifiedDataArray.push(unifiedRowData);
        }
        
        // Update loading text
        if (saveUploadBtnText) {
          saveUploadBtnText.textContent = 'Uploading to Firebase...';
        }
        
        // Step 2: Process document assignments and upload to Firebase
        let uploadedCount = 0;
        const batch = db.batch();
        
        // Process document assignments first
        if (window.pendingDocumentAssignments && Object.keys(window.pendingDocumentAssignments).length > 0) {
          console.log('Processing document assignments:', window.pendingDocumentAssignments);
          
          for (const [accountId, documentId] of Object.entries(window.pendingDocumentAssignments)) {
            try {
              // Update the unified_data document with account assignment
              const docRef = db.collection('unified_data').doc(documentId);
              
              // Get account details from the workflow table
              const accountRow = document.querySelector(`tr[data-account-id="${accountId}"]`);
              let accountName = accountId;
              let accountLei = '';
              
              if (accountRow) {
                const nameInput = accountRow.querySelector('input[value*=""]'); // Get the name input
                const leiInput = accountRow.querySelectorAll('input')[2]; // Get the LEI input (3rd input)
                if (nameInput) accountName = nameInput.value;
                if (leiInput) accountLei = leiInput.value;
              }
              
              const assignmentData = {
                assigned: true,
                assignedAccountName: accountName,
                assignedAccountId: accountId,
                assignedAccountLei: accountLei,
                assignedAt: firebase.firestore.FieldValue.serverTimestamp(),
                assignedBy: currentUser ? currentUser.email : 'anonymous'
              };
              
              batch.update(docRef, assignmentData);
              console.log(`Assigned document ${documentId} to account ${accountId}`);
            } catch (error) {
              console.error(`Error assigning document ${documentId} to account ${accountId}:`, error);
            }
          }
        }
        
        // Process each unified row
        for (let i = 0; i < unifiedDataArray.length; i++) {
          const documentData = unifiedDataArray[i];
          
          // Skip empty data
          if (Object.keys(documentData).length === 0) {
            continue;
          }
          
          // Add metadata
          documentData.uploadedAt = firebase.firestore.FieldValue.serverTimestamp();
          documentData.uploadedBy = currentUser ? currentUser.email : 'anonymous';
          documentData.source = 'unified_data';
          documentData.batchId = batchId; // Add batch ID for undo functionality
          
          // Create a new document reference
          const docRef = db.collection('NWM_Management').doc();
          batch.set(docRef, documentData);
          
          uploadedCount++;
        }
        
        // Check if we have any data to upload
        if (uploadedCount === 0) {
          showToast('No valid data found to upload.', 'info');
          return;
        }
        
        // Commit the batch
        await batch.commit();
        
        // Log audit
        await logAudit('save_and_upload_unified_data', {
          collection: 'NWM_Management',
          recordCount: uploadedCount,
          source: 'consolidated_data_unification',
          batchId: batchId
        });
        
        // Track this upload for undo functionality (keep only last 5 uploads)
        recentUploads.unshift({
          batchId: batchId,
          timestamp: new Date(),
          recordCount: uploadedCount,
          uploadedBy: currentUser ? currentUser.email : 'anonymous'
        });
        if (recentUploads.length > 5) {
          recentUploads = recentUploads.slice(0, 5);
        }
        
        // Show undo button with updated tooltip
        if (undoUploadBtn) {
          undoUploadBtn.classList.remove('hidden');
          undoUploadBtn.title = `Undo last upload (${uploadedCount} records uploaded ${new Date().toLocaleTimeString()})`;
        }
        
        // Clear pending document assignments after successful upload
        if (window.pendingDocumentAssignments) {
          const assignmentCount = Object.keys(window.pendingDocumentAssignments).length;
          window.pendingDocumentAssignments = {};
          console.log(`Cleared ${assignmentCount} pending document assignments`);
        }
        
        // Show success message
        const unifiedCount = Math.max(consolidatedData.length, accountData.length);
        showToast(`Successfully processed ${unifiedCount} row${unifiedCount !== 1 ? 's' : ''} and uploaded ${uploadedCount} record${uploadedCount !== 1 ? 's' : ''} to Firebase.`, 'success');
        
      } catch (error) {
        console.error('Error in save and upload process:', error);
        showToast('Failed to save and upload data. Please try again.', 'error');
      } finally {
        // Reset button state
        const saveUploadBtn = document.getElementById('saveAndUploadBtn');
        const saveUploadBtnText = document.getElementById('saveUploadBtnText');
        
        if (saveUploadBtn) {
          saveUploadBtn.disabled = false;
          saveUploadBtn.classList.remove('opacity-75', 'cursor-not-allowed');
        }
        if (saveUploadBtnText) {
          saveUploadBtnText.textContent = 'Save and Upload';
        }
      }
    }

    // Undo Last Upload Function
    async function undoLastUpload() {
      if (!db) {
        showToast('Firebase not initialized. Cannot undo upload.', 'error');
        return;
      }
      
      if (recentUploads.length === 0) {
        showToast('No recent uploads to undo.', 'info');
        return;
      }
      
      const lastUpload = recentUploads[0];
      
      // Confirm with user
      if (!confirm(`Are you sure you want to undo the last upload? This will delete ${lastUpload.recordCount} record${lastUpload.recordCount !== 1 ? 's' : ''} from Firebase. This action cannot be reversed.`)) {
        return;
      }
      
      try {
        const undoBtn = document.getElementById('undoUploadBtn');
        const undoBtnText = document.getElementById('undoBtnText');
        
        // Set loading state
        if (undoBtn) {
          undoBtn.disabled = true;
          undoBtn.classList.add('opacity-75', 'cursor-not-allowed');
        }
        if (undoBtnText) {
          undoBtnText.textContent = 'Undoing...';
        }
        
        // Query for documents with the batch ID
        const querySnapshot = await db.collection('NWM_Management')
          .where('batchId', '==', lastUpload.batchId)
          .get();
        
        if (querySnapshot.empty) {
          showToast('No documents found to undo. They may have already been deleted.', 'info');
          // Remove from recent uploads since documents don't exist
          recentUploads.shift();
          if (recentUploads.length === 0) {
            undoBtn.classList.add('hidden');
          }
          return;
        }
        
        // Delete documents in batches (Firestore has a 500 operation limit per batch)
        const docIds = [];
        querySnapshot.forEach(doc => {
          docIds.push(doc.id);
        });
        
        let deletedCount = 0;
        const batchSize = 500;
        
        for (let i = 0; i < docIds.length; i += batchSize) {
          const batch = db.batch();
          const currentBatch = docIds.slice(i, i + batchSize);
          
          currentBatch.forEach(docId => {
            const docRef = db.collection('NWM_Management').doc(docId);
            batch.delete(docRef);
          });
          
          await batch.commit();
          deletedCount += currentBatch.length;
        }
        
        // Log audit for undo action
        await logAudit('undo_upload', {
          collection: 'NWM_Management',
          originalBatchId: lastUpload.batchId,
          deletedCount: deletedCount,
          originalUploadTimestamp: lastUpload.timestamp
        });
        
        // Remove from recent uploads
        recentUploads.shift();
        
        // Hide undo button if no more recent uploads
        if (recentUploads.length === 0) {
          undoBtn.classList.add('hidden');
        }
        
        showToast(`Successfully undid last upload. Deleted ${deletedCount} record${deletedCount !== 1 ? 's' : ''} from Firebase.`, 'success');
        
      } catch (error) {
        console.error('Error undoing upload:', error);
        showToast('Failed to undo upload. Please try again or contact support.', 'error');
      } finally {
        // Reset button state
        const undoBtn = document.getElementById('undoUploadBtn');
        const undoBtnText = document.getElementById('undoBtnText');
        
        if (undoBtn) {
          undoBtn.disabled = false;
          undoBtn.classList.remove('opacity-75', 'cursor-not-allowed');
        }
        if (undoBtnText) {
          undoBtnText.textContent = 'Undo Last Upload';
        }
      }
    }
    // Make functions globally available
    window.unifyTablesData = unifyTablesData;
    window.clearUnifiedData = clearUnifiedData;
    window.uploadUnifiedDataToFirebase = uploadUnifiedDataToFirebase;
    window.saveAndUploadData = saveAndUploadData;
    window.undoLastUpload = undoLastUpload;
    // Account Creation Table Functionality
    let accountCreationCounter = 1;
    // Function to find first unassigned document ID from unified_data
    // Always uses the first document from the original data order, regardless of current sort
    async function findFirstUnassignedDocumentId() {
      try {
        // Get documents in their original order (by creation time or document ID)
        const snapshot = await db.collection('unified_data').orderBy('__name__').get();
        if (snapshot.empty) {
          return null;
        }
        
        // Always use the first document from the original order
        const firstDoc = snapshot.docs[0];
        const data = firstDoc.data();
        
        // Check if the first document is already assigned
        if (data.assigned) {
          console.log('First document is already assigned, looking for next unassigned...');
          // If first is assigned, find the next unassigned one
          for (const doc of snapshot.docs) {
            const docData = doc.data();
            if (!docData.assigned) {
              return doc.id;
            }
          }
          return null; // All documents are assigned
        }
        
        return firstDoc.id; // Return the first document ID
      } catch (error) {
        console.error('Error finding unassigned document ID:', error);
        return null;
      }
    }
    
    // Function to get the first document ID from the original data order
    // This ensures account creation always uses the first row regardless of current sort
    function getFirstDocumentIdFromOriginalOrder() {
      if (!consolidatedTableData || consolidatedTableData.length === 0) {
        return null;
      }
      
      // Find the document with the lowest originalIndex (first in original order)
      const firstDoc = consolidatedTableData.reduce((first, current) => {
        return (current.originalIndex < first.originalIndex) ? current : first;
      });
      
      return firstDoc.docId;
    }
    
    // Function to generate dropdown options for document IDs
    function generateDocumentIdOptions() {
      if (!consolidatedTableData || consolidatedTableData.length === 0) {
        return '<option value="" disabled>No documents available</option>';
      }
      
      let options = '';
      consolidatedTableData.forEach(data => {
        const displayText = `${data.docId} (${data.ClientID_Forex || 'No CID'})`;
        const isAssigned = data.assigned ? ' [Assigned]' : '';
        const disabled = data.assigned ? ' disabled' : '';
        options += `<option value="${data.docId}"${disabled}>${displayText}${isAssigned}</option>`;
      });
      
      return options;
    }
    
    // Function to update assigned document ID for an account
    function updateAssignedDocumentId(accountId, documentId) {
      // Store the assignment in a temporary variable until Save and Upload is clicked
      if (!window.pendingDocumentAssignments) {
        window.pendingDocumentAssignments = {};
      }
      
      if (documentId) {
        window.pendingDocumentAssignments[accountId] = documentId;
        console.log(`Document ID ${documentId} assigned to account ${accountId} (pending save)`);
      } else {
        delete window.pendingDocumentAssignments[accountId];
        console.log(`Document assignment removed for account ${accountId}`);
      }
    }

    // Function to assign account data to unified_data document
    async function assignAccountToDocument(docId, accountData) {
      try {
        const accountFields = {
          assigned: true,
          assignedAccountName: accountData.name,
          assignedAccountId: accountData.id,
          assignedAccountLei: accountData.lei,
          assignedAccountStatus: accountData.status,
          assignedAt: firebase.firestore.FieldValue.serverTimestamp()
        };
        
        await db.collection('unified_data').doc(docId).update(accountFields);
        return true;
      } catch (error) {
        console.error('Error assigning account to document:', error);
        return false;
      }
    }

    // Enhanced function to add account to workflow pending table with unified data model
    async function addAccountToWorkflowTable(accountData) {
      const tbody = document.getElementById('accountCreationBody');
      const rowId = `account-row-${accountCreationCounter++}`;

      // Clear the placeholder message if present
      if (tbody.querySelector('td[colspan="6"]')) {
        tbody.innerHTML = '';
      }

      // Don't auto-assign document ID - will be selected via dropdown and saved on upload
      let assignedDocId = null;

      // Determine source styling and information
      const isFromRequest = accountData.source === 'Request Approved';
      const isFromAccountMgmt = !accountData.source || accountData.source === 'Account Management';
      
      const sourceClass = isFromRequest ? 'bg-blue-50 border-l-4 border-blue-500' : 'bg-green-50 border-l-4 border-green-500';
      const sourceIcon = isFromRequest ? '📋' : '➕';
      const sourceText = isFromRequest ? 'Created from Request' : 'Created from Account Management';
      const sourceColor = isFromRequest ? 'text-blue-600' : 'text-green-600';
      const inputBgClass = isFromRequest ? 'bg-blue-50' : 'bg-green-50';

      const row = document.createElement('tr');
      row.id = rowId;
      row.className = sourceClass;
      row.setAttribute('data-account-id', accountData.id);
      row.setAttribute('data-request-id', accountData.requestId || '');
      row.setAttribute('data-assigned-doc-id', assignedDocId || '');
      row.innerHTML = `
        <td class="account-creation-cell">
          <input type="text" class="w-full border border-gray-300 p-2 rounded ${inputBgClass}" value="${accountData.name}" readonly />
          <div class="text-xs ${sourceColor} mt-1 flex items-center gap-1">
            <span>${sourceIcon}</span>
            <span>✓ ${sourceText}</span>
            ${accountData.requestId ? `<button onclick="showAccountRequestConnection('${accountData.requestId}')" class="text-xs underline hover:no-underline" title="View original request">View Request</button>` : ''}
          </div>
        </td>
        <td class="account-creation-cell">
          <div class="flex items-center gap-2">
            <input type="text" class="w-full border border-gray-300 p-2 rounded ${inputBgClass}" value="${accountData.id}" readonly />
            <span class="text-xs ${sourceColor}">✓</span>
          </div>
          ${accountData.requestId ? `<div class="text-xs text-gray-500 mt-1">Linked to request: ${accountData.requestId.substring(0, 8)}...</div>` : ''}
        </td>
        <td class="account-creation-cell">
          <input type="text" class="w-full border border-gray-300 p-2 rounded ${inputBgClass}" value="${accountData.lei}" readonly />
          <div class="text-xs ${sourceColor} mt-1">✓ Validated</div>
        </td>
        <td class="account-creation-cell">
          <select class="w-full border border-gray-300 p-2 rounded ${inputBgClass}" onchange="updateAccountWorkflowStatus('${accountData.id}', this.value)">
            <option value="${accountData.status}" selected>${accountData.status}</option>
            <option value="Active">Active</option>
            <option value="Pending">Pending</option>
            <option value="Processing">Processing</option>
            <option value="Processed">Processed</option>
            <option value="Inactive">Inactive</option>
            <option value="Closed">Closed</option>
          </select>
          <div class="text-xs text-gray-500 mt-1" id="lifecycle-${accountData.id}">Lifecycle: In Workflow</div>
        </td>
        <td class="account-creation-cell">
          <div class="flex items-center gap-2">
            <select class="w-full border border-gray-300 p-2 rounded ${inputBgClass}" data-account-id="${accountData.id}" onchange="updateAssignedDocumentId('${accountData.id}', this.value)">
              <option value="">Select Document ID</option>
              ${generateDocumentIdOptions()}
            </select>
            <span class="text-xs text-blue-600">📋</span>
          </div>
          <div class="text-xs text-gray-500 mt-1">Select document ID to assign</div>
        </td>
        <td class="flex gap-2 p-2">
          <button type="button" class="barclays-btn px-3 py-1 rounded text-sm opacity-50" disabled title="Account already created">
            ✓ Created
          </button>
          <button type="button" onclick="viewAccountTimeline('${accountData.id}')" class="barclays-secondary-btn px-3 py-1 rounded text-sm" title="View account timeline">
            Timeline
          </button>
          <button type="button" class="remove-account-btn bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded text-sm">Remove</button>
        </td>
      `;

      tbody.appendChild(row);
      
      // Update counter
      const counter = document.getElementById('accountManagementCounter');
      const countSpan = document.getElementById('accountManagementCount');
      if (counter && countSpan) {
        const currentCount = parseInt(countSpan.textContent) + 1;
        countSpan.textContent = currentCount;
        counter.classList.remove('hidden');
      }
      
      // Add animation effect
      row.style.opacity = '0';
      row.style.transform = 'translateY(-10px)';
      setTimeout(() => {
        row.style.transition = 'all 0.3s ease';
        row.style.opacity = '1';
        row.style.transform = 'translateY(0)';
      }, 100);
      
      return row;
    }



    async function removeAccountRow(row) {
      const tbody = document.getElementById('accountCreationBody');
      const assignedDocId = row.getAttribute('data-assigned-doc-id');
      
      // Unassign the document if it was assigned
      if (assignedDocId && assignedDocId !== '') {
        try {
          await db.collection('unified_data').doc(assignedDocId).update({
            assigned: false,
            assignedAccountName: firebase.firestore.FieldValue.delete(),
            assignedAccountId: firebase.firestore.FieldValue.delete(),
            assignedAccountLei: firebase.firestore.FieldValue.delete(),
            assignedAccountStatus: firebase.firestore.FieldValue.delete(),
            assignedAt: firebase.firestore.FieldValue.delete()
          });
          console.log('Document unassigned successfully:', assignedDocId);
        } catch (error) {
          console.error('Error unassigning document:', error);
        }
      }
      
      row.remove();
      
      // Add placeholder message if no rows left
      if (tbody.children.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="text-center text-barclays-muted">Accounts created in Account Management will appear here automatically</td></tr>';
      }
    }



    // Event delegation for account creation table
    document.addEventListener('click', function(e) {


      // Remove Account button
      if (e.target && e.target.classList.contains('remove-account-btn')) {
        if (confirm('Are you sure you want to remove this account entry?')) {
          const row = e.target.closest('tr');
          // Check if this was from account management (has the green styling)
          const isFromAccountMgmt = row.classList.contains('bg-green-50');
          
          // Handle async removal
          removeAccountRow(row).then(() => {
            // Update counter if it was from account management
            if (isFromAccountMgmt) {
              const counter = document.getElementById('accountManagementCounter');
              const countSpan = document.getElementById('accountManagementCount');
              if (counter && countSpan) {
                const currentCount = Math.max(0, parseInt(countSpan.textContent) - 1);
                countSpan.textContent = currentCount;
                if (currentCount === 0) {
                  counter.classList.add('hidden');
                }
              }
            }
          }).catch(error => {
            console.error('Error removing account row:', error);
            showToast('Error removing account. Please try again.', 'error');
          });
        }
      }
    });

    // Enhanced Functions for Unified Data Model and Cross-References
    
    // Update account workflow status with status history tracking
    async function updateAccountWorkflowStatus(accountId, newStatus) {
      try {
        const accountRef = db.collection('accounts').doc(accountId);
        const accountDoc = await accountRef.get();
        
        if (!accountDoc.exists) {
          showToast('Account not found', 'error');
          return;
        }
        
        const accountData = accountDoc.data();
        const statusUpdate = {
          status: newStatus,
          workflowStatus: newStatus,
          lastModified: firebase.firestore.FieldValue.serverTimestamp()
        };
        
        // Add to status history
        const newHistoryEntry = {
          status: newStatus,
          timestamp: new Date(), // Use new Date() instead of serverTimestamp for arrayUnion
          triggeredBy: currentUser ? currentUser.uid : 'admin',
          source: 'Workflow',
          notes: `Status updated to ${newStatus} in workflow`
        };
        
        // Update lifecycle status based on workflow status
        if (newStatus === 'Processed') {
          statusUpdate.lifecycleStatus = 'Processed';
          statusUpdate.processedAt = firebase.firestore.FieldValue.serverTimestamp();
          statusUpdate.processedBy = currentUser ? currentUser.uid : 'admin';
        } else if (newStatus === 'Active') {
          statusUpdate.lifecycleStatus = 'Active';
        } else if (newStatus === 'Closed') {
          statusUpdate.lifecycleStatus = 'Closed';
          statusUpdate.closedAt = firebase.firestore.FieldValue.serverTimestamp();
        }
        
        // Update account with new status and history
        await accountRef.update({
          ...statusUpdate,
          statusHistory: firebase.firestore.FieldValue.arrayUnion(newHistoryEntry)
        });
        
        // Update linked request if exists with enhanced status tracking
        if (accountData.requestId) {
          const requestUpdate = {
            linkedAccountStatus: newStatus,
            lastStatusUpdate: firebase.firestore.FieldValue.serverTimestamp()
          };
          
          // If account is processed, mark the entire flow as fully completed
          if (newStatus === 'Processed') {
            requestUpdate.flowStatus = 'Fully Processed - Complete Lifecycle';
            requestUpdate.fullyCompletedAt = firebase.firestore.FieldValue.serverTimestamp();
            requestUpdate.lifecycleStatus = 'Fully Completed';
          } else if (newStatus === 'Active') {
            requestUpdate.flowStatus = 'Account Active';
            requestUpdate.lifecycleStatus = 'Active';
          } else if (newStatus === 'Closed') {
            requestUpdate.flowStatus = 'Account Closed';
            requestUpdate.lifecycleStatus = 'Closed';
          }
          
          await db.collection('account_requests').doc(accountData.requestId).update(requestUpdate);
        }
        
        showToast(`Account ${accountId} status updated to ${newStatus}`, 'success');
        
        // Update UI visual indicators
        const workflowRow = document.querySelector(`tr[data-account-id="${accountId}"]`);
        if (workflowRow) {
          const lifecycleDiv = document.getElementById(`lifecycle-${accountId}`);
          if (lifecycleDiv) {
            lifecycleDiv.textContent = `Lifecycle: ${statusUpdate.lifecycleStatus || newStatus}`;
            
            // Add special styling for processed accounts
            if (newStatus === 'Processed') {
              lifecycleDiv.className = 'text-xs text-yellow-600 mt-1 font-medium';
              lifecycleDiv.innerHTML = `<span class="flex items-center gap-1"><span>🎯</span><span>Lifecycle: Processed</span></span>`;
              
              // Add a completion notification
              setTimeout(() => {
                const completionNotification = document.createElement('div');
                completionNotification.className = 'fixed bottom-4 right-4 p-4 rounded-lg shadow-lg z-50 border-l-4 border-yellow-500';
                completionNotification.style.background = 'var(--barclays-surface)';
                completionNotification.style.color = 'var(--barclays-text)';
                completionNotification.innerHTML = `
                  <div class="flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="barclays-icon text-yellow-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    <span class="text-sm font-medium">🎯 Account ${accountId} fully processed!</span>
                    <button onclick="this.parentElement.parentElement.remove();" class="text-gray-400 hover:text-gray-600 ml-2">×</button>
                  </div>
                `;
                document.body.appendChild(completionNotification);
                
                // Auto-remove after 5 seconds
                setTimeout(() => {
                  if (completionNotification.parentElement) {
                    completionNotification.remove();
                  }
                }, 5000);
              }, 500);
            }
          }
        }
        
      } catch (error) {
        console.error('Error updating workflow status:', error);
        showToast('Error updating status: ' + error.message, 'error');
      }
    }
    window.updateAccountWorkflowStatus = updateAccountWorkflowStatus;
    
    // View account timeline and status history
    async function viewAccountTimeline(accountId) {
      try {
        const accountDoc = await db.collection('accounts').doc(accountId).get();
        if (!accountDoc.exists) {
          showToast('Account not found', 'error');
          return;
        }
        
        const accountData = accountDoc.data();
        const statusHistory = accountData.statusHistory || [];
        
        // Create timeline modal
        let timelineHtml = `
          <div class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-60">
            <div class="rounded-xl shadow-lg p-6 w-full max-w-2xl relative overflow-y-auto max-h-90vh" style="background: var(--barclays-surface); color: var(--barclays-text);">
              <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold">Account Timeline: ${accountId}</h2>
                <button onclick="this.parentElement.parentElement.parentElement.remove()" class="text-gray-400 hover:text-gray-600 text-xl">×</button>
              </div>
              
              <div class="mb-4 p-3 rounded-lg" style="background: var(--barclays-bg);">
                <div class="grid grid-cols-2 gap-4 text-sm">
                  <div><strong>Current Status:</strong> ${accountData.status}</div>
                  <div><strong>Lifecycle Status:</strong> ${accountData.lifecycleStatus || 'N/A'}</div>
                  <div><strong>Workflow Status:</strong> ${accountData.workflowStatus || 'N/A'}</div>
                  <div><strong>Linked Request:</strong> ${accountData.requestId ? `<button onclick="showAccountRequestConnection('${accountData.requestId}')" class="text-blue-400 underline">${accountData.requestId.substring(0, 8)}...</button>` : 'None'}</div>
                </div>
              </div>
              
              <div class="space-y-3">
                <h3 class="text-lg font-medium mb-2">Status History</h3>
        `;
        
        statusHistory.reverse().forEach((entry, index) => {
          const isRecent = index < 2;
          timelineHtml += `
            <div class="flex items-start gap-3 p-3 rounded-lg ${isRecent ? 'bg-blue-50 border-l-4 border-blue-500' : 'bg-gray-50'}">
              <div class="w-8 h-8 rounded-full flex items-center justify-center text-xs font-bold ${isRecent ? 'bg-blue-500 text-white' : 'bg-gray-400 text-white'}">
                ${index + 1}
              </div>
              <div class="flex-1">
                <div class="font-medium text-sm">${entry.status}</div>
                <div class="text-xs text-gray-600 mt-1">${entry.source} • ${entry.notes}</div>
                <div class="text-xs text-gray-500 mt-1">
                  ${entry.timestamp ? (entry.timestamp.toDate ? entry.timestamp.toDate().toLocaleString() : new Date(entry.timestamp).toLocaleString()) : 'Processing...'}
                  ${entry.triggeredBy ? `• by ${entry.triggeredBy}` : ''}
                </div>
              </div>
            </div>
          `;
        });
        
        timelineHtml += `
              </div>
            </div>
          </div>
        `;
        
        document.body.insertAdjacentHTML('beforeend', timelineHtml);
        
      } catch (error) {
        console.error('Error viewing timeline:', error);
        showToast('Error loading timeline: ' + error.message, 'error');
      }
    }
    window.viewAccountTimeline = viewAccountTimeline;
    
    // Show account request connection
    async function showAccountRequestConnection(requestId) {
      try {
        // Switch to account requests tab and highlight the specific request
        showTab('accountrequest');
        
        // Wait for tab to load, then highlight the request
        setTimeout(async () => {
          await loadAccountRequests();
          
          // Find and highlight the request row
          const requestRows = document.querySelectorAll('#arRequestsTableBody tr');
          requestRows.forEach(row => {
            const cells = row.querySelectorAll('td');
            if (cells.length > 0) {
              // Check if this row contains our request ID (you may need to adjust this based on your table structure)
              const rowData = row.textContent;
              if (rowData.includes(requestId.substring(0, 8))) {
                row.style.background = 'var(--barclays-blue)';
                row.style.color = 'white';
                row.scrollIntoView({ behavior: 'smooth', block: 'center' });
                
                // Reset highlight after 3 seconds
                setTimeout(() => {
                  row.style.background = '';
                  row.style.color = '';
                }, 3000);
              }
            }
          });
        }, 500);
        
      } catch (error) {
        console.error('Error showing request connection:', error);
        showToast('Error loading request connection', 'error');
      }
         }
     window.showAccountRequestConnection = showAccountRequestConnection;
     
     // Show linked account from request
     async function showLinkedAccount(accountId) {
       try {
         // Switch to account management tab and highlight the specific account
         showTab('account');
         
         // Wait for tab to load, then try to show the account
         setTimeout(async () => {
           // Try to find the account in the accounts list if it's visible
           const accountsSection = document.getElementById('accountsSection');
           if (accountsSection && !accountsSection.classList.contains('hidden')) {
             await refreshAccounts();
             
             // Find and highlight the account row
             setTimeout(() => {
               const accountRows = document.querySelectorAll('#accountListBody tr');
               accountRows.forEach(row => {
                 const cells = row.querySelectorAll('td');
                 if (cells.length > 0) {
                   // Check if this row contains our account ID
                   const rowData = row.textContent;
                   if (rowData.includes(accountId)) {
                     row.style.background = 'var(--barclays-blue)';
                     row.style.color = 'white';
                     row.scrollIntoView({ behavior: 'smooth', block: 'center' });
                     
                     // Reset highlight after 3 seconds
                     setTimeout(() => {
                       row.style.background = '';
                       row.style.color = '';
                     }, 3000);
                   }
                 }
               });
             }, 500);
           } else {
             // Show a notification that the account was created
             showToast(`Account ${accountId} was created. View it in Account Management or Workflow tabs.`, 'info');
           }
         }, 500);
         
       } catch (error) {
         console.error('Error showing linked account:', error);
         showToast('Error loading linked account', 'error');
       }
     }
     window.showLinkedAccount = showLinkedAccount;
     
     // View request timeline
     async function viewRequestTimeline(requestId) {
       try {
         const requestDoc = await db.collection('account_requests').doc(requestId).get();
         if (!requestDoc.exists) {
           showToast('Request not found', 'error');
           return;
         }
         
         const requestData = requestDoc.data();
         
         // Create timeline modal for request
         let timelineHtml = `
           <div class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-60">
             <div class="rounded-xl shadow-lg p-6 w-full max-w-2xl relative overflow-y-auto max-h-90vh" style="background: var(--barclays-surface); color: var(--barclays-text);">
               <div class="flex justify-between items-center mb-4">
                 <h2 class="text-xl font-semibold">Request Timeline: ${requestId.substring(0, 8)}...</h2>
                 <button onclick="this.parentElement.parentElement.parentElement.remove()" class="text-gray-400 hover:text-gray-600 text-xl">×</button>
               </div>
               
               <div class="mb-4 p-3 rounded-lg" style="background: var(--barclays-bg);">
                 <div class="grid grid-cols-2 gap-4 text-sm">
                   <div><strong>Type:</strong> ${requestData.type}</div>
                   <div><strong>Status:</strong> ${requestData.status}</div>
                   <div><strong>Team:</strong> ${requestData.team || 'N/A'}</div>
                   <div><strong>Email:</strong> ${requestData.email}</div>
                   <div><strong>Linked Account:</strong> ${requestData.linkedAccountId ? `<button onclick="showLinkedAccount('${requestData.linkedAccountId}')" class="text-blue-400 underline">${requestData.linkedAccountId}</button>` : 'None'}</div>
                   <div><strong>Lifecycle Status:</strong> ${requestData.lifecycleStatus || 'N/A'}</div>
                 </div>
               </div>
               
               <div class="space-y-3">
                 <h3 class="text-lg font-medium mb-2">Request Journey</h3>
                 
                 <div class="flex items-start gap-3 p-3 rounded-lg bg-blue-50 border-l-4 border-blue-500">
                   <div class="w-8 h-8 rounded-full flex items-center justify-center text-xs font-bold bg-blue-500 text-white">1</div>
                   <div class="flex-1">
                     <div class="font-medium text-sm">Request Submitted</div>
                     <div class="text-xs text-gray-600 mt-1">Account Request Portal • Request created</div>
                     <div class="text-xs text-gray-500 mt-1">
                       ${requestData.submittedAt ? (requestData.submittedAt.toDate ? requestData.submittedAt.toDate().toLocaleString() : new Date(requestData.submittedAt).toLocaleString()) : 'Unknown'}
                     </div>
                   </div>
                 </div>
         `;
         
         // Add processing step if processed
         if (requestData.processedAt) {
           timelineHtml += `
             <div class="flex items-start gap-3 p-3 rounded-lg bg-green-50 border-l-4 border-green-500">
               <div class="w-8 h-8 rounded-full flex items-center justify-center text-xs font-bold bg-green-500 text-white">2</div>
               <div class="flex-1">
                 <div class="font-medium text-sm">Request ${requestData.status}</div>
                 <div class="text-xs text-gray-600 mt-1">Account Request Portal • Request processed by admin</div>
                 <div class="text-xs text-gray-500 mt-1">
                   ${requestData.processedAt.toDate ? requestData.processedAt.toDate().toLocaleString() : new Date(requestData.processedAt).toLocaleString()}
                   ${requestData.processedBy ? `• by ${requestData.processedBy}` : ''}
                 </div>
               </div>
             </div>
           `;
         }
         
                   // Add account creation step if account was created
          if (requestData.linkedAccountId) {
            timelineHtml += `
              <div class="flex items-start gap-3 p-3 rounded-lg bg-purple-50 border-l-4 border-purple-500">
                <div class="w-8 h-8 rounded-full flex items-center justify-center text-xs font-bold bg-purple-500 text-white">3</div>
                <div class="flex-1">
                  <div class="font-medium text-sm">Account Created</div>
                  <div class="text-xs text-gray-600 mt-1">Account Management • Account ${requestData.linkedAccountId} created</div>
                  <div class="text-xs text-gray-500 mt-1">
                    <button onclick="showLinkedAccount('${requestData.linkedAccountId}')" class="text-blue-400 underline">View Account</button>
                  </div>
                </div>
              </div>
            `;
          }
          
          // Add completion step if request was completed
          if (requestData.lifecycleStatus === 'Completed') {
            timelineHtml += `
              <div class="flex items-start gap-3 p-3 rounded-lg bg-blue-50 border-l-4 border-blue-500">
                <div class="w-8 h-8 rounded-full flex items-center justify-center text-xs font-bold bg-blue-500 text-white">4</div>
                <div class="flex-1">
                  <div class="font-medium text-sm">Request Completed</div>
                  <div class="text-xs text-gray-600 mt-1">System • Request marked as completed - account created successfully</div>
                  <div class="text-xs text-gray-500 mt-1">
                    ${requestData.completedAt ? (requestData.completedAt.toDate ? requestData.completedAt.toDate().toLocaleString() : new Date(requestData.completedAt).toLocaleString()) : 'Recently'}
                  </div>
                </div>
              </div>
            `;
          }
          
          // Add fully completed step if request was fully processed
          if (requestData.lifecycleStatus === 'Fully Completed') {
            timelineHtml += `
              <div class="flex items-start gap-3 p-3 rounded-lg bg-yellow-50 border-l-4 border-yellow-500">
                <div class="w-8 h-8 rounded-full flex items-center justify-center text-xs font-bold bg-yellow-500 text-white">🎯</div>
                <div class="flex-1">
                  <div class="font-medium text-sm">Fully Processed</div>
                  <div class="text-xs text-gray-600 mt-1">Workflow • Complete lifecycle - account processed and active</div>
                  <div class="text-xs text-gray-500 mt-1">
                    ${requestData.fullyCompletedAt ? (requestData.fullyCompletedAt.toDate ? requestData.fullyCompletedAt.toDate().toLocaleString() : new Date(requestData.fullyCompletedAt).toLocaleString()) : 'Recently'}
                    <br><strong>Status:</strong> ${requestData.flowStatus || 'Fully Processed'}
                  </div>
                </div>
              </div>
            `;
          }
         
         timelineHtml += `
               </div>
             </div>
           </div>
         `;
         
         document.body.insertAdjacentHTML('beforeend', timelineHtml);
         
       } catch (error) {
         console.error('Error viewing request timeline:', error);
         showToast('Error loading request timeline: ' + error.message, 'error');
       }
           }
      window.viewRequestTimeline = viewRequestTimeline;
      
      // Enhanced dashboard function to show interconnection statistics
      async function refreshInterconnectionStats() {
        try {
          // Get accounts data
          const accountsSnapshot = await db.collection('accounts').get();
          const requestsSnapshot = await db.collection('account_requests').get();
          
          let requestsToAccountsCount = 0;
          let accountsInWorkflowCount = 0;
          let directCreatedCount = 0;
          let processedAccountsCount = 0;
          
          let statusFlowCounts = {
            submitted: 0,
            approved: 0,
            created: 0,
            inWorkflow: 0,
            processed: 0,
            fullyCompleted: 0
          };
          
          // Process accounts data
          accountsSnapshot.forEach(doc => {
            const account = doc.data();
            
            // Count accounts created from requests
            if (account.requestId) {
              requestsToAccountsCount++;
            } else {
              directCreatedCount++;
            }
            
            // Count accounts by workflow status
            if (account.workflowStatus === 'In Workflow' || account.workflowStatus === 'Processing') {
              accountsInWorkflowCount++;
              statusFlowCounts.inWorkflow++;
            } else if (account.workflowStatus === 'Processed' || account.lifecycleStatus === 'Processed') {
              processedAccountsCount++;
              statusFlowCounts.processed++;
            }
            
            // Count by lifecycle status
            if (account.lifecycleStatus === 'Account Created') {
              statusFlowCounts.created++;
            }
          });
          
          // Process requests data with enhanced completion tracking
          requestsSnapshot.forEach(doc => {
            const request = doc.data();
            
            statusFlowCounts.submitted++;
            
            if (request.status === 'approved') {
              statusFlowCounts.approved++;
            }
            
            // Count completed and fully completed requests
            if (request.lifecycleStatus === 'Completed') {
              // Request was approved and account created
            }
            
            if (request.lifecycleStatus === 'Fully Completed') {
              statusFlowCounts.fullyCompleted++;
            }
          });
          
          // Update dashboard counters
          document.getElementById('dashboardRequestsToAccountsCount').textContent = requestsToAccountsCount;
          document.getElementById('dashboardAccountsInWorkflowCount').textContent = accountsInWorkflowCount;
          document.getElementById('dashboardDirectCreatedCount').textContent = directCreatedCount;
          document.getElementById('dashboardProcessedAccountsCount').textContent = processedAccountsCount;
          
          // Update the processed accounts counter to show fully completed
          document.getElementById('dashboardProcessedAccountsCount').textContent = statusFlowCounts.fullyCompleted;
          
          showToast('Interconnection statistics updated!', 'success');
          
        } catch (error) {
          console.error('Error refreshing interconnection stats:', error);
          showToast('Error updating statistics: ' + error.message, 'error');
        }
      }
      window.refreshInterconnectionStats = refreshInterconnectionStats;
      
      // Auto-refresh stats when dashboard is shown
      const originalShowTab = window.showTab;
      window.showTab = function(tab) {
        originalShowTab(tab);
        if (tab === 'dashboard') {
          setTimeout(() => {
            refreshInterconnectionStats();
          }, 500);
        }
      };

    

  })();
  </script>

  <div id="mismatchesModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-60 hidden">
    <div class="rounded-xl shadow-lg p-8 w-full max-w-2xl relative overflow-y-auto" style="background: var(--barclays-surface); max-height: 90vh; color: var(--barclays-text);">
      <button onclick="closeMismatchesModal()" class="absolute top-2 right-2 text-gray-400 hover:text-gray-700">✖️</button>
      <h2 class="text-2xl font-semibold mb-4 text-header">Batch Mismatches</h2>
      <div id="mismatchesModalContent">
        <div class="text-center text-gray-400">Loading...</div>
      </div>
    </div>
  </div>

</body>
</html>